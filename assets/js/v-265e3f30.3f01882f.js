"use strict";(self.webpackChunkmd_vuepress=self.webpackChunkmd_vuepress||[]).push([[5858],{2755:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-265e3f30",path:"/mark/09-Promise%E5%8E%9F%E7%90%86.html",title:"JS 为什么会设计 Promise & 如何手写实现一个 Promise",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"笔试题（6 题）",slug:"笔试题-6-题",children:[{level:3,title:"1. 为什么需要 Promise",slug:"_1-为什么需要-promise",children:[]},{level:3,title:"2. Promise 状态机",slug:"_2-promise-状态机",children:[]},{level:3,title:"3. Promise A+ 规范核心",slug:"_3-promise-a-规范核心",children:[]},{level:3,title:"4. Promise 静态方法",slug:"_4-promise-静态方法",children:[]},{level:3,title:"5. 手写 Promise 核心逻辑",slug:"_5-手写-promise-核心逻辑",children:[]},{level:3,title:"6. async/await 与 Promise",slug:"_6-async-await-与-promise",children:[]}]},{level:2,title:"面试题（4 题）",slug:"面试题-4-题",children:[{level:3,title:"1. 手写 Promise.all",slug:"_1-手写-promise-all",children:[]},{level:3,title:"2. Promise 链式调用原理",slug:"_2-promise-链式调用原理",children:[]},{level:3,title:"3. Promise 实践问题",slug:"_3-promise-实践问题",children:[]},{level:3,title:"4. Promise vs Callback vs async/await",slug:"_4-promise-vs-callback-vs-async-await",children:[]}]}],git:{updatedTime:1770272219e3},filePathRelative:"mark/09-Promise原理.md"}},1905:(n,s,a)=>{a.r(s),a.d(s,{default:()=>l});const e=(0,a(6252).uE)('<h1 id="js-为什么会设计-promise-如何手写实现一个-promise" tabindex="-1"><a class="header-anchor" href="#js-为什么会设计-promise-如何手写实现一个-promise" aria-hidden="true">#</a> JS 为什么会设计 Promise &amp; 如何手写实现一个 Promise</h1><h2 id="笔试题-6-题" tabindex="-1"><a class="header-anchor" href="#笔试题-6-题" aria-hidden="true">#</a> 笔试题（6 题）</h2><h3 id="_1-为什么需要-promise" tabindex="-1"><a class="header-anchor" href="#_1-为什么需要-promise" aria-hidden="true">#</a> 1. 为什么需要 Promise</h3><p>JS 为什么会设计 Promise？它解决了什么问题（回调地狱、错误处理、组合异步）？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>解决的问题:\n1. 回调地狱（Callback Hell）：多层嵌套回调导致代码难以阅读和维护\n2. 错误处理困难：回调函数中错误处理分散，难以统一捕获\n3. 异步流程控制：难以按顺序执行多个异步操作，难以并行处理\n4. 信任问题：回调可能被多次调用或不被调用，缺乏状态管理\n\n回调地狱示例及 Promise 改进:\n\n// 回调地狱\ngetData(function(a) {\n  getMoreData(a, function(b) {\n    getMoreData(b, function(c) {\n      getMoreData(c, function(d) {\n        // 嵌套过深，难以维护\n      });\n    });\n  });\n});\n\n// Promise 改进\ngetData()\n  .then(a =&gt; getMoreData(a))\n  .then(b =&gt; getMoreData(b))\n  .then(c =&gt; getMoreData(c))\n  .then(d =&gt; {\n    // 链式调用，清晰易读\n  })\n  .catch(error =&gt; {\n    // 统一错误处理\n  });\n\n错误处理优势:\n\n// 回调方式：错误处理分散\nfunction fetchData(callback) {\n  asyncOperation((err, data) =&gt; {\n    if (err) {\n      // 每个回调都要处理错误\n      callback(err);\n      return;\n    }\n    callback(null, data);\n  });\n}\n\n// Promise 方式：统一错误处理\nfetchData()\n  .then(data =&gt; {\n    // 处理数据\n  })\n  .catch(error =&gt; {\n    // 统一捕获所有错误\n  });\n\n异步组合能力:\n\n// 串行执行\npromise1()\n  .then(result1 =&gt; promise2(result1))\n  .then(result2 =&gt; promise3(result2));\n\n// 并行执行\nPromise.all([promise1(), promise2(), promise3()])\n  .then(([r1, r2, r3]) =&gt; {\n    // 所有结果都返回后处理\n  });\n\n// 竞态执行\nPromise.race([promise1(), promise2()])\n  .then(firstResult =&gt; {\n    // 第一个完成的结果\n  });\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><hr><h3 id="_2-promise-状态机" tabindex="-1"><a class="header-anchor" href="#_2-promise-状态机" aria-hidden="true">#</a> 2. Promise 状态机</h3><p>Promise 的三种状态是什么？状态转换规则？为什么状态不可逆？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>三种状态:\n1. pending（等待中）：初始状态，既不是成功也不是失败\n2. fulfilled（已成功）：操作成功完成\n3. rejected（已失败）：操作失败\n\n状态转换规则:\n- 只能从 pending → fulfilled 或 pending → rejected\n- 状态一旦改变，就不能再变回 pending\n- fulfilled 和 rejected 之间不能相互转换\n- 状态转换是单向的、不可逆的\n\n为什么不可逆:\n1. 保证一致性：一旦 Promise 有了确定的结果（成功或失败），这个结果就是最终的，不会改变\n2. 避免竞态条件：如果状态可以逆转，可能导致多个 then 回调看到不同的状态\n3. 简化逻辑：不可逆性使得 Promise 的行为可预测，便于理解和调试\n4. 符合现实语义：异步操作的结果一旦确定，在逻辑上就不应该改变\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><hr><h3 id="_3-promise-a-规范核心" tabindex="-1"><a class="header-anchor" href="#_3-promise-a-规范核心" aria-hidden="true">#</a> 3. Promise A+ 规范核心</h3><p>Promise A+ 规范的核心要点有哪些？then 方法的返回值处理、链式调用、值穿透？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>核心要点:\n1. Promise 必须提供 then 方法来访问当前或最终的值或原因\n2. then 方法必须返回一个新的 Promise\n3. onFulfilled 和 onRejected 都是可选的，如果不是函数则必须被忽略\n4. onFulfilled 和 onRejected 必须作为函数调用，且最多调用一次\n5. then 方法可以被同一个 Promise 调用多次\n6. 执行顺序：then 方法必须异步执行（微任务）\n\nthen 返回值处理:\n1. 如果 onFulfilled 或 onRejected 返回一个值 x，则运行 Promise 解决过程 [[Resolve]](promise2, x)\n2. 如果返回一个 Promise，则采用该 Promise 的状态\n3. 如果抛出异常，则 promise2 必须被拒绝，并以该异常作为原因\n4. 如果 onFulfilled 不是函数且 promise1 已成功，promise2 必须成功并返回相同的值（值穿透）\n5. 如果 onRejected 不是函数且 promise1 已失败，promise2 必须失败并返回相同的原因（值穿透）\n\n链式调用:\nPromise 的 then 方法返回一个新的 Promise，因此可以链式调用：\n\npromise\n  .then(value =&gt; {\n    return value * 2;  // 返回普通值，下一个 then 接收该值\n  })\n  .then(value =&gt; {\n    return new Promise(resolve =&gt; resolve(value + 1));  // 返回 Promise，等待其解决\n  })\n  .then(value =&gt; {\n    console.log(value);  // 接收上一个 Promise 的结果\n  });\n\n值穿透:\n当 then 的参数不是函数时，值会&quot;穿透&quot;到下一个 then：\n\nPromise.resolve(1)\n  .then(2)  // 2 不是函数，被忽略\n  .then(3)  // 3 不是函数，被忽略\n  .then(value =&gt; console.log(value));  // 输出 1，值穿透了\n\nPromise.reject(&#39;error&#39;)\n  .then(null, null)  // 两个参数都不是函数\n  .catch(err =&gt; console.log(err));  // 错误也会穿透\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><hr><h3 id="_4-promise-静态方法" tabindex="-1"><a class="header-anchor" href="#_4-promise-静态方法" aria-hidden="true">#</a> 4. Promise 静态方法</h3><p>Promise.all / race / allSettled / any 的区别？各自的使用场景和返回值？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Promise.all:\n- 功能：等待所有 Promise 成功，或第一个失败\n- 返回值：如果全部成功，返回所有结果的数组（按输入顺序）；如果有一个失败，立即返回该失败原因\n- 使用场景：需要等待多个异步操作全部完成，且它们相互依赖\n- 特点：短路特性，一旦有 Promise 失败，立即返回失败\n\n示例：\nPromise.all([promise1(), promise2(), promise3()])\n  .then(([r1, r2, r3]) =&gt; console.log(&#39;全部成功&#39;, r1, r2, r3))\n  .catch(err =&gt; console.log(&#39;有失败&#39;, err));\n\nPromise.race:\n- 功能：返回第一个完成（成功或失败）的 Promise 结果\n- 返回值：第一个完成的 Promise 的结果或原因\n- 使用场景：超时控制、竞态条件、获取最快响应\n- 特点：不等待其他 Promise，只要有一个完成就返回\n\n示例：\nPromise.race([fetchData(), timeout(5000)])\n  .then(data =&gt; console.log(&#39;数据获取成功&#39;))\n  .catch(err =&gt; console.log(&#39;超时或失败&#39;));\n\nPromise.allSettled:\n- 功能：等待所有 Promise 完成（无论成功或失败）\n- 返回值：包含所有结果的数组，每个元素是 {status: &#39;fulfilled&#39;|&#39;rejected&#39;, value|reason}\n- 使用场景：需要知道所有异步操作的结果，即使有失败也要继续\n- 特点：不会短路，等待所有 Promise 完成\n\n示例：\nPromise.allSettled([promise1(), promise2(), promise3()])\n  .then(results =&gt; {\n    results.forEach((result, index) =&gt; {\n      if (result.status === &#39;fulfilled&#39;) {\n        console.log(`Promise ${index} 成功:`, result.value);\n      } else {\n        console.log(`Promise ${index} 失败:`, result.reason);\n      }\n    });\n  });\n\nPromise.any:\n- 功能：等待第一个成功的 Promise，或所有都失败\n- 返回值：第一个成功的 Promise 的结果；如果全部失败，返回 AggregateError\n- 使用场景：多个备用方案，只要有一个成功即可\n- 特点：忽略失败，只关注成功\n\n示例：\nPromise.any([fetchFromServer1(), fetchFromServer2(), fetchFromServer3()])\n  .then(data =&gt; console.log(&#39;任一服务器响应成功&#39;, data))\n  .catch(err =&gt; console.log(&#39;所有服务器都失败&#39;, err));\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><hr><h3 id="_5-手写-promise-核心逻辑" tabindex="-1"><a class="header-anchor" href="#_5-手写-promise-核心逻辑" aria-hidden="true">#</a> 5. 手写 Promise 核心逻辑</h3><p>手写一个简化版 Promise，实现构造函数、状态管理、then 方法。</p><p><strong>【作答】：</strong></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&#39;pending&#39;</span> <span class="token comment">// pending, fulfilled, rejected</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 成功时的值</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 失败时的原因</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 成功回调队列</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 失败回调队列</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">&#39;pending&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&#39;fulfilled&#39;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value\n        <span class="token comment">// 异步执行所有成功回调</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">&#39;pending&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">&#39;rejected&#39;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason\n        <span class="token comment">// 异步执行所有失败回调</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 值穿透：如果参数不是函数，则忽略</span>\n    onFulfilled <span class="token operator">=</span>\n      <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value\n    onRejected <span class="token operator">=</span>\n      <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span>\n        <span class="token operator">?</span> <span class="token function-variable function">onRejected</span>\n        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> reason\n          <span class="token punctuation">}</span>\n\n    <span class="token comment">// 返回新的 Promise 以支持链式调用</span>\n    <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">&#39;fulfilled&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 异步执行，使用 setTimeout 模拟微任务</span>\n        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">&#39;rejected&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// pending 状态，将回调加入队列</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>\n              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n              <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>\n              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n    <span class="token keyword">return</span> promise2\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// Promise 解决过程</span>\n  <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 防止循环引用</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#39;Chaining cycle detected&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 防止多次调用</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token comment">// x 是 thenable 对象</span>\n          <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>\n            x<span class="token punctuation">,</span>\n            <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>\n              called <span class="token operator">=</span> <span class="token boolean">true</span>\n              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n              <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>\n              called <span class="token operator">=</span> <span class="token boolean">true</span>\n              <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">)</span>\n        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n          <span class="token comment">// x 是普通对象</span>\n          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>\n        called <span class="token operator">=</span> <span class="token boolean">true</span>\n        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// x 是普通值</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> value\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br></div></div><hr><h3 id="_6-async-await-与-promise" tabindex="-1"><a class="header-anchor" href="#_6-async-await-与-promise" aria-hidden="true">#</a> 6. async/await 与 Promise</h3><p>async/await 是如何基于 Promise 实现的？它的优势是什么？错误处理如何做？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>实现原理:\nasync/await 本质上是 Promise 的语法糖，基于 Generator 函数和自动执行器实现：\n\n1. async 函数总是返回一个 Promise\n2. await 会暂停函数执行，等待 Promise 解决\n3. 如果 await 的是 Promise，则等待其解决；如果是普通值，则直接返回\n4. 底层通过 Generator + 自动执行器实现暂停和恢复\n\n转换过程：\nasync function foo() {\n  const result = await promise;\n  return result;\n}\n\n// 等价于\nfunction foo() {\n  return promise.then(result =&gt; {\n    return result;\n  });\n}\n\n优势:\n1. 代码更简洁：消除了 .then() 链，代码看起来像同步代码\n2. 错误处理更直观：可以使用 try/catch 处理异步错误\n3. 调试友好：调用栈更清晰，断点调试更方便\n4. 条件逻辑更简单：if/else、循环等控制流更自然\n5. 变量作用域更清晰：不需要在 then 回调中定义变量\n\n错误处理:\n1. try/catch 捕获：可以捕获 await 表达式中抛出的错误\n2. catch 方法：async 函数返回的 Promise 可以用 .catch() 捕获\n3. 错误传播：async 函数中抛出的错误会被转换为 rejected Promise\n\n// 方式1：try/catch\nasync function fetchData() {\n  try {\n    const data = await api.getData();\n    return data;\n  } catch (error) {\n    console.error(&#39;获取数据失败&#39;, error);\n    throw error; // 重新抛出，让调用者处理\n  }\n}\n\n// 方式2：.catch()\nfetchData()\n  .then(data =&gt; console.log(data))\n  .catch(error =&gt; console.error(error));\n\n等价转换示例:\n\n// async/await 版本\nasync function example() {\n  try {\n    const user = await fetchUser();\n    const posts = await fetchPosts(user.id);\n    const comments = await fetchComments(posts[0].id);\n    return { user, posts, comments };\n  } catch (error) {\n    console.error(error);\n  }\n}\n\n// Promise 版本\nfunction example() {\n  return fetchUser()\n    .then(user =&gt; {\n      return fetchPosts(user.id).then(posts =&gt; {\n        return fetchComments(posts[0].id).then(comments =&gt; {\n          return { user, posts, comments };\n        });\n      });\n    })\n    .catch(error =&gt; {\n      console.error(error);\n    });\n}\n\n// 更清晰的 Promise 版本（使用链式调用）\nfunction example() {\n  return fetchUser()\n    .then(user =&gt; fetchPosts(user.id))\n    .then(posts =&gt; fetchComments(posts[0].id))\n    .then(comments =&gt; ({ user, posts, comments }))\n    .catch(error =&gt; console.error(error));\n}\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><hr><h2 id="面试题-4-题" tabindex="-1"><a class="header-anchor" href="#面试题-4-题" aria-hidden="true">#</a> 面试题（4 题）</h2><h3 id="_1-手写-promise-all" tabindex="-1"><a class="header-anchor" href="#_1-手写-promise-all" aria-hidden="true">#</a> 1. 手写 Promise.all</h3><p>手写实现 Promise.all，要求处理边界情况（空数组、非 Promise 值、reject 短路）。</p><p><strong>【作答】：</strong></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function-variable function">myAll</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 处理空数组</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#39;参数必须是数组&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>promises<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n    <span class="token keyword">let</span> completedCount <span class="token operator">=</span> <span class="token number">0</span>\n    <span class="token keyword">const</span> total <span class="token operator">=</span> promises<span class="token punctuation">.</span>length\n\n    promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 处理非 Promise 值，使用 Promise.resolve 包装</span>\n      Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          results<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> value\n          completedCount<span class="token operator">++</span>\n\n          <span class="token comment">// 所有 Promise 都完成</span>\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>completedCount <span class="token operator">===</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          <span class="token comment">// 一旦有 Promise 失败，立即 reject（短路特性）</span>\n          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// 测试用例</span>\n\n<span class="token comment">// 1. 基本功能：全部成功</span>\nPromise<span class="token punctuation">.</span><span class="token function">myAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;全部成功:&#39;</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token comment">// [1, 2, 3]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 2. 有失败的情况：短路</span>\nPromise<span class="token punctuation">.</span><span class="token function">myAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;捕获错误:&#39;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// &#39;error&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 3. 空数组</span>\nPromise<span class="token punctuation">.</span><span class="token function">myAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;空数组:&#39;</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token comment">// []</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 4. 非 Promise 值</span>\nPromise<span class="token punctuation">.</span><span class="token function">myAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;包含非Promise值:&#39;</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token comment">// [1, 2, 3]</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 5. 异步操作</span>\nPromise<span class="token punctuation">.</span><span class="token function">myAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;异步操作:&#39;</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span> <span class="token comment">// [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] (保持输入顺序)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><hr><h3 id="_2-promise-链式调用原理" tabindex="-1"><a class="header-anchor" href="#_2-promise-链式调用原理" aria-hidden="true">#</a> 2. Promise 链式调用原理</h3><p>详细解释 Promise 链式调用的原理，为什么 then 可以链式调用？返回值如何影响下一个 then？</p><p><strong>【作答】：</strong></p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code>Promise 链式调用的原理：\n\n<span class="token list punctuation">1.</span> then 方法返回新的 Promise\n\n   <span class="token list punctuation">-</span> 每次调用 then 都会创建一个新的 Promise 实例（promise2）\n   <span class="token list punctuation">-</span> 这个新的 Promise 的状态由回调函数的返回值决定\n   <span class="token list punctuation">-</span> 因此可以继续调用 then，形成链式调用\n\n<span class="token list punctuation">2.</span> 返回值如何影响下一个 then：\n   a) 返回普通值：下一个 then 的 onFulfilled 接收该值\n   promise.then(() =&gt; 1)\n   .then(value =&gt; console.log(value)); // 1\n\n   b) 返回 Promise：下一个 then 等待该 Promise 解决\n   promise.then(() =&gt; Promise.resolve(2))\n   .then(value =&gt; console.log(value)); // 2\n\n   c) 抛出异常：下一个 then 的 onRejected 或 catch 接收该异常\n   promise.then(() =&gt; { throw new Error(&#39;error&#39;); })\n   .catch(err =&gt; console.log(err)); // Error: error\n\n   d) 不返回（undefined）：下一个 then 接收 undefined\n   promise.then(() =&gt; { /<span class="token italic"><span class="token punctuation">_</span><span class="token content"> 没有 return </span><span class="token punctuation">_</span></span>/ })\n   .then(value =&gt; console.log(value)); // undefined\n\n<span class="token list punctuation">3.</span> 链式调用的执行流程：\n   promise1\n   .then(onFulfilled1) // 返回 promise2\n   .then(onFulfilled2) // 返回 promise3\n   .then(onFulfilled3) // 返回 promise4\n   .catch(onRejected); // 捕获前面任意一个 Promise 的失败\n\n   执行顺序：\n\n   <span class="token list punctuation">-</span> promise1 解决 → 执行 onFulfilled1 → promise2 解决\n   <span class="token list punctuation">-</span> promise2 解决 → 执行 onFulfilled2 → promise3 解决\n   <span class="token list punctuation">-</span> promise3 解决 → 执行 onFulfilled3 → promise4 解决\n\n<span class="token list punctuation">4.</span> 为什么可以链式调用：\n\n   <span class="token list punctuation">-</span> JavaScript 中，如果方法返回对象，可以继续调用该对象的方法\n   <span class="token list punctuation">-</span> then 方法返回 Promise 实例，Promise 实例也有 then 方法\n   <span class="token list punctuation">-</span> 因此可以无限链式调用：promise.then().then().then()...\n\n<span class="token list punctuation">5.</span> 错误传播机制：\n   <span class="token list punctuation">-</span> 如果链中某个 Promise 被 reject，错误会向下传播\n   <span class="token list punctuation">-</span> 直到遇到 catch 或 onRejected 处理函数\n   <span class="token list punctuation">-</span> 一旦被处理，后续的 then 会继续执行（使用处理后的值）\n\n示例：\nPromise.resolve(1)\n.then(value =&gt; {\nconsole.log(value); // 1\nreturn value + 1;\n})\n.then(value =&gt; {\nconsole.log(value); // 2\nreturn Promise.resolve(value + 1);\n})\n.then(value =&gt; {\nconsole.log(value); // 3\nthrow new Error(&#39;test&#39;);\n})\n.catch(error =&gt; {\nconsole.log(error.message); // &#39;test&#39;\nreturn 100;\n})\n.then(value =&gt; {\nconsole.log(value); // 100，catch 处理后继续执行\n});\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><hr><h3 id="_3-promise-实践问题" tabindex="-1"><a class="header-anchor" href="#_3-promise-实践问题" aria-hidden="true">#</a> 3. Promise 实践问题</h3><p>在实际开发中，Promise 使用有哪些常见坑（未捕获错误、忘记 return、循环中的 Promise）？如何规避？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>常见坑及规避方法：\n\n1. 未捕获的错误\n   问题：Promise 中的错误如果没有被 catch，会导致未处理的 Promise rejection\n\n   // 错误示例\n   Promise.reject(&#39;error&#39;); // 未捕获的错误\n\n   // 正确做法\n   Promise.reject(&#39;error&#39;).catch(err =&gt; console.error(err));\n\n   // 或者在 async 函数中使用 try/catch\n   async function test() {\n     try {\n       await Promise.reject(&#39;error&#39;);\n     } catch (err) {\n       console.error(err);\n     }\n   }\n\n2. 忘记 return\n   问题：在 then 回调中忘记 return，导致下一个 then 接收 undefined\n\n   // 错误示例\n   fetchData()\n     .then(data =&gt; {\n       processData(data); // 忘记 return\n     })\n     .then(result =&gt; {\n       console.log(result); // undefined\n     });\n\n   // 正确做法\n   fetchData()\n     .then(data =&gt; {\n       return processData(data); // 显式返回\n     })\n     .then(result =&gt; {\n       console.log(result); // 正确的结果\n     });\n\n   // 或者使用箭头函数简化\n   fetchData()\n     .then(data =&gt; processData(data))\n     .then(result =&gt; console.log(result));\n\n3. 循环中的 Promise\n   问题：在 for/forEach 循环中使用 Promise，可能导致并发问题或顺序问题\n\n   // 错误示例1：forEach 不会等待 Promise\n   array.forEach(async item =&gt; {\n     await processItem(item); // forEach 不会等待\n   });\n   console.log(&#39;完成&#39;); // 可能在所有 Promise 完成前执行\n\n   // 错误示例2：顺序执行但效率低\n   for (const item of array) {\n     await processItem(item); // 串行执行，效率低\n   }\n\n   // 正确做法1：并行执行\n   await Promise.all(array.map(item =&gt; processItem(item)));\n\n   // 正确做法2：需要顺序执行时使用 for...of\n   for (const item of array) {\n     await processItem(item); // 明确需要顺序执行\n   }\n\n   // 正确做法3：限制并发数\n   async function processWithLimit(array, limit) {\n     for (let i = 0; i &lt; array.length; i += limit) {\n       const batch = array.slice(i, i + limit);\n       await Promise.all(batch.map(item =&gt; processItem(item)));\n     }\n   }\n\n4. Promise 构造函数中的错误处理\n   问题：executor 中的同步错误会被自动捕获，但异步错误需要手动处理\n\n   // 正确示例\n   new Promise((resolve, reject) =&gt; {\n     try {\n       // 同步错误会被捕获\n       throw new Error(&#39;sync error&#39;);\n     } catch (error) {\n       reject(error);\n     }\n\n     // 异步错误需要手动处理\n     setTimeout(() =&gt; {\n       try {\n         throw new Error(&#39;async error&#39;);\n       } catch (error) {\n         reject(error);\n       }\n     }, 100);\n   });\n\n5. 同时使用 then 和 await\n   问题：混用可能导致执行顺序不符合预期\n\n   // 不推荐：混用\n   const promise = fetchData();\n   promise.then(data =&gt; console.log(&#39;then&#39;, data));\n   const data = await promise; // 可能先于 then 执行\n\n   // 推荐：统一使用一种方式\n   // 方式1：全部使用 await\n   const data = await fetchData();\n   console.log(data);\n\n   // 方式2：全部使用 then\n   fetchData().then(data =&gt; console.log(data));\n\n6. Promise.all 的短路特性\n   问题：Promise.all 中有一个失败，其他成功的 Promise 结果会丢失\n\n   // 如果需要所有结果（包括失败的），使用 Promise.allSettled\n   const results = await Promise.allSettled([\n     promise1(),\n     promise2(),\n     promise3()\n   ]);\n\n   results.forEach((result, index) =&gt; {\n     if (result.status === &#39;fulfilled&#39;) {\n       console.log(`Promise ${index} 成功:`, result.value);\n     } else {\n       console.log(`Promise ${index} 失败:`, result.reason);\n     }\n   });\n\n7. 内存泄漏\n   问题：长时间未解决的 Promise 可能导致内存泄漏\n\n   // 添加超时机制\n   function withTimeout(promise, timeout) {\n     return Promise.race([\n       promise,\n       new Promise((_, reject) =&gt;\n         setTimeout(() =&gt; reject(new Error(&#39;超时&#39;)), timeout)\n       )\n     ]);\n   }\n\n   await withTimeout(fetchData(), 5000);\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br></div></div><hr><h3 id="_4-promise-vs-callback-vs-async-await" tabindex="-1"><a class="header-anchor" href="#_4-promise-vs-callback-vs-async-await" aria-hidden="true">#</a> 4. Promise vs Callback vs async/await</h3><p>对比回调、Promise、async/await 三种异步方案的优缺点，什么场景下你会选择哪一种？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>三种异步方案对比：\n\n1. Callback（回调函数）\n   优点：\n   - 简单直接，无需额外语法\n   - 兼容性好，所有 JavaScript 环境都支持\n   - 性能开销小\n\n   缺点：\n   - 回调地狱，嵌套过深难以维护\n   - 错误处理分散，难以统一捕获\n   - 难以组合多个异步操作\n   - 控制流复杂（if/else、循环等）\n\n   使用场景：\n   - 简单的单次异步操作\n   - 需要兼容老旧环境\n   - 性能要求极高的场景\n   - Node.js 某些 API（如 fs.readFile）\n\n2. Promise\n   优点：\n   - 链式调用，代码更清晰\n   - 统一的错误处理（catch）\n   - 易于组合（all、race 等）\n   - 状态明确（pending、fulfilled、rejected）\n   - 解决回调地狱问题\n\n   缺点：\n   - 仍然需要 .then() 链，不够直观\n   - 无法使用 try/catch（需要用 .catch()）\n   - 调试时调用栈可能不够清晰\n\n   使用场景：\n   - 需要组合多个异步操作（all、race）\n   - 需要明确的错误处理流程\n   - 需要链式调用但不想用 async/await\n   - 库或框架的 API 设计\n\n3. async/await\n   优点：\n   - 代码最接近同步写法，易读易维护\n   - 可以使用 try/catch 处理错误\n   - 调试友好，调用栈清晰\n   - 控制流简单（if/else、循环等）\n   - 变量作用域清晰\n\n   缺点：\n   - 需要 Promise 支持（可 polyfill）\n   - 可能隐藏并发问题（忘记 await）\n   - 错误处理不当可能导致未捕获的 Promise rejection\n   - 在某些场景下性能略低于直接使用 Promise\n\n   使用场景：\n   - 大多数现代 JavaScript 开发\n   - 需要顺序执行的异步操作\n   - 复杂的异步控制流\n   - 需要清晰的错误处理\n\n选择建议：\n\n1. 简单的一次性异步操作：\n   - Callback 或 Promise 都可以\n   - 如果 API 提供 Promise 版本，优先使用\n\n2. 需要组合多个异步操作：\n   - 使用 Promise.all/race/allSettled/any\n   - 或使用 async/await + Promise 静态方法\n\n3. 复杂的异步流程控制：\n   - 优先使用 async/await\n   - 代码更清晰，易于维护\n\n4. 需要并行执行：\n   - Promise.all + async/await\n   - 或 Promise.all + .then()\n\n5. 需要顺序执行：\n   - async/await + for...of\n   - 或 Promise 链式调用\n\n6. 错误处理：\n   - async/await + try/catch（最直观）\n   - Promise + .catch()（也常用）\n\n实际开发建议：\n- 现代项目：优先使用 async/await\n- 库开发：提供 Promise 接口，内部可以使用 async/await\n- 性能敏感：根据具体情况选择，通常差异不大\n- 团队协作：统一代码风格，避免混用\n\n示例对比：\n\n// Callback\ngetData(function(err, data) {\n  if (err) {\n    handleError(err);\n    return;\n  }\n  processData(data, function(err, result) {\n    if (err) {\n      handleError(err);\n      return;\n    }\n    saveResult(result, function(err) {\n      if (err) handleError(err);\n    });\n  });\n});\n\n// Promise\ngetData()\n  .then(data =&gt; processData(data))\n  .then(result =&gt; saveResult(result))\n  .catch(err =&gt; handleError(err));\n\n// async/await\ntry {\n  const data = await getData();\n  const result = await processData(data);\n  await saveResult(result);\n} catch (err) {\n  handleError(err);\n}\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br></div></div><hr>',53),p={},l=(0,a(3744).Z)(p,[["render",function(n,s){return e}]])}}]);