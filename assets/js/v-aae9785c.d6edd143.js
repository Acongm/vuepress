"use strict";(self.webpackChunkmd_vuepress=self.webpackChunkmd_vuepress||[]).push([[2317],{61:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-aae9785c",path:"/mark/02-Webpack%E4%B8%8E%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7.html",title:"Webpack 架构 & 与 Rollup、Vite 对比 & 核心原理",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"笔试题（6 题）",slug:"笔试题-6-题",children:[{level:3,title:"1. Webpack 构建流程",slug:"_1-webpack-构建流程",children:[]},{level:3,title:"2. Loader vs Plugin",slug:"_2-loader-vs-plugin",children:[]},{level:3,title:"3. Module Graph vs Chunk Graph",slug:"_3-module-graph-vs-chunk-graph",children:[]},{level:3,title:"4. Rollup Tree-shaking",slug:"_4-rollup-tree-shaking",children:[]},{level:3,title:"5. Vite 为什么快",slug:"_5-vite-为什么快",children:[]},{level:3,title:"6. Webpack HMR 原理",slug:"_6-webpack-hmr-原理",children:[]}]},{level:2,title:"面试题（4 题）",slug:"面试题-4-题",children:[{level:3,title:"1. 从 0 设计打包器",slug:"_1-从-0-设计打包器",children:[]},{level:3,title:"2. Vite 的开发/生产模式差异",slug:"_2-vite-的开发-生产模式差异",children:[]},{level:3,title:"3. Webpack 性能优化",slug:"_3-webpack-性能优化",children:[]},{level:3,title:"4. Webpack 迁移到 Vite",slug:"_4-webpack-迁移到-vite",children:[]}]}],git:{updatedTime:1770275296e3},filePathRelative:"mark/02-Webpack与构建工具.md"}},7146:(n,s,a)=>{a.r(s),a.d(s,{default:()=>p});const e=(0,a(6252).uE)('<h1 id="webpack-架构-与-rollup、vite-对比-核心原理" tabindex="-1"><a class="header-anchor" href="#webpack-架构-与-rollup、vite-对比-核心原理" aria-hidden="true">#</a> Webpack 架构 &amp; 与 Rollup、Vite 对比 &amp; 核心原理</h1><h2 id="笔试题-6-题" tabindex="-1"><a class="header-anchor" href="#笔试题-6-题" aria-hidden="true">#</a> 笔试题（6 题）</h2><h3 id="_1-webpack-构建流程" tabindex="-1"><a class="header-anchor" href="#_1-webpack-构建流程" aria-hidden="true">#</a> 1. Webpack 构建流程</h3><p>画出 Webpack 构建流程的关键步骤（entry → loader → plugin → chunk → asset），并解释每个步骤的作用。</p><p><strong>【作答】：</strong></p><p>流程图：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\n┌─────────────────────────────────────────────────────────────┐\n│  1. 初始化阶段 (Initialization)                              │\n│  - 读取配置文件 (webpack.config.js)                          │\n│  - 合并命令行参数                                            │\n│  - 实例化 Compiler 对象                                      │\n│  - 注册所有 Plugin                                           │\n└─────────────────────────────────────────────────────────────┘\n              ↓\n┌─────────────────────────────────────────────────────────────┐\n│  2. 编译阶段 (Compilation)                                   │\n│  ┌──────────────────────────────────────────────────────┐   │\n│  │ 2.1 从 Entry 开始递归                                │   │\n│  │  entry: &#39;./src/index.js&#39;                            │   │\n│  └──────────────────────────────────────────────────────┘   │\n│              ↓                                               │\n│  ┌──────────────────────────────────────────────────────┐   │\n│  │ 2.2 调用 Loader 转换模块                             │   │\n│  │  .js → babel-loader → ES5                           │   │\n│  │  .css → css-loader → style-loader                   │   │\n│  │  .scss → sass-loader → css-loader                   │   │\n│  └──────────────────────────────────────────────────────┘   │\n│              ↓                                               │\n│  ┌──────────────────────────────────────────────────────┐   │\n│  │ 2.3 解析依赖关系                                      │   │\n│  │  import &#39;./utils.js&#39; → 加入依赖图                    │   │\n│  │  require(&#39;./config&#39;) → 继续递归解析                  │   │\n│  └──────────────────────────────────────────────────────┘   │\n│              ↓                                               │\n│  ┌──────────────────────────────────────────────────────┐   │\n│  │ 2.4 构建 Module Graph (模块依赖图)                    │   │\n│  │     index.js                                         │   │\n│  │     ├── utils.js                                     │   │\n│  │     │   └── helper.js                                │   │\n│  │     └── config.js                                    │   │\n│  └──────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n              ↓\n┌─────────────────────────────────────────────────────────────┐\n│  3. 优化阶段 (Optimization)                                  │\n│  - Tree Shaking (剔除未使用代码)                             │\n│  - Scope Hoisting (作用域提升)                               │\n│  - Code Splitting (代码分割)                                 │\n│  - Minification (压缩代码)                                   │\n└─────────────────────────────────────────────────────────────┘\n              ↓\n┌─────────────────────────────────────────────────────────────┐\n│  4. 生成 Chunk 阶段 (Chunk Generation)                       │\n│  根据依赖关系和分割策略生成 Chunk：                            │\n│  - main.chunk.js (entry chunk)                              │\n│  - vendor.chunk.js (splitChunks)                            │\n│  - async.chunk.js (动态 import)                             │\n└─────────────────────────────────────────────────────────────┘\n              ↓\n┌─────────────────────────────────────────────────────────────┐\n│  5. 生成 Asset 阶段 (Asset Generation)                       │\n│  将 Chunk 渲染成最终文件：                                    │\n│  - main.bundle.js                                           │\n│  - vendor.bundle.js                                         │\n│  - style.css                                                │\n│  - images/logo.png                                          │\n│  - index.html (HtmlWebpackPlugin)                           │\n└─────────────────────────────────────────────────────────────┘\n              ↓\n┌─────────────────────────────────────────────────────────────┐\n│  6. 输出阶段 (Emit)                                          │\n│  - 写入文件系统 (dist/)                                      │\n│  - 生成 manifest.json                                       │\n│  - 生成 stats.json                                          │\n└─────────────────────────────────────────────────────────────┘\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>各步骤作用：</p><p>entry (入口):</p><ul><li>定义构建的起点，Webpack 从这里开始分析依赖</li><li>可以是单入口或多入口</li><li>示例：entry: { main: &#39;./src/index.js&#39;, admin: &#39;./src/admin.js&#39; }</li><li>作用：确定应用的入口文件，形成依赖图的根节点</li></ul><p>loader (转换器):</p><ul><li>将非 JavaScript 文件转换为 Webpack 能处理的模块</li><li>从右到左、从下到上链式调用</li><li>示例：.vue → vue-loader → JavaScript 模块</li><li>作用：实现文件级别的转换，处理特定类型的文件</li><li>本质：导出函数，接收源码字符串，返回转换后的代码</li></ul><p>plugin (插件):</p><ul><li>在 Webpack 构建流程的特定时机执行自定义逻辑</li><li>通过监听 Webpack 生命周期钩子实现功能扩展</li><li>示例：HtmlWebpackPlugin 生成 HTML、CleanWebpackPlugin 清理目录</li><li>作用：处理 loader 无法完成的复杂任务，如打包优化、资源管理</li><li>本质：包含 apply 方法的类/对象，可以访问整个编译生命周期</li></ul><p>chunk (代码块):</p><ul><li>多个模块的集合，是 Webpack 内部的中间产物</li><li>生成方式： <ol><li>Entry Chunk：每个 entry 生成一个 chunk</li><li>Async Chunk：动态 import() 生成异步 chunk</li><li>Runtime Chunk：提取运行时代码</li><li>Split Chunk：通过 splitChunks 提取公共模块</li></ol></li><li>作用：组织模块，为代码分割提供基础</li></ul><p>asset (资源文件):</p><ul><li>最终输出到 dist 目录的文件</li><li>包括：JavaScript bundle、CSS 文件、图片、字体等</li><li>命名规则：通过 output.filename 和 output.chunkFilename 配置</li><li>示例：main.[contenthash].js、vendors~main.[chunkhash].js</li><li>作用：浏览器可直接加载的最终产物</li></ul><hr><h3 id="_2-loader-vs-plugin" tabindex="-1"><a class="header-anchor" href="#_2-loader-vs-plugin" aria-hidden="true">#</a> 2. Loader vs Plugin</h3><p>loader 与 plugin 的本质区别是什么？各自的执行时机、能力边界？举例说明什么场景用 loader，什么场景用 plugin。</p><p><strong>【作答】：</strong></p><p>本质区别：</p><p>【Loader】</p><ul><li>本质：一个导出函数的模块</li><li>职责：文件转换器，将源文件转换为 Webpack 可处理的模块</li><li>作用范围：单个文件级别</li><li>输入/输出：字符串 → 字符串（或 Buffer）</li><li>代码示例：</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>  function myLoader(source) {\n    // source: 源文件内容\n    const result = transform(source);\n    return result; // 返回转换后的代码\n  }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>【Plugin】</p><ul><li>本质：包含 apply 方法的类或对象</li><li>职责：功能扩展器，监听构建流程中的事件钩子</li><li>作用范围：整个编译过程</li><li>输入/输出：访问 Compiler 和 Compilation 对象，可以修改整个构建过程</li><li>代码示例：</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>  class MyPlugin {\n    apply(compiler) {\n      compiler.hooks.emit.tap(&#39;MyPlugin&#39;, (compilation) =&gt; {\n        // 可以访问所有资源、修改输出等\n      });\n    }\n  }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>执行时机：</p><p>loader:</p><ol><li>在模块加载阶段执行</li><li>处理每个匹配的文件时调用</li><li>链式调用顺序：从右到左，从下到上 规则：[&#39;style-loader&#39;, &#39;css-loader&#39;, &#39;sass-loader&#39;] 执行：sass-loader → css-loader → style-loader</li></ol><p>示例执行流程： 发现 .scss 文件 ↓ sass-loader: SCSS → CSS ↓ css-loader: CSS → JS 模块 (CSS 转 CommonJS) ↓ style-loader: 注入 script 标签到 DOM</p><p>plugin:</p><ol><li>在整个编译生命周期的特定钩子执行</li><li>可以监听多个钩子，在不同阶段介入</li></ol><p>主要钩子时机：</p><ul><li>entryOption: 读取配置后</li><li>afterPlugins: 插件注册完成</li><li>run: 开始编译</li><li>compile: 创建 compilation 对象前</li><li>compilation: compilation 创建完成</li><li>make: 从 entry 开始递归分析依赖</li><li>afterCompile: 编译完成</li><li>emit: 生成资源到 output 目录前（可修改产物）</li><li>afterEmit: 生成资源后</li><li>done: 编译完全完成</li></ul><p>示例执行流程： Webpack 启动 ↓ run 钩子 → CleanWebpackPlugin 清理旧文件 ↓ compilation 钩子 → ProgressPlugin 显示进度 ↓ emit 钩子 → HtmlWebpackPlugin 生成 HTML ↓ done 钩子 → 输出构建统计信息</p><p>能力边界：</p><p>【Loader 能做的】 ✅ 转换文件内容（语言转换、编译）</p><ul><li>babel-loader: ES6+ → ES5</li><li>ts-loader: TypeScript → JavaScript</li><li>sass-loader: SCSS → CSS</li></ul><p>✅ 处理特定资源</p><ul><li>file-loader: 文件复制并返回 URL</li><li>url-loader: 小文件转 base64</li><li>image-loader: 图片压缩</li></ul><p>✅ 代码注入或修改</p><ul><li>vue-loader: 处理 .vue 单文件组件</li><li>eslint-loader: 代码检查并报告</li></ul><p>【Loader 不能做的】 ❌ 访问其他模块 ❌ 修改整体输出结构 ❌ 生成额外文件（除非通过 emitFile API） ❌ 访问编译上下文和统计信息</p><p>【Plugin 能做的】 ✅ 监听整个构建流程</p><ul><li>可以在任意钩子介入</li></ul><p>✅ 修改输出产物</p><ul><li>TerserPlugin: 压缩 JS</li><li>MiniCssExtractPlugin: 提取 CSS 为单独文件</li></ul><p>✅ 生成额外资源</p><ul><li>HtmlWebpackPlugin: 生成 HTML</li><li>CopyWebpackPlugin: 复制静态资源</li></ul><p>✅ 优化构建</p><ul><li>SplitChunksPlugin: 代码分割</li><li>DllPlugin: 预编译依赖</li></ul><p>✅ 改变编译行为</p><ul><li>DefinePlugin: 定义全局常量</li><li>ProvidePlugin: 自动加载模块</li></ul><p>【Plugin 不能做的】 ❌ 直接转换单个文件内容（应该用 loader）</p><p>使用场景示例：</p><p>【使用 Loader 的场景】</p><p>场景 1：TypeScript 转 JavaScript</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/\\.ts$/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n      <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token string">&#39;ts-loader&#39;</span> <span class="token comment">// ✅ 文件转换 → 用 loader</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>场景 2：样式处理链</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>\n  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/\\.scss$/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token string">&#39;style-loader&#39;</span><span class="token punctuation">,</span>    <span class="token comment">// 注入到 DOM</span>\n    <span class="token string">&#39;css-loader&#39;</span><span class="token punctuation">,</span>      <span class="token comment">// 解析 CSS 依赖</span>\n    <span class="token string">&#39;postcss-loader&#39;</span><span class="token punctuation">,</span>  <span class="token comment">// 自动添加浏览器前缀</span>\n    <span class="token string">&#39;sass-loader&#39;</span>      <span class="token comment">// 编译 SCSS</span>\n  <span class="token punctuation">]</span>  <span class="token comment">// ✅ 多步转换 → 链式 loader</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>场景 3：图片资源处理</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>\n  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/\\.(png|jpg|gif)$/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;asset/resource&#39;</span><span class="token punctuation">,</span>\n  <span class="token literal-property property">generator</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;images/[hash][ext]&#39;</span>\n  <span class="token punctuation">}</span>  <span class="token comment">// ✅ 资源处理 → 用 loader (Webpack 5 内置)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>【使用 Plugin 的场景】</p><p>场景 1：自动生成 HTML 并注入 bundle</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">&#39;./src/index.html&#39;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span> <span class="token comment">// ✅ 生成额外文件 → 用 plugin</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>场景 2：提取 CSS 到单独文件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;[name].[contenthash].css&#39;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span> <span class="token comment">// ✅ 改变输出结构 → 用 plugin</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>场景 3：清理旧的构建产物</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// ✅ 文件系统操作 → 用 plugin</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>场景 4：代码分割优化</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">&#39;all&#39;</span><span class="token punctuation">,</span>\n    <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token literal-property property">vendor</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/node_modules/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;vendors&#39;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>  <span class="token comment">// ✅ 构建优化 → 用 plugin (内置)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>场景 5：定义环境变量</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n    <span class="token string-property property">&#39;process____.env.NODE_ENV&#39;</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span> <span class="token comment">// ✅ 全局注入 → 用 plugin</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>场景 6：模块热替换</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// ✅ 改变运行时行为 → 用 plugin</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>【组合使用的场景】</p><p>场景：处理 CSS 并提取到单独文件</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>\n  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/\\.css$/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>\n  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>  <span class="token comment">// loader: 替代 style-loader</span>\n    <span class="token string">&#39;css-loader&#39;</span>                   <span class="token comment">// loader: 处理 CSS</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n  <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      <span class="token comment">// plugin: 提取 CSS 文件</span>\n    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;css/[name].[contenthash].css&#39;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">]</span>\n<span class="token comment">// Loader 负责转换，Plugin 负责输出</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>【决策流程】</p><p>问题：要实现某个功能，用 loader 还是 plugin？</p><ol><li><p>是否只需要转换单个文件？ ✅ 是 → 用 Loader ❌ 否 → 继续判断</p></li><li><p>是否需要访问整个编译流程？ ✅ 是 → 用 Plugin ❌ 否 → 继续判断</p></li><li><p>是否需要生成额外文件或修改输出？ ✅ 是 → 用 Plugin ❌ 否 → 用 Loader</p></li><li><p>是否需要修改多个模块或改变构建行为？ ✅ 是 → 用 Plugin</p></li></ol><p>【记忆口诀】</p><ul><li>Loader: 专注&quot;翻译&quot;，一个文件进，一个文件出</li><li>Plugin: 全局&quot;管家&quot;，可以在构建的任意环节插手</li></ul><hr><h3 id="_3-module-graph-vs-chunk-graph" tabindex="-1"><a class="header-anchor" href="#_3-module-graph-vs-chunk-graph" aria-hidden="true">#</a> 3. Module Graph vs Chunk Graph</h3><p>Webpack 的 module graph 与 chunk graph 分别是什么？它们之间的关系？为什么需要两个图？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Module Graph (模块依赖图):\n\n定义：\n- 表示模块之间的依赖关系\n- 是一个有向图，节点是模块，边是依赖关系\n- 在编译阶段（Compilation）构建\n- 反映了源代码的真实依赖结构\n\n构建时机：\n- 从 entry 开始递归解析\n- 每遇到 import/require 就创建一条边\n- 形成完整的依赖树\n\n示例：\n源代码结构：\n  // index.js\n  import utils from &#39;./utils.js&#39;;\n  import(&#39;./async.js&#39;);  // 动态导入\n\n  // utils.js\n  import helper from &#39;./helper.js&#39;;\n\n  // helper.js\n  export const add = (a, b) =&gt; a + b;\n\nModule Graph：\n        index.js (entry)\n           ↓\n    ┌──────┴──────┐\n    ↓             ↓\n  utils.js    async.js (async)\n    ↓\n  helper.js\n\n特点：\n- 一个模块可能被多个模块依赖（菱形依赖）\n- 包含同步依赖和异步依赖\n- 是静态分析的结果\n\n数据结构：\n{\n  moduleId: &#39;index.js&#39;,\n  dependencies: [\n    { module: &#39;utils.js&#39;, type: &#39;import&#39; },\n    { module: &#39;async.js&#39;, type: &#39;import()&#39;, async: true }\n  ],\n  source: &#39;...&#39;,\n  size: 1024\n}\n\nChunk Graph (代码块图):\n\n定义：\n- 表示 chunk 之间的关系\n- 是将 module graph 按照分割策略重新组织的结果\n- 在优化阶段（Optimization）构建\n- 反映了最终输出文件的组织结构\n\n构建时机：\n- 在 module graph 构建完成后\n- 根据 entry、splitChunks、动态 import 等策略生成\n- 决定了最终有多少个输出文件\n\n示例（基于上面的 Module Graph）：\n\n配置：\nentry: {\n  main: &#39;./src/index.js&#39;\n},\noptimization: {\n  splitChunks: {\n    cacheGroups: {\n      vendors: {\n        test: /node_modules/,\n        name: &#39;vendors&#39;\n      }\n    }\n  }\n}\n\nChunk Graph：\n┌─────────────────────┐\n│  Chunk: main        │\n│  - index.js         │\n│  - utils.js         │\n│  - helper.js        │\n└─────────────────────┘\n         ↓ (异步加载)\n┌─────────────────────┐\n│  Chunk: async       │\n│  - async.js         │\n└─────────────────────┘\n\n如果有 node_modules 依赖：\n┌─────────────────────┐       ┌─────────────────────┐\n│  Chunk: vendors     │  ←──  │  Chunk: main        │\n│  - react.js         │       │  - index.js         │\n│  - lodash.js        │       │  - utils.js         │\n└─────────────────────┘       └─────────────────────┘\n                                       ↓\n                              ┌─────────────────────┐\n                              │  Chunk: async       │\n                              │  - async.js         │\n                              └─────────────────────┘\n\n特点：\n- 一个 chunk 包含多个 module\n- 一个 module 可以属于多个 chunk（共享模块）\n- chunk 之间有父子关系（entry chunk、async chunk）\n- 最终会生成对应的 asset 文件\n\n数据结构：\n{\n  chunkId: &#39;main&#39;,\n  modules: [&#39;index.js&#39;, &#39;utils.js&#39;, &#39;helper.js&#39;],\n  parents: [],  // 父 chunk\n  children: [&#39;async&#39;],  // 子 chunk\n  files: [&#39;main.bundle.js&#39;],\n  hash: &#39;abc123&#39;\n}\n\n两者关系：\n\n1. 转换关系（Module Graph → Chunk Graph）\n   Module Graph                 Chunk Graph\n   ┌──────────┐                ┌─────────────┐\n   │  A  →  B │   分组         │  Chunk 1:   │\n   │  ↓     ↓ │   ======&gt;      │   - A       │\n   │  C  →  D │   策略         │   - B       │\n   │  ↓       │                │   - C       │\n   │  E (异步)│                └─────────────┘\n   └──────────┘                ┌─────────────┐\n                               │  Chunk 2:   │\n                               │   - E       │\n                               └─────────────┘\n\n2. 多对多关系\n   一个 Module 可以属于多个 Chunk（代码复用）\n   一个 Chunk 包含多个 Module（代码聚合）\n\n3. 依赖传递\n   - Module Graph 的依赖关系决定了哪些模块需要打包在一起\n   - Chunk Graph 的父子关系决定了运行时的加载顺序\n\n4. 实际示例\n   源码层面（Module Graph）：\n     app.js → axios (来自 node_modules)\n     page.js → axios (来自 node_modules)\n\n   输出层面（Chunk Graph）：\n     Chunk: vendors (包含 axios，被 app 和 page 共享)\n     Chunk: app (包含 app.js)\n     Chunk: page (包含 page.js)\n\n为什么需要两个图：\n\n原因1：职责分离\n- Module Graph: 关注&quot;依赖关系&quot;\n  → 回答：这个模块依赖哪些模块？\n  → 目的：分析代码结构，Tree Shaking，循环依赖检测\n\n- Chunk Graph: 关注&quot;打包策略&quot;\n  → 回答：这些模块应该打包成几个文件？\n  → 目的：代码分割，缓存优化，并行加载\n\n原因2：灵活的分割策略\n同一个 Module Graph 可以生成不同的 Chunk Graph\n\n示例：相同的源代码，不同的配置\nModule Graph:\n  A → B → C → D\n\n策略1：全部打包到一起\nChunk Graph: [Chunk: main (A, B, C, D)]\n输出: main.js\n\n策略2：按路由分割\nChunk Graph:\n  [Chunk: home (A, B)]\n  [Chunk: about (C, D)]\n输出: home.js, about.js\n\n策略3：提取公共依赖\nChunk Graph:\n  [Chunk: vendors (B, D)]\n  [Chunk: main (A, C)]\n输出: vendors.js, main.js\n\n原因3：优化需求\n- Tree Shaking: 在 Module Graph 上标记未使用的导出\n- Code Splitting: 在 Chunk Graph 上执行分割策略\n- 缓存优化: Chunk Graph 可以分离稳定代码和业务代码\n\n原因4：运行时需求\n- Module Graph: 编译时静态分析\n- Chunk Graph: 运行时动态加载的基础\n\n示例：\n  // 编译时：Module Graph 知道 async.js 是动态导入\n  import(&#39;./async.js&#39;);\n\n  // 运行时：Chunk Graph 确保 async.js 在单独的 chunk\n  // 浏览器通过 &lt;script&gt; 按需加载\n\n原因5：多入口场景\n多个 entry 共享模块时，需要 Chunk Graph 来优化\n\nModule Graph (多入口):\n  entry1.js → common.js\n  entry2.js → common.js\n\nChunk Graph (提取公共模块):\n  Chunk: common (common.js)\n  Chunk: entry1 (entry1.js)\n  Chunk: entry2 (entry2.js)\n\n如果只有 Module Graph，无法表达&quot;common.js 应该单独打包&quot;\n\n【流程总结】\n\n构建流程：\n1. 从 entry 开始解析\n2. 递归分析依赖 → 构建 Module Graph\n3. 应用分割策略 → 生成 Chunk Graph\n4. 渲染 Chunk → 生成 Asset\n5. 输出文件\n\n图的作用：\nModule Graph: 保证依赖正确性\nChunk Graph: 保证输出合理性\n\n【类比理解】\n\nModule Graph = 原材料清单\n  &quot;我需要哪些食材，它们之间有什么关系&quot;\n  - 西红柿 → 需要切碎\n  - 鸡蛋 → 需要打散\n  - 食材之间的搭配关系\n\nChunk Graph = 出菜计划\n  &quot;这些食材应该做成几道菜，如何组合&quot;\n  - 第一道菜：西红柿炒鸡蛋（西红柿 + 鸡蛋）\n  - 第二道菜：糖拌西红柿（西红柿 + 糖）\n  - 西红柿被用在多道菜中（共享模块）\n\n为什么需要两个？\n  因为&quot;食材清单&quot;和&quot;出菜计划&quot;是两回事：\n  - 食材清单关注&quot;有什么&quot;\n  - 出菜计划关注&quot;怎么做&quot;\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br></div></div><hr><h3 id="_4-rollup-tree-shaking" tabindex="-1"><a class="header-anchor" href="#_4-rollup-tree-shaking" aria-hidden="true">#</a> 4. Rollup Tree-shaking</h3><p>Rollup 的 tree-shaking 为什么通常比 Webpack 更&quot;干净&quot;？需要满足哪些条件才能有效 tree-shake？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Rollup tree-shaking 更干净的原因：\n\n原因1：输出格式不同\n\n【Webpack 输出（IIFE 包裹）】\n// webpack bundle\n(function(modules) {\n  var installedModules = {};\n  function __webpack_require__(moduleId) {\n    // ...模块加载逻辑\n  }\n  return __webpack_require__(0);\n})([\n  /* 0: index.js */\n  function(module, exports, __webpack_require__) {\n    const { add } = __webpack_require__(1);\n    console.log(add(1, 2));\n  },\n  /* 1: utils.js */\n  function(module, exports) {\n    exports.add = (a, b) =&gt; a + b;\n    exports.subtract = (a, b) =&gt; a - b;  // 未使用但仍在\n  }\n]);\n\n问题：\n- 每个模块被函数包裹，难以静态分析\n- 运行时加载机制增加了代码量\n- 即使 tree-shaking，也会留下模块骨架\n\n【Rollup 输出（扁平化）】\n// rollup bundle\nconst add = (a, b) =&gt; a + b;\n// subtract 直接被删除，干干净净\n\nconsole.log(add(1, 2));\n\n优势：\n- 直接输出 ES6 代码，无运行时包裹\n- 所有模块被&quot;拍平&quot;到一个作用域\n- 未使用的导出直接不存在\n\n原因2：Scope Hoisting（作用域提升）\n\nWebpack (不开启 scope hoisting):\n// 模块1\nfunction module1() {\n  const name = &#39;webpack&#39;;\n  return name;\n}\n// 模块2\nfunction module2() {\n  const result = module1();\n  console.log(result);\n}\n\nRollup (默认提升):\n// 所有代码在同一作用域\nconst name = &#39;webpack&#39;;\nconst result = name;\nconsole.log(result);\n\n效果对比：\n- Webpack: 保留模块边界 → 体积大\n- Rollup: 消除模块边界 → 体积小\n\n原因3：设计目标不同\n\nWebpack:\n- 设计目标：应用打包器（Application Bundler）\n- 需要支持：\n  ✓ CommonJS 和 ES6 混用\n  ✓ 代码分割\n  ✓ 动态加载 import()\n  ✓ HMR 热更新\n  ✓ 复杂的 loader/plugin 生态\n- 代价：为了兼容性和功能，牺牲了一定的 tree-shaking 效果\n\nRollup:\n- 设计目标：库打包器（Library Bundler）\n- 专注于：\n  ✓ 纯 ES6 模块\n  ✓ 静态分析\n  ✓ 最小化输出\n  ✓ 适合打包组件库、工具库\n- 优势：专注导致 tree-shaking 更彻底\n\n原因4：副作用处理更严格\n\n示例代码：\n// utils.js\nexport const add = (a, b) =&gt; a + b;\nconsole.log(&#39;utils loaded&#39;);  // 副作用\n\n// index.js\nimport { add } from &#39;./utils&#39;;\n\nWebpack:\n- 保守策略：有 console.log，保留整个模块\n- 除非在 package.json 中明确标记 &quot;sideEffects&quot;: false\n\nRollup:\n- 更激进：分析代码，只保留必要的副作用\n- 默认假设 ES6 模块无副作用\n\n原因5：Dead Code Elimination 更彻底\n\n示例：\n// math.js\nexport const add = (a, b) =&gt; a + b;\nexport const complex = (x) =&gt; {\n  const temp = x * 2;\n  const result = temp + 10;\n  return result;\n};\n\n// index.js\nimport { add } from &#39;./math&#39;;\nconsole.log(add(1, 2));\n// complex 未使用\n\nWebpack 输出：\n// 可能保留 complex 的定义（取决于配置）\nconst add = (a, b) =&gt; a + b;\nconst complex = (x) =&gt; { /* ... */ };  // ❌ 仍然存在\n\nRollup 输出：\nconst add = (a, b) =&gt; a + b;  // ✅ 只有 add\n\nconsole.log(add(1, 2));\n\n原因6：对循环依赖的处理\n\nWebpack:\n// a.js\nimport { b } from &#39;./b&#39;;\nexport const a = &#39;a&#39; + b;\n\n// b.js\nimport { a } from &#39;./a&#39;;\nexport const b = &#39;b&#39;;\n\nWebpack 需要运行时处理循环依赖 → 增加代码\n\nRollup:\n- 静态分析时就会报错或警告\n- 强制开发者解决循环依赖\n- 输出更可预测\n\n原因7：配置默认值不同\n\nWebpack (需要手动配置):\noptimization: {\n  usedExports: true,        // 标记未使用的导出\n  minimize: true,            // 压缩代码\n  sideEffects: true,         // 考虑副作用\n  concatenateModules: true   // scope hoisting (production 默认)\n}\n\nRollup (默认开启):\n// 默认就是最优的 tree-shaking\n// 无需额外配置\n\n对比示例：\n\n源代码：\n// utils.js\nexport const add = (a, b) =&gt; a + b;\nexport const subtract = (a, b) =&gt; a - b;\nexport const multiply = (a, b) =&gt; a * b;\nexport const divide = (a, b) =&gt; a / b;\n\n// index.js\nimport { add } from &#39;./utils&#39;;\nconsole.log(add(1, 2));\n\n【Webpack 输出（production mode）】\n// ... webpack runtime code ...\nconst add = (a, b) =&gt; a + b;\n// ✅ subtract, multiply, divide 被删除\n// ❌ 但有 webpack 运行时代码（~200 bytes）\n\n【Rollup 输出】\nconst add = (a, b) =&gt; a + b;\nconsole.log(add(1, 2));\n// ✅ 完全干净，只有必要代码\n\n体积对比：\n- Webpack: ~250 bytes\n- Rollup: ~50 bytes\n\n有效 tree-shake 的条件：\n\n条件1：使用 ES6 模块（ESM）\n\n✅ 可以 tree-shake:\n// ESM - 静态导入导出\nexport const add = (a, b) =&gt; a + b;\nimport { add } from &#39;./math&#39;;\n\n❌ 不能 tree-shake:\n// CommonJS - 动态导入导出\nmodule.exports.add = (a, b) =&gt; a + b;\nconst { add } = require(&#39;./math&#39;);\n\n原因：\n- ESM: 编译时确定依赖关系（静态）\n- CommonJS: 运行时确定依赖关系（动态）\n\n反例：\n// 动态导出 - 无法 tree-shake\nconst funcs = { add, subtract };\nmodule.exports = funcs[condition ? &#39;add&#39; : &#39;subtract&#39;];\n\n条件2：避免副作用（Side Effects）\n\n✅ 无副作用:\n// pure 函数\nexport const add = (a, b) =&gt; a + b;\n\n❌ 有副作用（会被保留）:\nexport const add = (a, b) =&gt; a + b;\nconsole.log(&#39;math module loaded&#39;);  // 副作用\nwindow.mathLoaded = true;            // 副作用\ndocument.title = &#39;App&#39;;              // 副作用\n\n解决方法：\n1. 在 package.json 中声明\n{\n  &quot;sideEffects&quot;: false  // 所有文件无副作用\n}\n\n或\n\n{\n  &quot;sideEffects&quot;: [\n    &quot;*.css&quot;,        // CSS 文件有副作用\n    &quot;src/polyfills.js&quot;\n  ]\n}\n\n2. 使用 /*#__PURE__*/ 注释\nconst result = /*#__PURE__*/ complexCalculation();\nexport default result;\n// 告诉打包器：这个函数调用无副作用\n\n条件3：避免默认导出对象\n\n❌ 难以 tree-shake:\n// utils.js\nexport default {\n  add: (a, b) =&gt; a + b,\n  subtract: (a, b) =&gt; a - b\n};\n\n// index.js\nimport utils from &#39;./utils&#39;;\nconsole.log(utils.add(1, 2));\n// 问题：整个对象都会被打包\n\n✅ 易于 tree-shake:\n// utils.js\nexport const add = (a, b) =&gt; a + b;\nexport const subtract = (a, b) =&gt; a - b;\n\n// index.js\nimport { add } from &#39;./utils&#39;;\nconsole.log(add(1, 2));\n// ✅ 只有 add 被打包\n\n条件4：避免在导入时执行代码\n\n❌ 会阻止 tree-shake:\n// config.js\nconst config = {\n  api: process__.env.API_URL\n};\nexport default config;\n\n// 导入时就会执行\nimport config from &#39;./config&#39;;\n\n✅ 推迟执行:\n// config.js\nexport const getConfig = () =&gt; ({\n  api: process__.env.API_URL\n});\n\n// 需要时才调用\nimport { getConfig } from &#39;./config&#39;;\nconst config = getConfig();\n\n条件5：类的使用要注意\n\n❌ 类方法难以 tree-shake:\nclass Utils {\n  add(a, b) { return a + b; }\n  subtract(a, b) { return a - b; }\n  multiply(a, b) { return a * b; }\n}\nexport default new Utils();\n\n// 使用\nimport utils from &#39;./utils&#39;;\nutils.add(1, 2);\n// 问题：整个类实例都会被打包\n\n✅ 分离导出:\nexport const add = (a, b) =&gt; a + b;\nexport const subtract = (a, b) =&gt; a - b;\nexport const multiply = (a, b) =&gt; a * b;\n\n条件6：正确配置 Babel\n\n❌ Babel 转换破坏 ESM:\n// .babelrc (错误配置)\n{\n  &quot;presets&quot;: [\n    [&quot;@babel/preset-env&quot;, {\n      &quot;modules&quot;: &quot;commonjs&quot;  // ❌ 转成 CommonJS\n    }]\n  ]\n}\n\n✅ 保留 ESM:\n{\n  &quot;presets&quot;: [\n    [&quot;@babel/preset-env&quot;, {\n      &quot;modules&quot;: false  // ✅ 保留 ES6 模块\n    }]\n  ]\n}\n\n条件7：避免动态导入路径\n\n❌ 动态路径:\nconst moduleName = condition ? &#39;a&#39; : &#39;b&#39;;\nimport(`./${moduleName}.js`);  // 无法静态分析\n\n✅ 静态路径:\nif (condition) {\n  import(&#39;./a.js&#39;);\n} else {\n  import(&#39;./b.js&#39;);\n}\n\n条件8：使用支持 tree-shaking 的库\n\n❌ 不支持:\nimport _ from &#39;lodash&#39;;  // 整个 lodash (~70KB)\n_.add(1, 2);\n\n✅ 支持:\nimport add from &#39;lodash-es/add&#39;;  // 只导入需要的\nadd(1, 2);\n\n或使用插件：\nimport { add } from &#39;lodash&#39;;  // 配合 babel-plugin-lodash\n\n【验证 tree-shaking 效果】\n\n方法1：分析产物\n// package.json\n{\n  &quot;scripts&quot;: {\n    &quot;build&quot;: &quot;webpack --mode production&quot;,\n    &quot;analyze&quot;: &quot;webpack-bundle-analyzer dist/stats.json&quot;\n  }\n}\n\n方法2：查看未使用的导出\n// webpack.config.js\noptimization: {\n  usedExports: true\n}\n\n// 构建后查看警告信息\n\n方法3：对比体积\n// 记录优化前后的 bundle 大小\n\n【最佳实践总结】\n\n1. ✅ 使用 ES6 模块，不用 CommonJS\n2. ✅ 命名导出优于默认导出\n3. ✅ 在 package.json 声明 sideEffects\n4. ✅ Babel 配置保留 ES6 模块\n5. ✅ 使用支持 tree-shaking 的库\n6. ✅ 避免在模块顶层执行副作用代码\n7. ✅ 优先使用 Rollup 打包库，Webpack 打包应用\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br></div></div><hr><h3 id="_5-vite-为什么快" tabindex="-1"><a class="header-anchor" href="#_5-vite-为什么快" aria-hidden="true">#</a> 5. Vite 为什么快</h3><p>Vite dev 为什么快？请从三个层面分析：请求、编译、缓存/预构建。</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>请求层面：\n\n核心：按需加载，利用浏览器原生 ESM\n\n1. No Bundle 开发模式\n\n   Webpack 开发流程：\n   启动开发服务器\n     ↓\n   分析所有模块 (5000+ 文件)\n     ↓\n   打包所有文件\n     ↓\n   生成 bundle\n     ↓\n   启动完成 (20-30秒)  ← 慢！\n     ↓\n   访问 localhost:3000\n     ↓\n   返回 bundle.js (几 MB)\n\n   Vite 开发流程：\n   启动开发服务器\n     ↓\n   预构建依赖 (node_modules)\n     ↓\n   启动完成 (200-300ms)  ← 快！\n     ↓\n   访问 localhost:5173\n     ↓\n   浏览器请求 index.html\n     ↓\n   解析 `\\&lt;script type=&quot;module&quot; src=&quot;/src/main.js&quot;\\&gt;`\n     ↓\n   按需编译 main.js → 返回\n     ↓\n   浏览器解析 main.js 中的 import\n     ↓\n   按需编译依赖模块 → 返回\n     ↓\n   逐步加载，快速响应\n\n2. 浏览器原生 ESM\n\n   Vite 输出：\n\n  &lt;!-- index.html --&gt;\n  &lt;script type=&quot;module&quot; src=&quot;/src/main.js&quot;&gt;&lt;/script&gt;\n\n  // main.js (Vite 处理后)\n  import { createApp } from &#39;/node_modules/.vite/deps/vue.js?v=abc123&#39;\n  import App from &#39;/src/App.vue&#39; // 浏览器原生支持\n\n  createApp(App).mount(&#39;#app&#39;)\n\n   优势：\n   ✅ 不需要打包，浏览器直接加载 ES6 模块\n   ✅ 每个文件都是独立的 HTTP 请求\n   ✅ 强缓存：304 Not Modified\n   ✅ 并行加载，充分利用 HTTP/2\n\n3. 精确的依赖图\n\n   只编译访问到的文件：\n\n   App.vue\n     ↓ 浏览器请求\n   Vite 编译 App.vue → 返回 (10ms)\n     ↓ 发现 import Header\n   Vite 编译 Header.vue → 返回 (5ms)\n     ↓ 发现 import Button\n   Vite 编译 Button.vue → 返回 (3ms)\n\n   未访问的路由组件：完全不编译 ✅\n\n   对比 Webpack：\n   - 启动时编译所有文件（包括未使用的）\n   - 即使开启 lazy loading，也要分析依赖\n\n4. 请求拦截和转换\n\n   浏览器请求：\n   GET /src/App.vue\n\n   Vite Dev Server 中间件：\n   ┌────────────────────────────────┐\n   │ 1. 读取 App.vue                │\n   │ 2. Vue SFC 编译器处理          │\n   │ 3. 转换 import 路径             │\n   │ 4. 注入 HMR 代码                │\n   │ 5. 返回 JavaScript             │\n   └────────────────────────────────┘\n\n   返回：\n   import { render } from &#39;/src/App.vue?type=template&#39;;\n   import script from &#39;/src/App.vue?type=script&#39;;\n   script.render = render;\n   export default script;\n\n   特点：\n   - 实时编译：只在请求时编译\n   - 增量编译：修改一个文件，只重新编译这个文件\n   - 快速响应：单文件编译耗时 &lt; 10ms\n\n编译层面：\n\n核心：esbuild 预构建 + 原生 ESM\n\n1. esbuild 极速编译\n\n   速度对比：\n   Webpack (Babel):\n     10000 个文件 → 20-30 秒\n\n   Vite (esbuild):\n     10000 个文件 → 1-2 秒\n\n   快 10-100 倍！\n\n   原因：\n   ✅ Go 语言编写（接近机器码）\n      vs Babel 的 JavaScript（解释执行）\n\n   ✅ 高度并行化\n      充分利用多核 CPU\n\n   ✅ 零拷贝优化\n      直接操作内存，减少解析开销\n\n   ✅ 增量编译\n      只重新编译修改的部分\n\n2. 依赖预构建（Pre-bundling）\n\n   为什么需要预构建：\n\n   问题1：CommonJS 转 ESM\n   // lodash (CommonJS)\n   module.exports = { ... }\n\n   // 浏览器不支持 require\n   const _ = require(&#39;lodash&#39;);  // ❌ 报错\n\n   解决：esbuild 将 node_modules 中的 CommonJS 转为 ESM\n   import _ from &#39;/node_modules/.vite/deps/lodash.js&#39;;  // ✅\n\n   问题2：减少 HTTP 请求\n   // lodash-es 有 600+ 个模块\n   import debounce from &#39;lodash-es/debounce&#39;;\n   // 会导致 600+ 个 HTTP 请求 ❌\n\n   解决：esbuild 将 lodash-es 打包成一个文件\n   import { debounce } from &#39;/node_modules/.vite/deps/lodash-es.js&#39;;\n   // 只有 1 个请求 ✅\n\n   预构建流程：\n   首次启动 Vite\n     ↓\n   扫描 import 语句，发现依赖\n     ↓\n   esbuild 打包 node_modules\n     ↓\n   生成 .vite/deps/\n     ↓\n   添加强缓存 (max-age=31536000)\n\n3. 单文件编译\n\n   Vite 编译流程：\n\n   请求 /src/App.vue\n     ↓\n   读取文件内容\n     ↓\n   根据文件类型选择编译器：\n     - .vue → @vitejs/plugin-vue\n     - .jsx → esbuild\n     - .ts → esbuild\n     - .css → postcss\n     ↓\n   编译单个文件 (&lt; 10ms)\n     ↓\n   返回结果 + 缓存\n\n   对比 Webpack：\n   Webpack: 打包整个 bundle → 修改一行代码 → 重新打包 (1-5s)\n   Vite: 编译单个文件 → 修改一行代码 → 只重新编译这个文件 (10ms)\n\n4. 智能代码分割\n\n   Vite 自动按路由分割：\n\n   // router.js\n   const Home = () =&gt; import(&#39;./Home.vue&#39;);\n   const About = () =&gt; import(&#39;./About.vue&#39;);\n\n   编译结果：\n   - 访问 /home → 只加载 Home.vue 及其依赖\n   - 访问 /about → 只加载 About.vue 及其依赖\n\n   动态加载：\n   GET /src/views/Home.vue\n   GET /src/components/HomeHeader.vue\n\n   未访问 About，完全不请求 ✅\n\n5. TypeScript 编译\n\n   esbuild 编译 TS：\n   - 只做类型擦除（Type Stripping）\n   - 不做类型检查（可选的，通过 vue-tsc）\n   - 速度极快：10x faster than tsc\n\n   // tsconfig.json\n   {\n     &quot;compilerOptions&quot;: {\n       &quot;isolatedModules&quot;: true  // esbuild 要求\n     }\n   }\n\n缓存/预构建层面：\n\n核心：多层缓存 + 智能失效\n\n1. HTTP 强缓存\n\n   依赖模块（node_modules）：\n   GET /node_modules/.vite/deps/vue.js?v=abc123\n   Response Headers:\n     Cache-Control: max-age=31536000, immutable\n\n   一年强缓存！304 Not Modified\n\n   源码模块：\n   GET /src/App.vue?t=1234567890\n   Response Headers:\n     Cache-Control: no-cache\n     ETag: &quot;abc123&quot;\n\n   协商缓存，确保最新\n\n2. 文件系统缓存\n\n   预构建缓存位置：\n   node_modules/.vite/deps/\n     ├── vue.js              (预构建的依赖)\n     ├── vue.js.map\n     ├── _metadata.json      (依赖图元数据)\n     └── package.json\n\n   缓存失效条件：\n   ✅ package.json 中的依赖版本变化\n   ✅ 包管理器的 lockfile 变化\n   ✅ vite.config.js 中的相关配置变化\n   ✅ NODE_ENV 环境变量变化\n\n   只有这些变化时才重新预构建，否则直接使用缓存 ✅\n\n3. 内存缓存\n\n   Vite 内部缓存：\n   const moduleCache = new Map();\n\n   function transformModule(url) {\n     if (moduleCache.has(url)) {\n       return moduleCache.get(url);  // 命中缓存 ✅\n     }\n\n     const result = compile(url);\n     moduleCache.set(url, result);\n     return result;\n   }\n\n   HMR 更新时：\n   - 只清除修改文件的缓存\n   - 其他文件继续使用内存缓存\n\n4. 依赖预扫描（Dependency Pre-Scanning）\n\n   首次启动优化：\n\n   传统方式：\n   启动服务器 → 访问页面 → 发现依赖 → 预构建 → 刷新页面\n\n   Vite 优化：\n   启动服务器 → 同时扫描入口文件 → 提前预构建 → 访问页面时已就绪\n\n   扫描逻辑：\n   1. 分析 index.html 中的 `&lt;script type=&quot;module&quot;&gt;`\n   2. esbuild 快速扫描，收集 import\n   3. 并行预构建所有依赖\n   4. 在用户访问前完成（冷启动优化）\n\n5. 智能失效和重新验证\n\n   监听文件变化：\n   chokidar.watch(&#39;src/**/*&#39;).on(&#39;change&#39;, (path) =&gt; {\n     // 只清除相关缓存\n     invalidateModule(path);\n\n     // HMR 更新\n     hmr.send({\n       type: &#39;update&#39;,\n       path,\n       timestamp: Date.now()\n     });\n   });\n   精准失效：\n   修改 App.vue\n     ↓\n   只清除 App.vue 的缓存\n     ↓\n   依赖 App.vue 的模块接收 HMR 更新\n     ↓\n   其他模块缓存仍然有效 ✅\n\n6. 预构建优化检测\n\n   自动检测缺失的依赖：\n\n   访问页面 → 发现新的 import → 运行时预构建\n\n   // 首次没有导入 axios\n   // 后来添加：\n   import axios from &#39;axios&#39;;\n\n   Vite 自动：\n   1. 检测到新依赖\n   2. 立即预构建 axios\n   3. 刷新页面（自动）\n   4. 使用预构建的 axios\n\n【速度对比实例】\n\n场景：大型 Vue3 项目（5000+ 组件）\n\n冷启动：\nWebpack dev server:\n  - 分析模块：15s\n  - 打包构建：25s\n  - 总计：40s ❌\n\nVite dev server:\n  - 预构建依赖：2s\n  - 启动服务器：0.3s\n  - 总计：2.3s ✅\n\n  快 17 倍！\n\n热更新：\n修改一个组件：\n\nWebpack HMR:\n  - 重新打包相关模块：1-3s\n  - 浏览器更新：0.5s\n  - 总计：1.5-3.5s\n\nVite HMR:\n  - 重新编译单个文件：10ms\n  - 浏览器更新：50ms\n  - 总计：60ms ✅\n\n  快 25-60 倍！\n\n【Vite 快的本质总结】\n\n1. 架构创新：\n   ❌ Webpack: Bundle-based（先打包再服务）\n   ✅ Vite: Native ESM-based（按需编译）\n\n2. 工具选择：\n   ❌ Webpack: Babel/Terser (JavaScript)\n   ✅ Vite: esbuild (Go) + Rollup (生产)\n\n3. 编译策略：\n   ❌ Webpack: 全量编译\n   ✅ Vite: 增量编译 + 按需编译\n\n4. 缓存利用：\n   ❌ Webpack: 内存缓存为主\n   ✅ Vite: HTTP 缓存 + 文件缓存 + 内存缓存\n\n5. 浏览器能力：\n   ❌ Webpack: 不依赖浏览器 ESM\n   ✅ Vite: 充分利用现代浏览器特性\n\n【权衡和限制】\n\nVite 的限制：\n1. 需要现代浏览器支持 ESM（IE11 需要额外配置）\n2. 首次访问路由时需要编译（按需加载的代价）\n3. 生产环境仍需打包（使用 Rollup）\n\nWebpack 的优势：\n1. 生态更成熟，plugin 更丰富\n2. 兼容性更好（支持老浏览器）\n3. 适合复杂的构建需求\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br></div></div><hr><h3 id="_6-webpack-hmr-原理" tabindex="-1"><a class="header-anchor" href="#_6-webpack-hmr-原理" aria-hidden="true">#</a> 6. Webpack HMR 原理</h3><p>解释 Webpack HMR 的基本原理，包括：hash、manifest、module.hot API、更新边界的概念。</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Hash 的作用：\n\n1. 唯一标识每次构建\n   每次编译都会生成新的 hash 值：\n\n   第一次编译：\n   Hash: abc123\n   main.abc123.js\n\n   修改代码后：\n   Hash: def456\n   main.def456.js\n\n2. 文件版本控制\n   不同类型的 hash：\n\n   【hash】- 整个项目的 hash\n   output: {\n     filename: &#39;[name].[hash].js&#39;\n   }\n   所有文件共享同一个 hash，任何文件改变都会导致所有文件 hash 变化\n\n   【chunkhash】- 每个 chunk 的 hash\n   output: {\n     filename: &#39;[name].[chunkhash].js&#39;\n   }\n   基于 chunk 内容生成，只有该 chunk 变化时才改变\n   适用于代码分割场景\n\n   【contenthash】- 文件内容的 hash\n   output: {\n     filename: &#39;[name].[contenthash].js&#39;\n   }\n   基于文件内容生成，最精准的缓存控制\n   适用于 CSS 等资源文件\n\n3. HMR 中的 hash 作用\n\n   浏览器端：\n   当前 hash: abc123\n\n   Webpack Dev Server 推送：\n   {\n     type: &#39;hash&#39;,\n     data: &#39;def456&#39;  // 新的 hash\n   }\n\n   浏览器更新：\n   currentHash = &#39;def456&#39;;\n\n   用途：\n   - 标识构建版本\n   - 请求更新资源时作为参数\n   - 避免缓存问题\n\nManifest 是什么：\n\n1. 定义\n   Manifest 是描述模块更新信息的 JSON 文件\n   记录了哪些模块发生了变化\n\n2. 结构示例\n\n   // hot-update.json (manifest)\n   {\n     &quot;h&quot;: &quot;def456&quot;,           // 新的 hash\n     &quot;c&quot;: {                   // changed modules\n       &quot;main&quot;: true           // main chunk 有更新\n     }\n   }\n\n   浏览器收到后，知道需要请求：\n   main.def456.hot-update.js  // 具体的更新模块\n\n3. 更新模块文件\n\n   // main.def456.hot-update.js\n   self[&quot;webpackHotUpdate&quot;](&quot;main&quot;, {\n     &quot;./src/App.js&quot;: (function(module, exports, __webpack_require__) {\n       // 更新后的 App.js 代码\n       const App = () =&gt; {\n         return &lt;div&gt;Updated!&lt;/div&gt;;\n       };\n       module.exports = App;\n     })\n   });\n\n4. Manifest 的作用\n\n   流程：\n   1. 文件变化 → Webpack 重新编译\n   2. 生成新的 hash: def456\n   3. 生成 manifest: def456.hot-update.json\n   4. 生成更新模块: main.def456.hot-update.js\n   5. 通过 WebSocket 推送 hash\n   6. 浏览器请求 manifest\n   7. 浏览器根据 manifest 请求更新的模块\n   8. 应用更新\n\nmodule.hot API：\n\n1. 基本 API\n\n   【module.hot.accept】\n   接受模块更新，定义如何处理更新\n\n   // App.js\n   if (module.hot) {\n     module.hot.accept(&#39;./Button.js&#39;, function() {\n       // Button.js 更新时的回调\n       console.log(&#39;Button updated!&#39;);\n       // 可以在这里重新渲染\n     });\n   }\n\n   无参数形式（接受自身更新）：\n   if (module.hot) {\n     module.hot.accept(err =&gt; {\n       if (err) {\n         console.error(&#39;HMR 更新失败&#39;, err);\n       }\n     });\n   }\n\n   【module.hot.decline】\n   拒绝模块更新，触发完整刷新\n\n   if (module.hot) {\n     module.hot.decline(&#39;./config.js&#39;);\n     // config.js 更新时，强制刷新页面\n   }\n\n   【module.hot.dispose】\n   模块被替换前的清理函数\n\n   if (module.hot) {\n     module.hot.dispose(function(data) {\n       // 保存状态，供新模块使用\n       data.count = currentCount;\n\n       // 清理副作用\n       clearInterval(timer);\n       removeEventListener(&#39;click&#39;, handler);\n     });\n   }\n\n   【module.hot.status】\n   获取 HMR 状态\n\n   console.log(module.hot.status());\n   // &#39;idle&#39; - 等待中\n   // &#39;check&#39; - 检查更新\n   // &#39;prepare&#39; - 准备更新\n   // &#39;ready&#39; - 更新已下载\n   // &#39;dispose&#39; - 清理旧模块\n   // &#39;apply&#39; - 应用更新\n   // &#39;abort&#39; - 更新中止\n   // &#39;fail&#39; - 更新失败\n\n2. 实际使用示例\n\n   【React 组件 HMR】\n   // App.jsx\n   import React from &#39;react&#39;;\n   import { render } from &#39;react-dom&#39;;\n   import Root from &#39;./Root&#39;;\n\n   const rootEl = document.getElementById(&#39;root&#39;);\n   render(&lt;Root /&gt;, rootEl);\n\n   if (module.hot) {\n     module.hot.accept(&#39;./Root&#39;, () =&gt; {\n       // Root 组件更新时，重新渲染\n       const NextRoot = require(&#39;./Root&#39;).default;\n       render(&lt;NextRoot /&gt;, rootEl);\n     });\n   }\n\n   【Vue 组件 HMR】\n   // main.js\n   import { createApp } from &#39;vue&#39;;\n   import App from &#39;./App.vue&#39;;\n\n   const app = createApp(App);\n   app.mount(&#39;#app&#39;);\n\n   if (module.hot) {\n     module.hot.accept(&#39;./App.vue&#39;, () =&gt; {\n       const NewApp = require(&#39;./App.vue&#39;).default;\n       app.unmount();\n       createApp(NewApp).mount(&#39;#app&#39;);\n     });\n   }\n\n   【状态保持示例】\n   let count = 0;\n\n   function increment() {\n     count++;\n     render();\n   }\n\n   if (module.hot) {\n     // 保存状态\n     module.hot.dispose(data =&gt; {\n       data.count = count;\n     });\n\n     // 恢复状态\n     if (module.hot.data) {\n       count = module.hot.data.count || 0;\n     }\n\n     // 接受更新\n     module.hot.accept();\n   }\n\n3. Loader 集成 HMR\n\n   【style-loader】\n   自动支持 CSS HMR：\n\n   // style-loader 内部实现（简化）\n   if (module.hot) {\n     module.hot.accept();\n     module.hot.dispose(() =&gt; {\n       // 移除旧样式\n       removeStyle();\n     });\n     // 应用新样式\n     insertStyle(newCss);\n   }\n\n   【vue-loader】\n   自动注入 HMR 代码：\n\n   // vue-loader 处理后\n   import script from &#39;./App.vue?vue&amp;type=script&#39;;\n   import render from &#39;./App.vue?vue&amp;type=template&#39;;\n\n   if (module.hot) {\n     module.hot.accept(&#39;./App.vue?vue&amp;type=template&#39;, () =&gt; {\n       __VUE_HMR_RUNTIME__.rerender(id, render);\n     });\n   }\n\n更新边界：\n\n1. 概念\n   更新边界是指能够接受（accept）模块更新的位置\n   如果一个模块没有定义如何接受更新，更新会向上冒泡\n\n2. 冒泡机制\n\n   模块依赖链：\n   index.js → App.js → Button.js → utils.js\n\n   场景1：Button.js 接受更新\n   utils.js 修改\n     ↓\n   查找 utils.js 的 module.hot.accept\n     ✅ 找到！更新边界在 utils.js\n     ↓\n   只更新 utils.js，不影响上层\n\n   场景2：Button.js 不接受更新\n   utils.js 修改\n     ↓\n   utils.js 没有 accept\n     ↓\n   向上冒泡到 Button.js\n     ↓\n   Button.js 有 accept\n     ✅ 更新边界在 Button.js\n     ↓\n   重新执行 Button.js 及其依赖\n\n   场景3：所有模块都不接受\n   utils.js 修改\n     ↓\n   一路冒泡到 index.js\n     ↓\n   index.js 也没有 accept\n     ❌ 触发完整页面刷新（fallback）\n\n3. 更新边界示例\n\n   【合理的边界】\n   // index.js (入口)\n   import App from &#39;./App&#39;;\n\n   render(App);\n\n   if (module.hot) {\n     module.hot.accept(&#39;./App&#39;, () =&gt; {\n       // App 或其子组件更新时，重新渲染\n       render(require(&#39;./App&#39;).default);\n     });\n   }\n\n   这样，App 及其所有子组件的更新都会在这里处理 ✅\n\n   【过细的边界】\n   // 每个组件都定义 accept\n   // Button.js\n   if (module.hot) {\n     module.hot.accept();\n   }\n\n   // Header.js\n   if (module.hot) {\n     module.hot.accept();\n   }\n\n   问题：代码冗余，维护困难 ❌\n\n   【无边界】\n   // 所有模块都没有 module.hot.accept\n   结果：任何修改都会刷新页面 ❌\n\n4. 更新边界最佳实践\n\n   ✅ 在框架入口设置边界（React/Vue）\n   ✅ CSS 由 loader 自动处理\n   ✅ 业务代码无需手动添加\n   ✅ 使用框架提供的 HMR 插件\n\n   示例配置：\n   // webpack.config.js\n   plugins: [\n     new ReactRefreshWebpackPlugin(),  // React 自动 HMR\n   ]\n\n完整流程：\n\n1. 启动阶段\n\n   Webpack Dev Server 启动\n     ↓\n   构建项目，生成 hash: abc123\n     ↓\n   启动 WebSocket 服务器（默认端口 ws://localhost:8080）\n     ↓\n   浏览器访问页面\n     ↓\n   注入 HMR Runtime 代码：\n     - WebSocket 客户端\n     - module.hot API 实现\n     - 更新应用逻辑\n     ↓\n   建立 WebSocket 连接\n     ↓\n   浏览器端存储当前 hash: abc123\n\n2. 文件修改阶段\n\n   开发者修改 Button.js\n     ↓\n   Webpack 监听到文件变化（chokidar）\n     ↓\n   触发重新编译（增量编译）\n     ↓\n   只编译变化的模块及其依赖\n     ↓\n   生成新的 hash: def456\n     ↓\n   生成 manifest 文件：\n     - def456.hot-update.json (描述哪些 chunk 更新)\n     ↓\n   生成更新模块文件：\n     - main.def456.hot-update.js (具体的模块代码)\n\n3. 通知阶段\n\n   Webpack 编译完成\n     ↓\n   通过 WebSocket 推送消息给浏览器：\n\n   消息1：\n   {\n     type: &#39;hash&#39;,\n     data: &#39;def456&#39;  // 新的 hash\n   }\n\n   消息2：\n   {\n     type: &#39;ok&#39;  // 编译成功，可以更新\n   }\n\n4. 检查阶段（浏览器端）\n\n   浏览器收到消息\n     ↓\n   更新本地 hash: def456\n     ↓\n   调用 module.hot.check() 检查更新\n     ↓\n   请求 manifest 文件：\n   GET /abc123.hot-update.json\n\n   返回：\n   {\n     &quot;h&quot;: &quot;def456&quot;,\n     &quot;c&quot;: { &quot;main&quot;: true }\n   }\n     ↓\n   解析 manifest，知道 main chunk 有更新\n\n5. 下载阶段\n\n   请求更新的模块：\n   GET /main.def456.hot-update.js\n\n   返回：\n   webpackHotUpdate(&quot;main&quot;, {\n     &quot;./src/Button.js&quot;: function(module, exports, require) {\n       // 新的 Button.js 代码\n     }\n   });\n     ↓\n   更新模块被下载到浏览器\n\n6. 应用阶段\n\n   查找更新模块的依赖链\n     ↓\n   向上查找是否有 module.hot.accept\n     ↓\n   找到更新边界（如 App.js）\n     ↓\n   调用 dispose 回调（清理旧模块）\n     ↓\n   替换旧模块为新模块\n     ↓\n   调用 accept 回调（应用新模块）\n     ↓\n   重新执行模块代码\n     ↓\n   UI 更新，不刷新页面 ✅\n\n7. 失败处理\n\n   如果没找到更新边界\n     ↓\n   或者更新过程出错\n     ↓\n   自动降级：刷新页面\n     ↓\n   window.location.reload()\n\n【流程图总结】\n\nWebpack (编译) ←→ WebSocket Server ←→ Browser (HMR Runtime)\n\n编译端：\n  文件变化\n    ↓\n  增量编译\n    ↓\n  生成 hash\n    ↓\n  生成 manifest\n    ↓\n  生成 hot-update.js\n\n传输端（WebSocket）：\n  推送 hash 消息\n    ↓\n  推送 ok 消息\n\n浏览器端：\n  接收消息\n    ↓\n  请求 manifest\n    ↓\n  请求 hot-update.js\n    ↓\n  查找更新边界\n    ↓\n  应用更新\n    ↓\n  重新渲染\n\n【HMR vs 完整刷新对比】\n\n完整刷新：\n  修改代码 → 刷新页面 → 重新加载所有资源 → 丢失状态 → 体验差\n\nHMR：\n  修改代码 → 增量更新 → 只加载变化模块 → 保持状态 → 体验好\n\n示例：\n场景：表单填写到一半，修改样式\n\n完整刷新：\n  输入的数据全部丢失 ❌\n  需要重新填写\n\nHMR：\n  输入的数据保留 ✅\n  样式实时更新\n  继续填写表单\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br></div></div><hr><h2 id="面试题-4-题" tabindex="-1"><a class="header-anchor" href="#面试题-4-题" aria-hidden="true">#</a> 面试题（4 题）</h2><h3 id="_1-从-0-设计打包器" tabindex="-1"><a class="header-anchor" href="#_1-从-0-设计打包器" aria-hidden="true">#</a> 1. 从 0 设计打包器</h3><p>从 0 设计一个打包器，你会如何抽象&quot;模块解析、依赖图构建、产物生成&quot;这三个核心环节？需要考虑哪些扩展点？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>核心架构设计：\n\n┌─────────────────────────────────────────────────────────┐\n│                    Mini Bundler                         │\n├─────────────────────────────────────────────────────────┤\n│  1. 配置层 (Configuration)                              │\n│     - entry, output, plugins, loaders                  │\n│  2. 编译器 (Compiler)                                   │\n│     - 统筹整个构建流程                                  │\n│  3. 模块解析器 (Resolver)                               │\n│     - 路径解析、文件查找                                │\n│  4. 依赖图构建器 (Graph Builder)                        │\n│     - AST 解析、依赖收集                                │\n│  5. 转换器 (Transformer)                                │\n│     - Loader 链式调用                                   │\n│  6. 代码生成器 (Code Generator)                         │\n│     - 生成最终 bundle                                   │\n│  7. 插件系统 (Plugin System)                            │\n│     - 生命周期钩子                                      │\n└─────────────────────────────────────────────────────────┘\n\n一、模块解析（Module Resolution）\n\n1. 核心功能\n   输入：模块标识符（如 &#39;./utils&#39;, &#39;lodash&#39;, &#39;@/components/Button&#39;）\n   输出：绝对文件路径（如 &#39;/project/src/utils.js&#39;）\n\n2. 解析算法\n\n   class Resolver {\n     constructor(options) {\n       this.extensions = options.extensions || [&#39;.js&#39;, &#39;.json&#39;];\n       this.alias = options.alias || {};\n       this.modules = options.modules || [&#39;node_modules&#39;];\n     }\n\n     resolve(context, request) {\n       // 步骤1: 处理别名\n       const aliasedRequest = this.resolveAlias(request);\n\n       // 步骤2: 判断模块类型\n       if (this.isRelative(aliasedRequest)) {\n         // 相对路径：./utils\n         return this.resolveRelative(context, aliasedRequest);\n       } else if (this.isAbsolute(aliasedRequest)) {\n         // 绝对路径：/src/utils\n         return this.resolveAbsolute(aliasedRequest);\n       } else {\n         // 第三方包：lodash\n         return this.resolveNodeModules(context, aliasedRequest);\n       }\n     }\n\n     resolveAlias(request) {\n       // &#39;@/components&#39; → &#39;src/components&#39;\n       for (const [key, value] of Object.entries(this.alias)) {\n         if (request.startsWith(key)) {\n           return request.replace(key, value);\n         }\n       }\n       return request;\n     }\n\n     resolveRelative(context, request) {\n       const basePath = path.join(context, request);\n       return this.tryResolve(basePath);\n     }\n\n     tryResolve(basePath) {\n       // 尝试直接访问\n       if (fs.existsSync(basePath) &amp;&amp; fs.statSync(basePath).isFile()) {\n         return basePath;\n       }\n\n       // 尝试添加扩展名\n       for (const ext of this.extensions) {\n         const pathWithExt = basePath + ext;\n         if (fs.existsSync(pathWithExt)) {\n           return pathWithExt;\n         }\n       }\n\n       // 尝试 index 文件\n       for (const ext of this.extensions) {\n         const indexPath = path.join(basePath, `index${ext}`);\n         if (fs.existsSync(indexPath)) {\n           return indexPath;\n         }\n       }\n\n       throw new Error(`Cannot find module: ${basePath}`);\n     }\n\n     resolveNodeModules(context, request) {\n       // 从当前目录向上查找 node_modules\n       let dir = context;\n       while (true) {\n         const modulePath = path.join(dir, &#39;node_modules&#39;, request);\n\n         if (fs.existsSync(modulePath)) {\n           // 读取 package.json，查找 main 字段\n           const pkgPath = path.join(modulePath, &#39;package.json&#39;);\n           if (fs.existsSync(pkgPath)) {\n             const pkg = require(pkgPath);\n             const entry = pkg.main || &#39;index.js&#39;;\n             return path.join(modulePath, entry);\n           }\n           return this.tryResolve(modulePath);\n         }\n\n         const parent = path.dirname(dir);\n         if (parent === dir) break;  // 到达根目录\n         dir = parent;\n       }\n\n       throw new Error(`Cannot find module: ${request}`);\n     }\n   }\n\n3. 扩展点\n   - 自定义解析策略（resolvers）\n   - 文件系统抽象（支持虚拟文件系统）\n   - 缓存机制（避免重复解析）\n\n二、依赖图构建（Dependency Graph）\n\n1. 核心数据结构\n\n   class Module {\n     constructor(id, filePath, source) {\n       this.id = id;                    // 模块唯一标识\n       this.filePath = filePath;        // 文件路径\n       this.source = source;            // 原始代码\n       this.dependencies = [];          // 依赖的模块 ID\n       this.transformedSource = null;   // 转换后的代码\n       this.ast = null;                 // AST\n     }\n   }\n\n   class DependencyGraph {\n     constructor() {\n       this.modules = new Map();  // id → Module\n       this.entryId = null;\n     }\n\n     addModule(module) {\n       this.modules.set(module.id, module);\n     }\n\n     getModule(id) {\n       return this.modules.get(id);\n     }\n   }\n\n2. 构建算法（深度优先遍历）\n\n   class GraphBuilder {\n     constructor(resolver, transformer) {\n       this.resolver = resolver;\n       this.transformer = transformer;\n       this.graph = new DependencyGraph();\n       this.moduleId = 0;\n     }\n\n     build(entryPath) {\n       // 从入口开始递归构建\n       const entryId = this.createModule(entryPath, null);\n       this.graph.entryId = entryId;\n       return this.graph;\n     }\n\n     createModule(filePath, parentPath) {\n       // 检查是否已处理\n       const existingModule = this.findModuleByPath(filePath);\n       if (existingModule) {\n         return existingModule.id;\n       }\n\n       // 生成模块 ID\n       const id = this.moduleId++;\n\n       // 读取文件\n       const source = fs.readFileSync(filePath, &#39;utf-8&#39;);\n\n       // 创建模块\n       const module = new Module(id, filePath, source);\n       this.graph.addModule(module);\n\n       // 解析 AST\n       module.ast = this.parse(source);\n\n       // 收集依赖\n       const dependencies = this.collectDependencies(module.ast);\n\n       // 递归处理依赖\n       for (const dep of dependencies) {\n         const depPath = this.resolver.resolve(\n           path.dirname(filePath),\n           dep\n         );\n         const depId = this.createModule(depPath, filePath);\n         module.dependencies.push(depId);\n       }\n\n       // 转换代码\n       module.transformedSource = this.transformer.transform(\n         module.source,\n         module.filePath\n       );\n\n       return id;\n     }\n\n     parse(source) {\n       // 使用 Babel 或其他解析器生成 AST\n       const ast = require(&#39;@babel/parser&#39;).parse(source, {\n         sourceType: &#39;module&#39;,\n         plugins: [&#39;jsx&#39;, &#39;typescript&#39;]\n       });\n       return ast;\n     }\n\n     collectDependencies(ast) {\n       const dependencies = [];\n\n       // 遍历 AST，收集 import/require\n       require(&#39;@babel/traverse&#39;).default(ast, {\n         ImportDeclaration(path) {\n           // import xx from &#39;module&#39;\n           dependencies.push(path.node.source.value);\n         },\n         CallExpression(path) {\n           // require(&#39;module&#39;)\n           if (path.node.callee.name === &#39;require&#39;) {\n             const arg = path.node.arguments[0];\n             if (arg.type === &#39;StringLiteral&#39;) {\n               dependencies.push(arg.value);\n             }\n           }\n         }\n       });\n\n       return dependencies;\n     }\n\n     findModuleByPath(filePath) {\n       for (const module of this.graph.modules.values()) {\n         if (module.filePath === filePath) {\n           return module;\n         }\n       }\n       return null;\n     }\n   }\n\n3. 扩展点\n   - 循环依赖检测\n   - 动态 import 处理（代码分割）\n   - 多入口支持\n   - 依赖去重优化\n\n三、产物生成（Code Generation）\n\n1. 运行时模板\n\n   const bundleTemplate = `\n   (function(modules) {\n     // 模块缓存\n     const installedModules = {};\n\n     // require 函数实现\n     function __webpack_require__(moduleId) {\n       // 检查缓存\n       if (installedModules[moduleId]) {\n         return installedModules[moduleId].exports;\n       }\n\n       // 创建新模块\n       const module = installedModules[moduleId] = {\n         id: moduleId,\n         exports: {}\n       };\n\n       // 执行模块函数\n       modules[moduleId].call(\n         module.exports,\n         module,\n         module.exports,\n         __webpack_require__\n       );\n\n       return module.exports;\n     }\n\n     // 加载入口模块\n     return __webpack_require__(__ENTRY_ID__);\n   })({\n     __MODULES__\n   });\n   `;\n\n2. 代码生成器\n\n   class CodeGenerator {\n     constructor(graph) {\n       this.graph = graph;\n     }\n\n     generate() {\n       // 生成模块映射\n       const modulesCode = this.generateModules();\n\n       // 替换模板占位符\n       let bundle = bundleTemplate\n         .replace(&#39;__ENTRY_ID__&#39;, this.graph.entryId)\n         .replace(&#39;__MODULES__&#39;, modulesCode);\n\n       return bundle;\n     }\n\n     generateModules() {\n       const modules = [];\n\n       for (const [id, module] of this.graph.modules) {\n         // 转换依赖路径为模块 ID\n         let code = module.transformedSource;\n\n         for (const depId of module.dependencies) {\n           const depModule = this.graph.getModule(depId);\n           // 替换 import/require 路径为模块 ID\n           code = code.replace(\n             new RegExp(`[&#39;&quot;]${depModule.filePath}[&#39;&quot;]`, &#39;g&#39;),\n             depId\n           );\n         }\n\n         modules.push(`\n           ${id}: function(module, exports, require) {\n             ${code}\n           }\n         `);\n       }\n\n       return modules.join(&#39;,\\n&#39;);\n     }\n\n     // 生成 Source Map\n     generateSourceMap() {\n       // 使用 source-map 库生成映射\n       const map = new SourceMapGenerator();\n       // ... 添加映射信息\n       return map.toString();\n     }\n   }\n\n3. 扩展点\n   - 多种输出格式（UMD, ESM, CommonJS）\n   - Source Map 生成\n   - 代码分割（多个 chunk）\n   - 压缩和优化\n\n四、插件系统（Plugin System）\n\n1. 生命周期钩子\n\n   class Compiler {\n     constructor(options) {\n       this.options = options;\n       this.hooks = {\n         // 构建开始前\n         beforeRun: new SyncHook(),\n         // 构建开始\n         run: new SyncHook(),\n         // 编译开始\n         compile: new SyncHook(),\n         // 模块创建后\n         afterModule: new SyncHook([&#39;module&#39;]),\n         // 编译完成\n         afterCompile: new SyncHook([&#39;compilation&#39;]),\n         // 生成资源前\n         emit: new AsyncSeriesHook([&#39;compilation&#39;]),\n         // 生成资源后\n         afterEmit: new AsyncSeriesHook([&#39;compilation&#39;]),\n         // 完成\n         done: new SyncHook([&#39;stats&#39;])\n       };\n     }\n\n     run(callback) {\n       this.hooks.beforeRun.call();\n       this.hooks.run.call();\n\n       // 编译流程\n       this.compile((err, compilation) =&gt; {\n         if (err) return callback(err);\n\n         this.hooks.afterCompile.call(compilation);\n\n         // 生成文件\n         this.emitAssets(compilation, (err) =&gt; {\n           if (err) return callback(err);\n\n           this.hooks.done.call({ compilation });\n           callback(null, compilation);\n         });\n       });\n     }\n\n     compile(callback) {\n       this.hooks.compile.call();\n\n       // 创建 compilation 对象\n       const compilation = new Compilation(this);\n\n       // 构建依赖图\n       compilation.build();\n\n       callback(null, compilation);\n     }\n\n     emitAssets(compilation, callback) {\n       this.hooks.emit.callAsync(compilation, (err) =&gt; {\n         if (err) return callback(err);\n\n         // 写入文件\n         for (const [filename, content] of compilation.assets) {\n           fs.writeFileSync(\n             path.join(this.options.output.path, filename),\n             content\n           );\n         }\n\n         this.hooks.afterEmit.callAsync(compilation, callback);\n       });\n     }\n   }\n\n2. 插件接口\n\n   class MyPlugin {\n     apply(compiler) {\n       // 监听钩子\n       compiler.hooks.emit.tapAsync(&#39;MyPlugin&#39;, (compilation, callback) =&gt; {\n         // 修改产物\n         compilation.assets.set(&#39;extra.txt&#39;, &#39;Generated by MyPlugin&#39;);\n         callback();\n       });\n\n       compiler.hooks.afterModule.tap(&#39;MyPlugin&#39;, (module) =&gt; {\n         // 处理模块\n         console.log(&#39;Module created:&#39;, module.filePath);\n       });\n     }\n   }\n\n   // 使用\n   const compiler = new Compiler({\n     plugins: [new MyPlugin()]\n   });\n\n   // 注册插件\n   for (const plugin of compiler.options.plugins) {\n     plugin.apply(compiler);\n   }\n\n3. 扩展点\n   - 异步钩子（AsyncSeriesHook, AsyncParallelHook）\n   - 钩子拦截器（interceptors）\n   - 插件间通信机制\n\n五、Loader 系统\n\n1. Loader 接口\n\n   // babel-loader 示例\n   function babelLoader(source) {\n     // this 是 loader context\n     const options = this.getOptions();\n\n     // 转换代码\n     const result = babel.transform(source, options);\n\n     // 返回转换后的代码\n     return result.code;\n   }\n\n   // 异步 loader\n   function asyncLoader(source) {\n     const callback = this.async();\n\n     doAsyncWork(source, (err, result) =&gt; {\n       if (err) return callback(err);\n       callback(null, result);\n     });\n   }\n\n   // Pitch Loader\n   function pitchLoader(remainingRequest, precedingRequest, data) {\n     // pitch 阶段执行\n     // 可以中断 loader 链\n     if (shouldSkip()) {\n       return &#39;module.exports = &quot;skipped&quot;;&#39;;\n     }\n   }\n   pitchLoader.pitch = function() { /* ... */ };\n\n2. Loader 链式调用\n\n   class LoaderRunner {\n     runLoaders(loaders, resource, callback) {\n       let loaderIndex = loaders.length - 1;\n       let result = fs.readFileSync(resource, &#39;utf-8&#39;);\n\n       // 从右到左执行\n       while (loaderIndex &gt;= 0) {\n         const loader = loaders[loaderIndex];\n         const loaderContext = this.createContext(resource);\n\n         result = loader.call(loaderContext, result);\n         loaderIndex--;\n       }\n\n       callback(null, result);\n     }\n\n     createContext(resource) {\n       return {\n         resource,\n         async: function() {\n           // 返回异步回调\n         },\n         getOptions: function() {\n           // 获取 loader 配置\n         }\n       };\n     }\n   }\n\n六、完整示例\n\n// mini-bundler.js\nclass MiniBundler {\n  constructor(options) {\n    this.options = options;\n    this.compiler = new Compiler(options);\n  }\n\n  run() {\n    // 1. 模块解析\n    const resolver = new Resolver(this.options.resolve);\n\n    // 2. 代码转换\n    const transformer = new Transformer(this.options.module.rules);\n\n    // 3. 构建依赖图\n    const builder = new GraphBuilder(resolver, transformer);\n    const graph = builder.build(this.options.entry);\n\n    // 4. 生成代码\n    const generator = new CodeGenerator(graph);\n    const bundle = generator.generate();\n\n    // 5. 输出文件\n    fs.writeFileSync(\n      this.options.output.filename,\n      bundle\n    );\n  }\n}\n\n// 使用\nconst bundler = new MiniBundler({\n  entry: &#39;./src/index.js&#39;,\n  output: {\n    path: &#39;./dist&#39;,\n    filename: &#39;bundle.js&#39;\n  },\n  module: {\n    rules: [\n      { test: /\\.js$/, use: &#39;babel-loader&#39; }\n    ]\n  },\n  resolve: {\n    extensions: [&#39;.js&#39;, &#39;.json&#39;],\n    alias: {\n      &#39;@&#39;: &#39;./src&#39;\n    }\n  },\n  plugins: [\n    new MyPlugin()\n  ]\n});\n\nbundler.run();\n\n七、关键扩展点总结\n\n1. 模块解析扩展\n   - 自定义解析器（custom resolvers）\n   - 虚拟模块（virtual modules）\n   - 外部依赖（externals）\n\n2. 依赖图扩展\n   - 循环依赖处理\n   - 代码分割策略\n   - Tree Shaking 集成\n\n3. 代码生成扩展\n   - 多种输出格式\n   - Source Map 支持\n   - 代码压缩和混淆\n\n4. 插件系统扩展\n   - 生命周期钩子\n   - 编译优化\n   - 资源处理\n\n5. 性能优化扩展\n   - 持久化缓存\n   - 并行构建\n   - 增量编译\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br><span class="line-number">558</span><br><span class="line-number">559</span><br><span class="line-number">560</span><br><span class="line-number">561</span><br><span class="line-number">562</span><br><span class="line-number">563</span><br><span class="line-number">564</span><br><span class="line-number">565</span><br><span class="line-number">566</span><br><span class="line-number">567</span><br><span class="line-number">568</span><br><span class="line-number">569</span><br><span class="line-number">570</span><br><span class="line-number">571</span><br><span class="line-number">572</span><br><span class="line-number">573</span><br><span class="line-number">574</span><br><span class="line-number">575</span><br><span class="line-number">576</span><br><span class="line-number">577</span><br><span class="line-number">578</span><br><span class="line-number">579</span><br><span class="line-number">580</span><br><span class="line-number">581</span><br><span class="line-number">582</span><br><span class="line-number">583</span><br><span class="line-number">584</span><br><span class="line-number">585</span><br><span class="line-number">586</span><br><span class="line-number">587</span><br><span class="line-number">588</span><br><span class="line-number">589</span><br><span class="line-number">590</span><br><span class="line-number">591</span><br><span class="line-number">592</span><br><span class="line-number">593</span><br><span class="line-number">594</span><br><span class="line-number">595</span><br><span class="line-number">596</span><br><span class="line-number">597</span><br><span class="line-number">598</span><br><span class="line-number">599</span><br><span class="line-number">600</span><br><span class="line-number">601</span><br><span class="line-number">602</span><br><span class="line-number">603</span><br><span class="line-number">604</span><br><span class="line-number">605</span><br><span class="line-number">606</span><br><span class="line-number">607</span><br><span class="line-number">608</span><br><span class="line-number">609</span><br><span class="line-number">610</span><br><span class="line-number">611</span><br><span class="line-number">612</span><br><span class="line-number">613</span><br><span class="line-number">614</span><br><span class="line-number">615</span><br><span class="line-number">616</span><br><span class="line-number">617</span><br><span class="line-number">618</span><br><span class="line-number">619</span><br><span class="line-number">620</span><br><span class="line-number">621</span><br></div></div><hr><h3 id="_2-vite-的开发-生产模式差异" tabindex="-1"><a class="header-anchor" href="#_2-vite-的开发-生产模式差异" aria-hidden="true">#</a> 2. Vite 的开发/生产模式差异</h3><p>Vite 为什么开发用 ESM、生产仍要 bundling？分别解决什么问题？这种设计有什么取舍？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>一、开发模式（Dev）：为什么用 ESM\n\n1. 核心原理\n\n   浏览器直接加载 ES Module：\n\n   &lt;!-- index.html --&gt;\n   &lt;script type=&quot;module&quot; src=&quot;/src/main.js&quot;&gt;&lt;/script&gt;\n\n   浏览器发起请求：\n   GET /src/main.js\n     ↓\n   Vite Dev Server 拦截\n     ↓\n   实时编译（esbuild/SWC）\n     ↓\n   返回转换后的 ESM\n     ↓\n   浏览器解析 import，继续请求依赖\n     ↓\n   按需加载，逐步构建\n\n2. 解决的问题\n\n   问题1：启动速度慢\n   传统打包器（Webpack）：\n     启动 → 分析所有模块 → 打包 → 启动完成（30s+）\n\n   Vite：\n     启动 → 预构建依赖（node_modules）→ 启动完成（200ms）\n     访问页面时才编译，按需加载\n\n   问题2：HMR 更新慢\n   Webpack：\n     修改文件 → 重新打包相关模块 → 更新（1-5s）\n\n   Vite：\n     修改文件 → 只编译这个文件 → 精准 HMR（&lt;100ms）\n\n   问题3：开发体验差\n   每次改动都要等待，打断开发思路\n   Vite 即时反馈，提升开发效率\n\n3. 开发模式的优势\n\n   ✅ 极快的冷启动\n      无需打包，服务器秒起\n\n   ✅ 即时的热更新\n      只重新编译修改的文件\n\n   ✅ 真正的按需编译\n      未访问的路由/组件不编译\n\n   ✅ 利用浏览器缓存\n      HTTP 304 强缓存\n\n   ✅ 并行加载\n      充分利用 HTTP/2 多路复用\n\n二、生产模式（Build）：为什么要 bundling\n\n1. 核心原理\n\n   Vite 生产构建使用 Rollup：\n\n   vite build\n     ↓\n   Rollup 打包所有模块\n     ↓\n   Tree Shaking\n     ↓\n   代码分割\n     ↓\n   压缩优化\n     ↓\n   生成 bundle 文件\n\n2. 为什么不直接用 ESM？\n\n   问题1：性能问题（最关键）\n\n   假设应用有 1000 个模块：\n\n   【直接用 ESM】\n   浏览器加载：\n     index.html\n       ↓\n     main.js (import 10 个模块)\n       ↓\n     10 个模块 (每个 import 5 个)\n       ↓\n     50 个模块...\n\n   结果：\n   - 1000+ 个 HTTP 请求\n   - 瀑布式加载（串行）\n   - 即使 HTTP/2，也会有延迟\n   - 移动网络更慢\n\n   【打包后】\n   浏览器加载：\n     index.html\n       ↓\n     main.js (bundle，所有代码在内)\n       ↓\n     async-chunk.js (代码分割的异步包)\n\n   结果：\n   - 2-3 个 HTTP 请求\n   - 并行加载\n   - 更快的首屏时间\n\n   问题2：兼容性问题\n\n   现代浏览器 ESM 支持：\n   ✅ Chrome 61+\n   ✅ Firefox 60+\n   ✅ Safari 11+\n   ❌ IE 11 (不支持)\n\n   生产环境需要考虑：\n   - 老旧浏览器用户\n   - 企业内网（可能强制 IE）\n   - 兼容性降级方案\n\n   打包后可以：\n   - 转译为 ES5\n   - 使用 Polyfill\n   - 提供降级方案\n\n   问题3：代码体积问题\n\n   【ESM 重复代码】\n   // moduleA.js\n   import { debounce } from &#39;lodash-es&#39;;\n   export default debounce;\n\n   // moduleB.js\n   import { debounce } from &#39;lodash-es&#39;;\n   export default debounce;\n\n   浏览器加载：\n   - lodash-es/debounce.js 被加载 1 次 ✅\n   - 但依赖的内部模块可能重复解析\n\n   【打包后去重】\n   Rollup 分析依赖图：\n   - debounce 只打包一次\n   - 完全去重，体积更小\n\n   问题4：Tree Shaking 不彻底\n\n   ESM 原生不支持 Tree Shaking：\n\n   // utils.js\n   export const used = () =&gt; {};\n   export const unused = () =&gt; {};  // 未使用\n\n   // main.js\n   import { used } from &#39;./utils.js&#39;;\n\n   浏览器：\n   - 仍然加载整个 utils.js\n   - unused 函数仍在文件中\n\n   Rollup 打包：\n   - 静态分析 unused 未使用\n   - 直接删除，减小体积\n\n   问题5：网络往返延迟（RTT）\n\n   每个 HTTP 请求都有延迟：\n   - DNS 查询\n   - TCP 连接\n   - TLS 握手\n   - 服务器处理\n\n   1000 个模块 = 1000 次网络往返\n   即使每次 10ms，总计 10s\n\n   打包后 3 个文件 = 3 次往返 = 30ms\n\n   问题6：缓存策略复杂\n\n   ESM：\n   - 每个文件单独缓存\n   - 一个模块更新，只失效一个缓存 ✅\n   - 但首次加载 1000 个文件都要检查缓存\n\n   Bundle：\n   - 使用 contenthash\n   - main.[hash].js 缓存一年\n   - 代码变化 → hash 变化 → 自动更新\n   - 更简单可靠\n\n3. 生产模式的优势\n\n   ✅ 更少的 HTTP 请求\n      减少网络开销\n\n   ✅ 更好的 Tree Shaking\n      移除未使用代码，体积更小\n\n   ✅ 代码压缩和混淆\n      减小体积，保护代码\n\n   ✅ 代码分割优化\n      按路由/按需加载\n\n   ✅ 长期缓存策略\n      contenthash 精准缓存\n\n   ✅ 兼容性处理\n      支持老旧浏览器\n\n   ✅ 性能优化\n      Scope Hoisting、常量折叠等\n\n三、双模式设计的取舍\n\n1. 开发模式的优势与劣势\n\n   优势：\n   ✅ 极快的启动速度（200ms vs 30s）\n   ✅ 极快的 HMR（&lt;100ms vs 1-5s）\n   ✅ 按需编译，节省资源\n   ✅ 真实的模块边界，调试方便\n\n   劣势：\n   ❌ 首次访问路由时有编译延迟（可预构建缓解）\n   ❌ 需要现代浏览器支持 ESM\n   ❌ 开发和生产不一致（可能有坑）\n   ❌ 大量 HTTP 请求（开发环境可接受）\n\n2. 生产模式的优势与劣势\n\n   优势：\n   ✅ 最优的加载性能\n   ✅ 最小的体积\n   ✅ 最好的兼容性\n   ✅ 成熟的优化策略\n\n   劣势：\n   ❌ 构建时间较长（但比 Webpack 快）\n   ❌ 需要构建步骤\n   ❌ 调试相对困难（需要 Source Map）\n\n3. 开发/生产不一致的潜在问题\n\n   问题1：模块解析差异\n\n   开发环境：\n   import Component from &#39;./Component&#39;;\n   // Vite 自动补全 .vue 扩展名\n\n   生产环境（Rollup）：\n   import Component from &#39;./Component&#39;;\n   // 可能找不到模块（如果配置不一致）\n\n   解决：\n   // vite.config.js\n   export default {\n     resolve: {\n       extensions: [&#39;.js&#39;, &#39;.ts&#39;, &#39;.vue&#39;]  // 统一配置\n     }\n   }\n\n   问题2：环境变量处理\n\n   开发环境：\n   console.log(import.meta.env.VITE_API_URL);\n   // Vite 运行时注入\n\n   生产环境：\n   console.log(import.meta.env.VITE_API_URL);\n   // Rollup 构建时替换为字符串\n\n   注意：\n   - 不能使用动态的 env 访问\n   - 必须完整写出变量名\n\n   问题3：CSS 处理差异\n\n   开发环境：\n   import &#39;./style.css&#39;;\n   // 通过 &lt;style&gt; 标签注入\n\n   生产环境：\n   import &#39;./style.css&#39;;\n   // 提取为单独的 .css 文件\n\n   影响：\n   - 样式应用时机可能不同\n   - 需要测试生产构建\n\n   问题4：代码分割行为\n\n   开发环境：\n   const Home = () =&gt; import(&#39;./Home.vue&#39;);\n   // 每次访问都是独立的请求\n\n   生产环境：\n   const Home = () =&gt; import(&#39;./Home.vue&#39;);\n   // 打包成 chunk，可能包含其他模块\n\n   建议：\n   - 定期构建生产版本测试\n   - 使用 vite preview 预览生产构建\n\n4. 最佳实践\n\n   开发模式优化：\n   ✅ 配置依赖预构建\n      optimizeDeps: {\n        include: [&#39;vue&#39;, &#39;lodash-es&#39;]\n      }\n\n   ✅ 减少不必要的转换\n      只转换需要的文件\n\n   ✅ 使用缓存\n      利用 HTTP 缓存和文件系统缓存\n\n   生产模式优化：\n   ✅ 代码分割\n      build: {\n        rollupOptions: {\n          output: {\n            manualChunks: {\n              vendor: [&#39;vue&#39;, &#39;vue-router&#39;]\n            }\n          }\n        }\n      }\n\n   ✅ 压缩配置\n      build: {\n        minify: &#39;terser&#39;,\n        terserOptions: {\n          compress: {\n            drop_console: true\n          }\n        }\n      }\n\n   ✅ 启用 gzip/brotli\n      viteCompression()\n\n四、对比总结\n\n| 维度 | 开发模式（ESM） | 生产模式（Bundle） |\n|------|----------------|-------------------|\n| 启动速度 | ⚡ 极快（200ms） | N/A（需要构建） |\n| 热更新 | ⚡ 极快（&lt;100ms） | N/A |\n| 首次加载 | 🐌 多请求 | ⚡ 少请求 |\n| 文件体积 | ➖ 未优化 | ✅ 最小化 |\n| Tree Shaking | ❌ 不支持 | ✅ 完全支持 |\n| 兼容性 | ⚠️ 仅现代浏览器 | ✅ 可兼容老浏览器 |\n| 调试 | ✅ 真实模块 | ⚠️ 需要 Source Map |\n| 缓存策略 | 📦 HTTP 缓存 | 📦 contenthash 缓存 |\n| 代码分割 | ✅ 天然支持 | ✅ 手动配置 |\n\n五、Vite 的设计哲学\n\n1. 开发体验优先\n   - 快速启动，即时反馈\n   - 让开发者保持心流状态\n   - 不为构建速度牺牲开发体验\n\n2. 生产性能优先\n   - 最优的加载性能\n   - 最小的包体积\n   - 不为开发速度牺牲生产性能\n\n3. 充分利用现代工具\n   - esbuild: Go 编写，极速编译\n   - Rollup: 成熟的打包器，最佳 Tree Shaking\n   - 浏览器原生 ESM: 减少构建负担\n\n4. 渐进式增强\n   - 基础功能开箱即用\n   - 高级功能按需配置\n   - 插件生态丰富\n\n六、何时选择不同的构建工具\n\n选择 Vite：\n✅ 新项目\n✅ Vue/React/Svelte 应用\n✅ 追求极致的开发体验\n✅ 团队成员使用现代浏览器\n\n选择 Webpack：\n✅ 遗留项目（迁移成本高）\n✅ 需要极致的灵活性\n✅ 复杂的构建需求\n✅ 必须支持 IE11\n\n选择 Rollup：\n✅ 打包库（而非应用）\n✅ 需要多种输出格式\n✅ 追求最小体积\n\n【总结】\nVite 的双模式设计是对开发体验和生产性能的平衡：\n- 开发时利用现代浏览器能力，追求速度\n- 生产时使用成熟打包器，追求性能\n- 两者结合，提供最佳的全流程体验\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br></div></div><hr><h3 id="_3-webpack-性能优化" tabindex="-1"><a class="header-anchor" href="#_3-webpack-性能优化" aria-hidden="true">#</a> 3. Webpack 性能优化</h3><p>Webpack 性能瓶颈通常在哪几个环节？你会如何定位（指标/工具/策略）？给出你的优化清单。</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>一、性能瓶颈环节\n\n1. 构建速度瓶颈\n\n   【入口解析阶段】\n   - 递归解析所有模块的依赖\n   - 大型项目可能有 5000+ 模块\n   - 每个模块都要读取、解析\n\n   【Loader 转换阶段】\n   - babel-loader 转换 ES6+ → ES5（最慢）\n   - ts-loader 编译 TypeScript\n   - sass-loader 编译 SCSS\n   - 每个文件都要经过 loader 链\n\n   【Plugin 处理阶段】\n   - 压缩插件（TerserPlugin）\n   - 提取 CSS（MiniCssExtractPlugin）\n   - 生成 HTML（HtmlWebpackPlugin）\n\n   【文件输出阶段】\n   - 写入大量文件到磁盘\n   - 生成 Source Map\n\n2. 打包体积瓶颈\n\n   - 未 Tree Shaking 的第三方库\n   - 重复打包的公共模块\n   - 未压缩的图片资源\n   - 未分离的大块代码\n   - Source Map 过大\n\n3. 运行时性能瓶颈\n\n   - 首屏加载资源过多\n   - 未做代码分割\n   - 缓存策略不当\n\n二、性能定位方法\n\n1. 速度分析工具\n\n   【speed-measure-webpack-plugin】\n   测量每个 loader 和 plugin 的耗时\n\n   // webpack.config.js\n   const SpeedMeasurePlugin = require(&#39;speed-measure-webpack-plugin&#39;);\n   const smp = new SpeedMeasurePlugin();\n\n   module.exports = smp.wrap({\n     // 你的 webpack 配置\n   });\n\n   输出示例：\n   SMP ⏱\n   General output time took 18.5 secs\n\n   Plugins:\n     TerserPlugin took 8.2 secs\n     MiniCssExtractPlugin took 3.1 secs\n     HtmlWebpackPlugin took 0.5 secs\n\n   Loaders:\n     babel-loader took 12.3 secs\n       /src/index.js (2.1 secs)\n       /src/App.js (1.8 secs)\n     css-loader took 2.5 secs\n     sass-loader took 3.2 secs\n\n   分析：\n   - babel-loader 最慢 → 优化编译\n   - TerserPlugin 慢 → 考虑并行压缩\n\n2. 体积分析工具\n\n   【webpack-bundle-analyzer】\n   可视化分析打包产物\n\n   const BundleAnalyzerPlugin = require(&#39;webpack-bundle-analyzer&#39;).BundleAnalyzerPlugin;\n\n   module.exports = {\n     plugins: [\n       new BundleAnalyzerPlugin({\n         analyzerMode: &#39;static&#39;,  // 生成 HTML 文件\n         openAnalyzer: true\n       })\n     ]\n   };\n\n   npm run build\n   → 自动打开分析页面\n\n   可以看到：\n   - 每个模块的体积\n   - 重复打包的模块（红色）\n   - 最大的依赖库\n   - 可优化的空间\n\n3. 构建日志分析\n\n   【stats.json】\n   生成详细的构建统计\n\n   webpack --profile --json &gt; stats.json\n\n   上传到：\n   - webpack.github.io/analyse/\n   - statoscope.tech\n\n   可以分析：\n   - 模块依赖关系\n   - chunk 组成\n   - 为什么某个模块被打包\n\n4. 关键指标\n\n   【构建速度指标】\n   - 冷启动时间（首次构建）\n   - 热启动时间（有缓存）\n   - HMR 更新时间\n   - 生产构建时间\n\n   目标：\n   - 开发环境冷启动 &lt; 30s\n   - HMR 更新 &lt; 1s\n   - 生产构建（中型项目）&lt; 3 分钟\n\n   【体积指标】\n   - 总体积\n   - 首屏资源体积\n   - gzip 后体积\n\n   目标：\n   - 主 bundle &lt; 200KB (gzip)\n   - 首屏加载 &lt; 500KB (gzip)\n   - 总体积控制在合理范围\n\n三、优化清单\n\n【类别 A：构建速度优化】\n\n1. 减少 Loader 处理范围\n\n   ❌ 优化前：\n   module: {\n     rules: [\n       {\n         test: /\\.js$/,\n         use: &#39;babel-loader&#39;  // 处理所有 JS 文件\n       }\n     ]\n   }\n\n   ✅ 优化后：\n   module: {\n     rules: [\n       {\n         test: /\\.js$/,\n         exclude: /node_modules/,  // 排除 node_modules\n         include: path.resolve(__dirname, &#39;src&#39;),  // 只处理 src\n         use: &#39;babel-loader&#39;\n       }\n     ]\n   }\n\n   效果：\n   - 减少 50%+ 的文件处理量\n   - 构建时间减少 30-40%\n\n2. 开启 Loader 缓存\n\n   ✅ babel-loader 缓存：\n   {\n     test: /\\.js$/,\n     use: {\n       loader: &#39;babel-loader&#39;,\n       options: {\n         cacheDirectory: true,  // 开启缓存\n         cacheCompression: false  // 不压缩缓存（更快）\n       }\n     }\n   }\n\n   缓存位置：node_modules/.cache/babel-loader\n\n   效果：\n   - 第二次构建快 70%+\n   - HMR 更新快 80%+\n\n3. 使用 esbuild/swc 替代 Babel\n\n   【esbuild-loader】\n   Go 语言编写，速度快 10-100 倍\n\n   module: {\n     rules: [\n       {\n         test: /\\.js$/,\n         loader: &#39;esbuild-loader&#39;,\n         options: {\n           target: &#39;es2015&#39;\n         }\n       }\n     ]\n   }\n\n   【swc-loader】\n   Rust 语言编写，速度快 20 倍\n\n   {\n     test: /\\.js$/,\n     use: {\n       loader: &#39;swc-loader&#39;,\n       options: {\n         jsc: {\n           parser: {\n             syntax: &#39;ecmascript&#39;,\n             jsx: true\n           }\n         }\n       }\n     }\n   }\n\n   权衡：\n   - esbuild/swc 功能不如 Babel 完善\n   - 部分插件不支持\n   - 适合大部分场景\n\n4. 多进程/多线程构建\n\n   【thread-loader】\n   开启多进程处理 loader\n\n   module: {\n     rules: [\n       {\n         test: /\\.js$/,\n         use: [\n           &#39;thread-loader&#39;,  // 放在耗时 loader 之前\n           &#39;babel-loader&#39;\n         ]\n       }\n     ]\n   }\n\n   【terser-webpack-plugin 并行压缩】\n   optimization: {\n     minimize: true,\n     minimizer: [\n       new TerserPlugin({\n         parallel: true  // 使用多进程并行压缩\n       })\n     ]\n   }\n\n   注意：\n   - 小项目反而变慢（进程开销）\n   - 建议模块数 &gt; 1000 再使用\n\n5. 持久化缓存（Webpack 5）\n\n   cache: {\n     type: &#39;filesystem&#39;,  // 文件系统缓存\n     buildDependencies: {\n       config: [__filename]  // 配置文件变化时失效\n     }\n   }\n\n   缓存位置：node_modules/.cache/webpack\n\n   效果：\n   - 第二次构建快 90%+\n   - 改一个文件，其他模块使用缓存\n\n6. 优化模块解析\n\n   resolve: {\n     // 指定查找目录，减少搜索范围\n     modules: [path.resolve(__dirname, &#39;src&#39;), &#39;node_modules&#39;],\n\n     // 减少扩展名尝试\n     extensions: [&#39;.js&#39;, &#39;.jsx&#39;],  // 不要太多\n\n     // 别名，减少查找层级\n     alias: {\n       &#39;@&#39;: path.resolve(__dirname, &#39;src&#39;),\n       &#39;react&#39;: path.resolve(__dirname, &#39;node_modules/react&#39;)\n     },\n\n     // 使用 package.json 的 main 字段\n     mainFields: [&#39;main&#39;],\n\n     // 不解析 symlinks\n     symlinks: false\n   }\n\n7. 减少 Plugin 使用\n\n   ❌ 开发环境不必要的插件：\n   - TerserPlugin（压缩）\n   - CompressionPlugin（gzip）\n   - BundleAnalyzerPlugin（分析）\n\n   ✅ 按环境区分：\n   const plugins = [\n     new HtmlWebpackPlugin()\n   ];\n\n   if (process__.env.NODE_ENV === &#39;production&#39;) {\n     plugins.push(\n       new TerserPlugin(),\n       new CompressionPlugin()\n     );\n   }\n\n8. 使用 DllPlugin 预编译依赖\n\n   第三方库（React/Vue/Lodash）很少变化\n   可以预先打包，开发时直接引用\n\n   // webpack.dll.config.js\n   module.exports = {\n     entry: {\n       vendor: [&#39;react&#39;, &#39;react-dom&#39;, &#39;lodash&#39;]\n     },\n     output: {\n       filename: &#39;[name].dll.js&#39;,\n       library: &#39;[name]_library&#39;\n     },\n     plugins: [\n       new webpack.DllPlugin({\n         name: &#39;[name]_library&#39;,\n         path: path.join(__dirname, &#39;dll&#39;, &#39;[name]-manifest.json&#39;)\n       })\n     ]\n   };\n\n   // 主配置引用\n   plugins: [\n     new webpack.DllReferencePlugin({\n       manifest: require(&#39;./dll/vendor-manifest.json&#39;)\n     })\n   ]\n\n   效果：\n   - 减少重复编译\n   - 构建快 40%+\n\n   缺点：\n   - 维护成本高\n   - Webpack 5 的持久化缓存已能替代\n\n9. 开发环境优化\n\n   devtool: &#39;eval-cheap-module-source-map&#39;,  // 快速生成 Source Map\n\n   optimization: {\n     removeAvailableModules: false,  // 不移除已可用模块\n     removeEmptyChunks: false,       // 不移除空 chunk\n     splitChunks: false,              // 不做代码分割\n     minimize: false,                 // 不压缩\n     usedExports: false               // 不标记未使用导出\n   }\n\n   效果：\n   - 跳过不必要的优化\n   - 开发构建快 50%+\n\n【类别 B：打包体积优化】\n\n10. Tree Shaking\n\n    optimization: {\n      usedExports: true,  // 标记未使用的导出\n      minimize: true,      // 压缩时移除\n      sideEffects: false   // 允许删除无副作用的未使用模块\n    }\n\n    package.json:\n    {\n      &quot;sideEffects&quot;: false  // 或 [&quot;*.css&quot;]\n    }\n\n    注意：\n    - 只对 ES6 模块有效\n    - CommonJS 无法 Tree Shake\n\n11. 代码分割\n\n    【按路由分割】\n    const Home = React.lazy(() =&gt; import(&#39;./Home&#39;));\n    const About = React.lazy(() =&gt; import(&#39;./About&#39;));\n\n    【提取公共代码】\n    optimization: {\n      splitChunks: {\n        chunks: &#39;all&#39;,\n        cacheGroups: {\n          vendor: {\n            test: /[\\\\/]node_modules[\\\\/]/,\n            name: &#39;vendors&#39;,\n            priority: 10\n          },\n          common: {\n            minChunks: 2,\n            name: &#39;common&#39;,\n            priority: 5\n          }\n        }\n      },\n      runtimeChunk: &#39;single&#39;  // 提取 runtime\n    }\n\n    效果：\n    - 首屏加载减少 60%+\n    - 长期缓存，vendors 不变\n\n12. 压缩优化\n\n    【JS 压缩】\n    new TerserPlugin({\n      parallel: true,\n      terserOptions: {\n        compress: {\n          drop_console: true,  // 删除 console\n          drop_debugger: true,\n          pure_funcs: [&#39;console.log&#39;]  // 删除特定函数\n        }\n      }\n    })\n\n    【CSS 压缩】\n    new CssMinimizerPlugin()\n\n    【HTML 压缩】\n    new HtmlWebpackPlugin({\n      minify: {\n        collapseWhitespace: true,\n        removeComments: true\n      }\n    })\n\n13. 图片优化\n\n    【image-webpack-loader】\n    {\n      test: /\\.(png|jpg|gif)$/,\n      use: [\n        &#39;file-loader&#39;,\n        {\n          loader: &#39;image-webpack-loader&#39;,\n          options: {\n            mozjpeg: { quality: 75 },\n            pngquant: { quality: [0.65, 0.90] }\n          }\n        }\n      ]\n    }\n\n    【转 base64】\n    {\n      test: /\\.(png|jpg)$/,\n      type: &#39;asset&#39;,\n      parser: {\n        dataUrlCondition: {\n          maxSize: 8 * 1024  // 8KB 以下转 base64\n        }\n      }\n    }\n\n    【WebP 格式】\n    使用 image-minimizer-webpack-plugin\n\n14. 按需加载第三方库\n\n    ❌ 整体导入：\n    import _ from &#39;lodash&#39;;  // 整个 lodash (~70KB)\n    _.debounce(fn, 300);\n\n    ✅ 按需导入：\n    import debounce from &#39;lodash/debounce&#39;;  // 只导入需要的\n\n    或使用插件：\n    babel-plugin-import\n    babel-plugin-lodash\n\n15. 移除重复依赖\n\n    【查找重复】\n    npm ls lodash\n\n    可能看到：\n    ├─┬ package-a@1.0.0\n    │ └── lodash@4.17.19\n    └─┬ package-b@2.0.0\n      └── lodash@4.17.20\n\n    【解决方案1：resolutions（yarn）】\n    package.json:\n    {\n      &quot;resolutions&quot;: {\n        &quot;lodash&quot;: &quot;4.17.21&quot;  // 强制使用同一版本\n      }\n    }\n\n    【解决方案2：alias】\n    resolve: {\n      alias: {\n        lodash: path.resolve(__dirname, &#39;node_modules/lodash&#39;)\n      }\n    }\n\n16. Externals（CDN）\n\n    externals: {\n      react: &#39;React&#39;,\n      &#39;react-dom&#39;: &#39;ReactDOM&#39;\n    }\n\n    ```html\n    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js&quot;&gt;&lt;/script&gt;\n    ```\n\n    效果：\n    - 减少打包体积\n    - 利用 CDN 缓存\n\n    缺点：\n    - 依赖外部资源\n    - 可能有加载失败风险\n\n17. 开启 Gzip/Brotli\n\n    const CompressionPlugin = require(&#39;compression-webpack-plugin&#39;);\n\n    plugins: [\n      new CompressionPlugin({\n        algorithm: &#39;gzip&#39;,\n        test: /\\.(js|css|html)$/,\n        threshold: 10240,  // 10KB 以上才压缩\n        minRatio: 0.8\n      })\n    ]\n\n    效果：\n    - JS 体积减少 70%+\n    - CSS 体积减少 80%+\n\n【类别 C：运行时优化】\n\n18. 优化 Source Map\n\n    开发环境：\n    devtool: &#39;eval-cheap-module-source-map&#39;  // 快速，但调试友好\n\n    生产环境：\n    devtool: &#39;hidden-source-map&#39;  // 不暴露源码，但可上传到错误监控平台\n\n    或不生成（最快）：\n    devtool: false\n\n19. 模块联邦（Webpack 5）\n\n    多个应用共享依赖：\n\n    new ModuleFederationPlugin({\n      name: &#39;app1&#39;,\n      remotes: {\n        app2: &#39;app2@http://localhost:3002/remoteEntry.js&#39;\n      },\n      shared: [&#39;react&#39;, &#39;react-dom&#39;]\n    })\n\n    效果：\n    - 微前端架构\n    - 共享依赖，减少重复加载\n\n20. Prefetch/Preload\n\n    import(/* webpackPrefetch: true */ &#39;./utils&#39;)\n\n    生成：\n    &lt;link rel=&quot;prefetch&quot; href=&quot;utils.chunk.js&quot;&gt;\n\n    浏览器空闲时预加载\n\n四、优化策略总结\n\n优先级排序：\n\n【立即见效（投入少，收益高）】\n1. ✅ 开启 Loader 缓存\n2. ✅ 排除 node_modules\n3. ✅ 开启持久化缓存（Webpack 5）\n4. ✅ 代码分割 + Tree Shaking\n5. ✅ 压缩配置\n\n【中期优化（需要调研）】\n6. ⚡ 替换为 esbuild/swc\n7. ⚡ 按需加载第三方库\n8. ⚡ 图片优化\n9. ⚡ 多进程构建\n\n【长期规划（架构调整）】\n10. 🎯 迁移到 Vite（新项目）\n11. 🎯 模块联邦（微前端）\n12. 🎯 Monorepo + 依赖共享\n\n优化检查清单：\n\n□ 速度分析：使用 speed-measure-webpack-plugin\n□ 体积分析：使用 webpack-bundle-analyzer\n□ Loader 缓存：babel-loader cacheDirectory\n□ 持久化缓存：cache.type = &#39;filesystem&#39;\n□ 排除不必要文件：exclude node_modules\n□ 代码分割：splitChunks 配置\n□ Tree Shaking：usedExports + sideEffects\n□ 压缩：TerserPlugin + CssMinimizerPlugin\n□ 图片优化：image-webpack-loader\n□ Source Map：按环境选择合适的 devtool\n□ 按需加载：React.lazy + import()\n□ 移除重复依赖：npm ls 检查\n□ CDN：externals 配置\n□ Gzip：compression-webpack-plugin\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br><span class="line-number">558</span><br><span class="line-number">559</span><br><span class="line-number">560</span><br><span class="line-number">561</span><br><span class="line-number">562</span><br><span class="line-number">563</span><br><span class="line-number">564</span><br><span class="line-number">565</span><br><span class="line-number">566</span><br><span class="line-number">567</span><br><span class="line-number">568</span><br><span class="line-number">569</span><br><span class="line-number">570</span><br><span class="line-number">571</span><br><span class="line-number">572</span><br><span class="line-number">573</span><br><span class="line-number">574</span><br><span class="line-number">575</span><br><span class="line-number">576</span><br><span class="line-number">577</span><br><span class="line-number">578</span><br><span class="line-number">579</span><br><span class="line-number">580</span><br><span class="line-number">581</span><br><span class="line-number">582</span><br><span class="line-number">583</span><br><span class="line-number">584</span><br><span class="line-number">585</span><br><span class="line-number">586</span><br><span class="line-number">587</span><br><span class="line-number">588</span><br><span class="line-number">589</span><br><span class="line-number">590</span><br><span class="line-number">591</span><br><span class="line-number">592</span><br><span class="line-number">593</span><br><span class="line-number">594</span><br><span class="line-number">595</span><br><span class="line-number">596</span><br><span class="line-number">597</span><br><span class="line-number">598</span><br><span class="line-number">599</span><br><span class="line-number">600</span><br><span class="line-number">601</span><br><span class="line-number">602</span><br><span class="line-number">603</span><br><span class="line-number">604</span><br><span class="line-number">605</span><br><span class="line-number">606</span><br><span class="line-number">607</span><br><span class="line-number">608</span><br><span class="line-number">609</span><br><span class="line-number">610</span><br><span class="line-number">611</span><br><span class="line-number">612</span><br><span class="line-number">613</span><br><span class="line-number">614</span><br><span class="line-number">615</span><br><span class="line-number">616</span><br><span class="line-number">617</span><br><span class="line-number">618</span><br><span class="line-number">619</span><br><span class="line-number">620</span><br><span class="line-number">621</span><br><span class="line-number">622</span><br><span class="line-number">623</span><br><span class="line-number">624</span><br><span class="line-number">625</span><br></div></div><hr><h3 id="_4-webpack-迁移到-vite" tabindex="-1"><a class="header-anchor" href="#_4-webpack-迁移到-vite" aria-hidden="true">#</a> 4. Webpack 迁移到 Vite</h3><p>一个大型项目从 Webpack 迁移到 Vite，你会如何评估风险、兼容性问题、分阶段落地方案？</p><p><strong>【作答】：</strong></p><p>一、前期评估</p><ol><li><p>项目现状调研</p><p>【技术栈评估】 ✅ 适合迁移：</p><ul><li>Vue 3 / React / Svelte 等现代框架</li><li>使用 ES6+ 模块</li><li>依赖库支持 ESM</li><li>团队使用现代浏览器开发</li></ul><p>⚠️ 需要评估：</p><ul><li>Vue 2（需要 @vitejs/plugin-vue2）</li><li>混用 CommonJS 和 ESM</li><li>部分依赖只有 UMD 格式</li><li>大量自定义 Webpack 配置</li></ul><p>❌ 不建议迁移：</p><ul><li>必须支持 IE11（除非用 @vitejs/plugin-legacy）</li><li>深度定制 Webpack 配置无法替代</li><li>团队不愿意学习新工具</li><li>项目即将下线</li></ul><p>【依赖检查】 检查 package.json 中的依赖：</p><p>npm ls --depth=0 &gt; dependencies.txt</p><p>重点检查：</p><ul><li>是否有 ESM 版本</li><li>是否支持 Vite</li><li>是否需要特殊处理</li></ul><p>工具：</p><ul><li>es-check: 检查代码是否为 ESM</li><li>publint: 检查包的导出是否正确</li></ul><p>【Webpack 配置分析】 记录当前 Webpack 配置：</p><ul><li><p>Loader 使用情况 □ babel-loader → Vite 内置 esbuild □ vue-loader → @vitejs/plugin-vue □ style-loader → Vite 内置 □ file-loader → Vite asset 处理 □ 自定义 loader → 需要评估</p></li><li><p>Plugin 使用情况 □ HtmlWebpackPlugin → Vite 内置 □ DefinePlugin → Vite define 配置 □ CopyWebpackPlugin → vite-plugin-static-copy □ 自定义 plugin → 需要迁移或找替代</p></li><li><p>特殊功能 □ 代码分割 → Vite 支持 □ 别名配置 → Vite 支持 □ 环境变量 → Vite 支持 □ Proxy → Vite 支持</p></li></ul></li><li><p>风险评估矩阵</p><table><thead><tr><th>风险项</th><th>严重程度</th><th>发生概率</th><th>应对措施</th></tr></thead><tbody><tr><td>依赖不兼容</td><td>高</td><td>中</td><td>预先测试，准备降级方案</td></tr><tr><td>功能缺失</td><td>高</td><td>低</td><td>找替代插件或自己实现</td></tr><tr><td>构建产物差异</td><td>中</td><td>高</td><td>充分测试，对比产物</td></tr><tr><td>团队学习成本</td><td>低</td><td>高</td><td>培训 + 文档</td></tr><tr><td>性能回退</td><td>高</td><td>低</td><td>性能测试</td></tr><tr><td>开发体验下降</td><td>中</td><td>低</td><td>试运行，收集反馈</td></tr></tbody></table></li><li><p>收益评估</p><p>【预期收益】 开发速度：</p><ul><li>冷启动：30s → 2s（快 15 倍）</li><li>热更新：2s → 100ms（快 20 倍）</li></ul><p>开发体验：</p><ul><li>即时反馈，提升开发效率</li><li>更少的配置，降低维护成本</li></ul><p>【量化指标】</p><ul><li>开发效率提升：30%（每天节省 2 小时等待时间）</li><li>构建配置减少：50%（更简洁）</li><li>学习成本：2-3 天（阅读文档 + 实践）</li></ul></li></ol><p>二、兼容性问题排查</p><ol><li><p>模块系统兼容性</p><p>【问题 1：CommonJS 模块】</p></li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // 老代码\n   const utils = require_(&#39;./utils&#39;);\n   module.exports = { ... };\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>影响：</p><ul><li>Vite 优先支持 ESM</li><li>CommonJS 需要额外处理</li></ul><p>解决方案： 方案 1：渐进式改造</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // 逐步改为 ESM\n   import utils from &#39;./utils&#39;;\n   export default { ... };\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>方案 2：兼容配置</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // vite.config.js\n   optimizeDeps: {\n     include: [&#39;legacy-package&#39;]  // 预构建 CJS 依赖\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>方案 3：使用插件</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // @originjs/vite-plugin-commonjs\n   import { viteCommonjs } from &#39;@originjs/vite-plugin-commonjs&#39;;\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>【问题 2：动态 require】</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // Webpack 支持\n   const componentName = &#39;Button&#39;;\n   const Component = require(`./components/${componentName}`);\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>// Vite 不支持 ❌ import(/) 不能使用变量路径</p><p>解决方案：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // 改为静态导入 + 对象映射\n   const components = {\n     Button: () =&gt; import(&#39;./components/Button&#39;),\n     Input: () =&gt; import(&#39;./components/Input&#39;)\n   };\n   const Component = await components[componentName]();\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="2"><li><p>环境变量兼容性</p><p>【问题：变量命名差异】 Webpack:</p></li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   process__.env.NODE_ENV\n   process__.env.REACT_APP_API_URL\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Vite:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   import.meta.env.MODE  // development / production\n   import.meta.env.VITE_API_URL  // 必须 VITE_ 前缀\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>解决方案： 方案 1：全局替换</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // 代码中统一替换\n   - process__.env.NODE_ENV\n   + import.meta.env.MODE\n\n   - process__.env.REACT_APP_API_URL\n   + import.meta.env.VITE_API_URL\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>方案 2：兼容层</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // vite.config.js\n   define: {\n     &#39;process__.env.NODE_ENV&#39;: JSON.stringify(process__.env.NODE_ENV),\n     &#39;process__.env.REACT_APP_API_URL&#39;: JSON.stringify(process__.env.VITE_API_URL)\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li><p>别名和路径解析</p><p>Webpack:</p></li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   resolve: {\n     alias: {\n       &#39;@&#39;: path.resolve(__dirname, &#39;src&#39;),\n       &#39;components&#39;: path.resolve(__dirname, &#39;src/components&#39;)\n     }\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Vite:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   resolve: {\n     alias: {\n       &#39;@&#39;: &#39;/src&#39;,  // 可以用相对路径\n       &#39;components&#39;: &#39;/src/components&#39;\n     }\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>注意：</p><ul><li>Vite 的路径是相对于项目根目录</li><li>需要调整 import 语句</li></ul><ol start="4"><li>静态资源处理</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   【图片导入】\n   Webpack:\n   import logo from &#39;./logo.png&#39;;  // 返回路径字符串\n   &lt;img src={logo} /&gt;\n\n   Vite:\n   import logo from &#39;./logo.png&#39;;  // 同样返回路径\n   &lt;img src={logo} /&gt;  // ✅ 兼容\n\n   【显式 URL 导入】\n   Vite 特有：\n   import logo from &#39;./logo.png?url&#39;;  // 强制作为 URL\n   import logoRaw from &#39;./logo.png?raw&#39;;  // 作为字符串\n\n   【public 目录】\n   Webpack:\n   - public/favicon.ico → /favicon.ico\n\n   Vite:\n   - public/favicon.ico → /favicon.ico  // ✅ 兼容\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ol start="5"><li>CSS 处理差异</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   【CSS Modules】\n   Webpack:\n   import styles from &#39;./App.module.css&#39;;\n\n   Vite:\n   import styles from &#39;./App.module.css&#39;;  // ✅ 兼容\n\n   【SCSS/Less】\n   Webpack: 需要 sass-loader\n   Vite: 内置支持，只需安装 sass\n\n   npm install -D sass\n\n   【PostCSS】\n   // postcss.config.js（两者通用）\n   module.exports = {\n     plugins: {\n       autoprefixer: {}\n     }\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ol start="6"><li><p>第三方库兼容性</p><p>【需要预构建的库】 某些库导出不规范，需要预构建：</p></li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   optimizeDeps: {\n     include: [\n       &#39;lodash-es&#39;,  // 太多小文件\n       &#39;ant-design-vue&#39;,  // 导出复杂\n       &#39;legacy-lib&#39;  // CommonJS 库\n     ],\n     exclude: [\n       &#39;your-local-package&#39;  // 本地开发的包\n     ]\n   }\n\n   【需要特殊处理的库】\n   // jQuery 等全局变量库\n   export default {\n     define: {\n       $: &#39;window.jQuery&#39;,\n       jQuery: &#39;window.jQuery&#39;\n     }\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>三、分阶段迁移方案</p><p>阶段 1：准备阶段（1-2 周）</p><p>任务清单： □ 升级依赖到最新稳定版 □ 将 CommonJS 改为 ESM □ 清理不用的依赖 □ 整理 Webpack 配置清单 □ 准备迁移文档</p><p>具体步骤：</p><ol><li><p>创建迁移分支 git checkout -b feat/migrate-to-vite</p></li><li><p>安装 Vite npm install -D vite @vitejs/plugin-vue</p><p>或 React: npm install -D vite @vitejs/plugin-react</p></li><li><p>创建基础配置</p></li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   // vite.config.js\n   import { defineConfig } from &#39;vite&#39;;\n   import vue from &#39;@vitejs/plugin-vue&#39;;\n\n   export default defineConfig({\n     plugins: [vue()],\n     resolve: {\n       alias: {\n         &#39;@&#39;: &#39;/src&#39;\n       }\n     },\n     server: {\n       port: 3000,\n       proxy: {\n         &#39;/api&#39;: {\n           target: &#39;http://localhost:8080&#39;,\n           changeOrigin: true\n         }\n       }\n     }\n   });\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ol start="4"><li>修改入口文件</li></ol><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- index.html 移到项目根目录 --&gt;</span>\n<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>App<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/src/main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>阶段 2：试运行阶段（1 周）</p><ol><li><p>本地开发测试 npm run dev # Vite 开发服务器</p><p>测试项： □ 页面能否正常访问 □ 路由跳转是否正常 □ API 请求是否正常 □ 热更新是否工作 □ 样式是否正确 □ 图片等资源是否加载</p></li><li><p>解决兼容性问题 记录遇到的问题：</p><p>问题日志模板：</p><table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th><th>状态</th></tr></thead><tbody><tr><td>xxx 依赖报错</td><td>CommonJS</td><td>optimizeDeps</td><td>✅</td></tr><tr><td>环境变量 undefined</td><td>命名不同</td><td>改为 VITE_</td><td>✅</td></tr></tbody></table></li><li><p>性能对比测试 记录指标：</p><table><thead><tr><th>指标</th><th>Webpack</th><th>Vite</th><th>提升</th></tr></thead><tbody><tr><td>冷启动</td><td>28s</td><td>2.1s</td><td>13x</td></tr><tr><td>热更新</td><td>1.8s</td><td>95ms</td><td>19x</td></tr><tr><td>生产构建</td><td>180s</td><td>45s</td><td>4x</td></tr></tbody></table></li></ol><p>阶段 3：灰度发布阶段（2 周）</p><ol><li><p>部分开发者试用</p><ul><li>选择 2-3 名开发者先使用 Vite</li><li>收集问题和反馈</li><li>优化配置和文档</li></ul></li><li><p>双轨运行</p></li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   package.json:\n   {\n   &quot;scripts&quot;: {\n   &quot;dev&quot;: &quot;vite&quot;, // Vite 开发\n   &quot;dev:webpack&quot;: &quot;webpack serve&quot;, // 保留 Webpack\n   &quot;build&quot;: &quot;vite build&quot;,\n   &quot;build:webpack&quot;: &quot;webpack build&quot;\n   }\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>开发者可以自由选择：</p><ul><li>新功能开发用 Vite</li><li>出问题可以切回 Webpack</li></ul><ol start="3"><li><p>构建产物对比</p><ul><li>分别构建</li></ul><p>npm run build # Vite npm run build:webpack</p><ul><li><p>对比产物</p></li><li><p>文件数量</p></li><li><p>体积大小</p></li><li><p>功能完整性</p></li><li><p>性能指标</p></li></ul></li></ol><p>阶段 4：全面迁移阶段（1 周）</p><ol><li><p>团队培训</p><ul><li>分享 Vite 基础知识</li><li>讲解配置差异</li><li>演示常见问题解决</li></ul></li><li><p>统一切换</p><ul><li>所有开发者切换到 Vite</li><li>删除 Webpack 配置（保留备份）</li><li>更新 CI/CD 流程</li></ul></li><li><p>监控和调优</p><ul><li>收集问题</li><li>快速响应</li><li>持续优化</li></ul></li></ol><p>阶段 5：收尾阶段（1 周）</p><ol><li><p>清理代码 □ 删除 Webpack 相关依赖 □ 删除 Webpack 配置文件 □ 更新文档</p><p>npm uninstall webpack webpack-cli webpack-dev-server npm uninstall babel-loader css-loader style-loader ...</p><p>git rm webpack.config.js git rm babel.config.js</p></li><li><p>更新 CI/CD</p><ul><li><p>.gitlab-ci.yml / .github/workflows</p></li><li><p>npm run build:webpack</p></li></ul><ul><li>npm run build</li></ul></li><li><p>总结复盘</p><ul><li>迁移时间</li><li>遇到的问题</li><li>最终收益</li><li>经验教训</li></ul></li></ol><p>四、回滚预案</p><ol><li><p>触发条件</p><ul><li>严重 Bug 无法快速修复</li><li>性能严重下降</li><li>团队强烈反对</li></ul></li><li><p>回滚步骤 git checkout webpack-backup-branch npm install # 恢复依赖 npm run dev:webpack</p></li><li><p>降低回滚风险</p><ul><li>保留 Webpack 配置 1 个月</li><li>定期备份稳定版本</li><li>充分测试再删除</li></ul></li></ol><p>五、迁移检查清单</p><p>【开发环境】 □ npm run dev 能正常启动 □ 热更新（HMR）正常工作 □ Source Map 可以正常调试 □ 环境变量正确注入 □ API 代理正常工作 □ 别名（@/~）正常解析 □ CSS/SCSS 正常编译 □ 图片等静态资源正常加载</p><p>【构建产物】 □ npm run build 成功 □ 产物文件结构正确 □ HTML 正确引用 JS/CSS □ 代码分割正常 □ 资源文件正确输出 □ 环境变量正确替换 □ Source Map 正确生成（可选）</p><p>【功能测试】 □ 所有页面能正常访问 □ 路由跳转正常 □ 状态管理正常 □ API 请求正常 □ 表单提交正常 □ 文件上传/下载正常 □ WebSocket 连接正常（如有）</p><p>【性能测试】 □ 首屏加载时间 □ 交互响应时间 □ 构建产物体积 □ Lighthouse 评分</p><p>【兼容性测试】 □ Chrome □ Firefox □ Safari □ Edge □ 移动端浏览器</p><p>六、常见问题及解决方案</p><ol><li>依赖预构建问题</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   现象：\n   Uncaught Error: Module &quot;xxx&quot; has been externalized\n\n   解决：\n   optimizeDeps: {\n   include: [&#39;xxx&#39;]\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>循环依赖警告</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   现象：\n   Circular dependency detected\n\n   解决：\n\n   - 检查并消除循环依赖\n   - 或使用动态 import 打破循环\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="3"><li>全局变量未定义</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   现象：\n   process__ is not defined\n\n   解决：\n   define: {\n   &#39;process__.env&#39;: {},\n   global: &#39;window&#39;\n   }\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="4"><li>Node.js 内置模块</li></ol><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>   现象：\n   Cannot find module &#39;path&#39;\n\n   解决：\n   npm install -D vite-plugin-node-polyfills\n\n   plugins: [\n   nodePolyfills()\n   ]\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>七、总结</p><p>成功迁移的关键：</p><ol><li>✅ 充分评估和准备</li><li>✅ 分阶段逐步推进</li><li>✅ 保留回滚预案</li><li>✅ 团队充分沟通</li><li>✅ 持续监控优化</li></ol><p>时间规划（中型项目）：</p><ul><li>准备阶段：1-2 周</li><li>试运行：1 周</li><li>灰度发布：2 周</li><li>全面迁移：1 周</li><li>收尾：1 周</li><li>总计：6-7 周</li></ul><p>预期收益：</p><ul><li>开发速度提升 10-20 倍</li><li>开发体验显著提升</li><li>维护成本降低</li><li>团队技术栈现代化</li></ul><hr>',209),l={},p=(0,a(3744).Z)(l,[["render",function(n,s){return e}]])}}]);