"use strict";(self.webpackChunkmd_vuepress=self.webpackChunkmd_vuepress||[]).push([[8901],{6403:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-0362e799",path:"/mark/11-HTTP%E4%B8%8E%E7%BC%93%E5%AD%98.html",title:"从性能优化到 HTTP 变化及缓存",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"笔试题（6 题）",slug:"笔试题-6-题",children:[{level:3,title:"1. HTTP/1.1 vs HTTP/2 vs HTTP/3",slug:"_1-http-1-1-vs-http-2-vs-http-3",children:[]},{level:3,title:"2. HTTP 缓存机制",slug:"_2-http-缓存机制",children:[]},{level:3,title:"3. Cache-Control 指令",slug:"_3-cache-control-指令",children:[]},{level:3,title:"4. 缓存策略设计",slug:"_4-缓存策略设计",children:[]},{level:3,title:"5. Service Worker 缓存",slug:"_5-service-worker-缓存",children:[]},{level:3,title:"6. 缓存失效与更新",slug:"_6-缓存失效与更新",children:[]}]},{level:2,title:"面试题（4 题）",slug:"面试题-4-题",children:[{level:3,title:"1. 缓存策略优化",slug:"_1-缓存策略优化",children:[]},{level:3,title:"2. HTTP/2 优化策略变化",slug:"_2-http-2-优化策略变化",children:[]},{level:3,title:"3. 缓存问题排查",slug:"_3-缓存问题排查",children:[]},{level:3,title:"4. 缓存实践经验",slug:"_4-缓存实践经验",children:[]}]}],git:{updatedTime:1770135032e3},filePathRelative:"mark/11-HTTP与缓存.md"}},4015:(n,s,a)=>{a.r(s),a.d(s,{default:()=>l});const e=(0,a(6252).uE)('<h1 id="从性能优化到-http-变化及缓存" tabindex="-1"><a class="header-anchor" href="#从性能优化到-http-变化及缓存" aria-hidden="true">#</a> 从性能优化到 HTTP 变化及缓存</h1><h2 id="笔试题-6-题" tabindex="-1"><a class="header-anchor" href="#笔试题-6-题" aria-hidden="true">#</a> 笔试题（6 题）</h2><h3 id="_1-http-1-1-vs-http-2-vs-http-3" tabindex="-1"><a class="header-anchor" href="#_1-http-1-1-vs-http-2-vs-http-3" aria-hidden="true">#</a> 1. HTTP/1.1 vs HTTP/2 vs HTTP/3</h3><p>对比 HTTP/1.1、HTTP/2、HTTP/3 的核心差异，以及它们对前端性能优化的影响。</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>HTTP/1.1:\n核心特性:\n- 持久连接（Connection: keep-alive），减少连接建立开销\n- 管道化（pipelining），但存在队头阻塞问题\n- 支持分块传输编码（chunked transfer encoding）\n- 支持缓存控制（Cache-Control、ETag等）\n\n性能瓶颈:\n- 队头阻塞（Head-of-Line Blocking）：同一连接上请求必须按顺序响应\n- 每个域名最多6个并发连接限制\n- 请求头冗余，每次请求都携带完整头部\n- 不支持服务器推送\n\n\nHTTP/2:\n核心特性:\n- 多路复用（Multiplexing）：单连接上并行处理多个请求/响应\n- 二进制分帧：将数据分割为更小的帧，提高传输效率\n- 头部压缩（HPACK）：减少头部大小\n- 服务器推送（Server Push）：主动推送资源给客户端\n- 流优先级：支持请求优先级设置\n\n性能提升:\n- 消除队头阻塞（应用层）\n- 减少连接数，降低延迟\n- 头部压缩可减少30-50%的头部大小\n- 多路复用提高带宽利用率\n\n\nHTTP/3:\n核心特性:\n- 基于UDP的QUIC协议，而非TCP\n- 内置加密（TLS 1.3）\n- 连接迁移：网络切换时保持连接\n- 0-RTT连接建立（已连接过的服务器）\n- 解决传输层队头阻塞问题\n\n性能提升:\n- 消除TCP层队头阻塞\n- 更快的连接建立（0-RTT或1-RTT）\n- 更好的移动网络体验（连接迁移）\n- 减少延迟和丢包影响\n\n\n对前端优化策略的影响:\nHTTP/1.1时代:\n- 需要合并文件、使用雪碧图、域名分片\n- 内联关键CSS/JS\n- 减少HTTP请求数\n\nHTTP/2时代:\n- 可以拆分文件，利用多路复用\n- 不再需要雪碧图，可以单独请求图片\n- 域名分片可能反而降低性能\n- 服务器推送可以主动推送关键资源\n\nHTTP/3时代:\n- 进一步优化移动端体验\n- 更快的连接建立，减少首次加载时间\n- 更好的网络切换体验\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><hr><h3 id="_2-http-缓存机制" tabindex="-1"><a class="header-anchor" href="#_2-http-缓存机制" aria-hidden="true">#</a> 2. HTTP 缓存机制</h3><p>HTTP 缓存机制详解：强缓存（Expires、Cache-Control）vs 协商缓存（ETag、Last-Modified）。</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>强缓存:\nExpires:\n- HTTP/1.0的缓存控制，指定资源的过期时间（绝对时间）\n- 格式：Expires: Wed, 21 Oct 2025 07:28:00 GMT\n- 问题：依赖客户端时间，时间不准确会导致缓存失效\n- 优先级低于Cache-Control\n\nCache-Control:\n- HTTP/1.1的缓存控制，更灵活强大\n- 常用指令：max-age、no-cache、no-store、public、private\n- 示例：Cache-Control: max-age=3600, public\n- 优先级高于Expires\n\n\n协商缓存:\nETag:\n- 实体标签，资源的唯一标识符（通常是内容的hash值）\n- 格式：ETag: &quot;33a64df551425fcc55e4d42a148795d9f25f89d4&quot;\n- 客户端请求时携带If-None-Match头\n- 服务器比较ETag，相同返回304，不同返回200和新ETag\n- 优点：精确，能检测到内容变化\n- 缺点：需要计算hash，消耗服务器资源\n\nLast-Modified:\n- 资源最后修改时间\n- 格式：Last-Modified: Wed, 21 Oct 2025 07:28:00 GMT\n- 客户端请求时携带If-Modified-Since头\n- 服务器比较时间，未修改返回304，已修改返回200\n- 优点：实现简单\n- 缺点：精度到秒，1秒内多次修改无法检测；文件内容未变但时间变了会失效\n\n\n缓存流程:\n1. 浏览器发起请求\n2. 检查强缓存（Cache-Control/Expires）\n   - 未过期：直接使用缓存，状态码200（from cache）\n   - 已过期：进入下一步\n3. 检查协商缓存（ETag/Last-Modified）\n   - 发送If-None-Match（ETag）或If-Modified-Since（Last-Modified）\n   - 服务器验证资源是否变化\n   - 未变化：返回304 Not Modified，使用缓存\n   - 已变化：返回200和新资源\n\n\n优先级:\n1. Cache-Control &gt; Expires（强缓存）\n2. ETag &gt; Last-Modified（协商缓存）\n3. 强缓存 &gt; 协商缓存\n4. 如果同时设置，浏览器优先使用Cache-Control和ETag\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><hr><h3 id="_3-cache-control-指令" tabindex="-1"><a class="header-anchor" href="#_3-cache-control-指令" aria-hidden="true">#</a> 3. Cache-Control 指令</h3><p>Cache-Control 常用指令有哪些？max-age、no-cache、no-store、public、private 的区别？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>max-age:\n- 指定资源可以被缓存的最大时间（秒）\n- 示例：Cache-Control: max-age=3600（缓存1小时）\n- 相对时间，不依赖客户端时钟\n- 从响应时间开始计算\n\n\nno-cache:\n- 不是&quot;不缓存&quot;，而是&quot;使用前必须验证&quot;\n- 每次使用缓存前都要向服务器验证（发送协商缓存请求）\n- 适用于需要实时性但变化不频繁的资源\n- 示例：Cache-Control: no-cache\n\n\nno-store:\n- 真正的不缓存，禁止任何缓存\n- 不存储到浏览器缓存、CDN、代理服务器等任何地方\n- 适用于敏感数据（密码、支付信息等）\n- 示例：Cache-Control: no-store\n\n\npublic:\n- 允许任何缓存（浏览器、CDN、代理服务器）缓存资源\n- 适用于可以被公开缓存的资源（图片、字体、静态文件等）\n- 示例：Cache-Control: public, max-age=31536000\n\n\nprivate:\n- 只允许浏览器缓存，不允许CDN、代理服务器缓存\n- 适用于用户个性化内容（用户信息、购物车等）\n- 示例：Cache-Control: private, max-age=3600\n\n\n组合使用场景:\n1. 静态资源（JS/CSS/图片）：\n   Cache-Control: public, max-age=31536000, immutable\n   - 长期缓存，使用文件hash确保更新\n\n2. HTML文件：\n   Cache-Control: no-cache\n   - 每次验证，确保获取最新版本\n\n3. API响应（用户数据）：\n   Cache-Control: private, max-age=300\n   - 短期缓存，仅浏览器缓存\n\n4. 敏感数据：\n   Cache-Control: no-store, no-cache, must-revalidate\n   - 完全不缓存\n\n5. 可缓存但需验证：\n   Cache-Control: public, max-age=3600, must-revalidate\n   - 缓存1小时，过期后必须验证\n\n6. 其他指令：\n   - must-revalidate：过期后必须验证，不能使用过期缓存\n   - immutable：资源永不过期，适用于带hash的文件\n   - s-maxage：CDN/代理服务器的缓存时间\n   - stale-while-revalidate：允许使用过期缓存，同时后台更新\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><hr><h3 id="_4-缓存策略设计" tabindex="-1"><a class="header-anchor" href="#_4-缓存策略设计" aria-hidden="true">#</a> 4. 缓存策略设计</h3><p>如何为不同资源设计缓存策略（HTML、JS/CSS、图片、API）？文件指纹（hash）的作用？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>HTML:\n策略：no-cache 或 max-age=0, must-revalidate\n原因：\n- HTML是入口文件，必须保证获取最新版本\n- HTML中引用的资源URL会变化（带hash），需要及时更新\n- 使用no-cache确保每次验证，但304响应仍可使用缓存\n实践：\n- 设置较短的max-age（如300秒），过期后验证\n- 或使用no-cache，配合ETag进行协商缓存\n\n\nJS/CSS:\n策略：public, max-age=31536000, immutable（配合文件hash）\n原因：\n- 静态资源变化频率低，适合长期缓存\n- 使用文件hash（contenthash）确保内容变化时URL变化\n- immutable告诉浏览器资源永不过期，避免不必要的验证请求\n实践：\n- 构建时生成hash：app.abc123.js\n- 设置长期缓存（1年）\n- HTML中引用带hash的URL，HTML更新时自动获取新资源\n\n\n图片/字体:\n策略：public, max-age=2592000（30天）\n原因：\n- 图片和字体文件较大，适合缓存\n- 变化频率较低\n- 可以设置较长的缓存时间\n实践：\n- 使用CDN加速\n- 设置合理的max-age（1-6个月）\n- 对于可能更新的图片，使用版本号或hash\n\n\nAPI:\n策略：根据数据类型选择\n- 用户数据：private, max-age=0, must-revalidate\n- 公共数据：public, max-age=300（5分钟）\n- 实时数据：no-store 或 no-cache\n原因：\n- API数据变化频繁，需要根据业务场景设置\n- 用户个性化数据不能公开缓存\n- 需要平衡实时性和性能\n实践：\n- 使用ETag进行协商缓存\n- 设置合理的缓存时间\n- 考虑使用SWR（stale-while-revalidate）策略\n\n\n文件指纹 (hash):\n作用：\n1. 内容变化时URL变化，强制浏览器获取新资源\n2. 实现长期缓存：URL不变时使用缓存，URL变化时获取新资源\n3. 解决缓存更新问题：无需手动清理缓存\n4. 支持并行部署：新旧版本可以同时存在\n\n实现方式：\n- Webpack: [name].[contenthash:8].js\n- Vite: 自动生成hash文件名\n- 手动：version?v=1.2.3（版本号，不如hash精确）\n\n最佳实践：\n- JS/CSS使用contenthash（基于文件内容）\n- 图片可以使用hash或版本号\n- HTML中引用带hash的资源URL\n- 配合immutable指令，避免不必要的验证请求\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><hr><h3 id="_5-service-worker-缓存" tabindex="-1"><a class="header-anchor" href="#_5-service-worker-缓存" aria-hidden="true">#</a> 5. Service Worker 缓存</h3><p>Service Worker 缓存与 HTTP 缓存的区别？SW 缓存策略有哪些（CacheFirst、NetworkFirst）？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>区别:\n1. 控制层面：\n   - HTTP缓存：浏览器自动管理，通过HTTP头控制\n   - SW缓存：JavaScript代码控制，更灵活\n\n2. 缓存位置：\n   - HTTP缓存：浏览器缓存（内存/磁盘）\n   - SW缓存：Cache API，独立存储空间\n\n3. 缓存策略：\n   - HTTP缓存：基于HTTP头的规则（强缓存/协商缓存）\n   - SW缓存：可编程策略（CacheFirst、NetworkFirst等）\n\n4. 离线能力：\n   - HTTP缓存：需要网络连接验证\n   - SW缓存：完全离线可用\n\n5. 更新控制：\n   - HTTP缓存：依赖HTTP头和浏览器行为\n   - SW缓存：完全由代码控制更新逻辑\n\n6. 适用场景：\n   - HTTP缓存：所有HTTP请求\n   - SW缓存：需要离线支持、复杂缓存逻辑的场景\n\n\nCacheFirst:\n策略：优先使用缓存，缓存未命中时请求网络\n流程：\n1. 检查SW缓存\n2. 命中：直接返回缓存\n3. 未命中：请求网络，缓存响应后返回\n适用场景：\n- 静态资源（图片、字体、JS/CSS）\n- 不常变化的资源\n- 离线优先的场景\n优点：快速响应，节省带宽\n缺点：可能返回过期数据\n\n\nNetworkFirst:\n策略：优先请求网络，失败时使用缓存\n流程：\n1. 请求网络\n2. 成功：更新缓存，返回响应\n3. 失败：检查缓存，返回缓存或错误\n适用场景：\n- API请求\n- 需要实时性的数据\n- 网络优先的场景\n优点：数据较新，有离线降级\n缺点：网络慢时响应慢\n\n\nStaleWhileRevalidate:\n策略：立即返回缓存，同时后台更新缓存\n流程：\n1. 立即返回缓存（即使过期）\n2. 后台请求网络更新缓存\n3. 下次请求使用新缓存\n适用场景：\n- 需要快速响应但允许数据稍旧\n- 新闻、博客等可以接受短暂延迟的内容\n- 平衡性能和实时性\n优点：快速响应，后台更新\n缺点：首次可能返回过期数据\n\n\n其他策略:\n1. NetworkOnly：\n   - 只使用网络，不使用缓存\n   - 适用于必须实时获取的数据\n\n2. CacheOnly：\n   - 只使用缓存，不请求网络\n   - 适用于完全离线的场景\n\n3. 自定义策略：\n   - 根据URL、请求头等条件选择策略\n   - 例如：API用NetworkFirst，静态资源用CacheFirst\n\n4. 组合策略：\n   - 不同资源使用不同策略\n   - 根据网络状态动态切换策略\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><hr><h3 id="_6-缓存失效与更新" tabindex="-1"><a class="header-anchor" href="#_6-缓存失效与更新" aria-hidden="true">#</a> 6. 缓存失效与更新</h3><p>如何解决缓存更新问题？版本号、文件指纹、缓存清理策略？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>缓存更新问题:\n1. 强缓存导致资源不更新：\n   - 用户看到旧版本\n   - 新功能无法使用\n   - Bug修复不生效\n\n2. 协商缓存验证开销：\n   - 每次请求都要验证\n   - 增加服务器压力\n\n3. 多级缓存同步：\n   - 浏览器缓存、CDN缓存、服务器缓存\n   - 更新不同步导致问题\n\n4. 部分资源更新：\n   - 只更新了部分文件\n   - 新旧版本混用导致错误\n\n\n版本号方案:\n实现方式：\n- URL参数：app.js?v=1.2.3\n- 路径版本：/v1.2.3/app.js\n- 文件名版本：app-v1.2.3.js\n\n优点：\n- 实现简单\n- 可以手动控制版本\n- 适合小项目\n\n缺点：\n- 需要手动维护版本号\n- 可能忘记更新版本\n- 全量更新，即使文件未变化\n- 版本号冲突风险\n\n\n文件指纹方案:\n实现方式：\n- Content Hash：基于文件内容生成hash\n  - app.abc123def456.js（内容变化hash变化）\n- 构建工具自动生成：\n  - Webpack: [name].[contenthash:8].js\n  - Vite: 自动处理\n- HTML中自动引用带hash的URL\n\n优点：\n- 自动生成，无需手动维护\n- 精确：只有内容变化时hash才变化\n- 支持增量更新：只更新变化的文件\n- 长期缓存：URL不变时使用缓存\n\n缺点：\n- 需要构建工具支持\n- 首次构建可能较慢（计算hash）\n- 需要配合HTML更新机制\n\n\n缓存清理:\n1. 浏览器缓存清理：\n   - 用户手动清理（Ctrl+Shift+Delete）\n   - 代码无法直接清理用户浏览器缓存\n\n2. 服务器端清理：\n   - 更新资源URL（hash/版本号）\n   - 设置较短的缓存时间\n   - 使用Cache-Control: no-cache\n\n3. CDN缓存清理：\n   - CDN控制台手动清理\n   - API接口批量清理\n   - 设置较短的s-maxage\n\n4. Service Worker缓存清理：\n   - 代码控制，可以精确清理\n   - 监听更新事件，清理旧缓存\n   - 使用Cache API的delete方法\n\n5. 版本化清理：\n   - 保留多个版本，逐步清理旧版本\n   - 避免清理正在使用的资源\n\n\n最佳实践:\n1. 分层缓存策略：\n   - HTML: no-cache（每次验证）\n   - JS/CSS: 长期缓存 + hash\n   - 图片: 中期缓存（1-6个月）\n   - API: 短期缓存 + 协商缓存\n\n2. 文件指纹 + 长期缓存：\n   - 使用contenthash生成文件名\n   - 设置public, max-age=31536000, immutable\n   - HTML更新时自动获取新资源\n\n3. 渐进式更新：\n   - 支持多版本共存\n   - 逐步清理旧版本\n   - 避免强制更新导致的问题\n\n4. 监控和告警：\n   - 监控缓存命中率\n   - 监控资源更新情况\n   - 设置异常告警\n\n5. 降级方案：\n   - 缓存失效时的降级策略\n   - 离线时的处理方案\n   - 网络异常时的用户体验\n\n6. 测试验证：\n   - 测试缓存更新流程\n   - 验证新旧版本兼容性\n   - 检查缓存清理是否生效\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><hr><h2 id="面试题-4-题" tabindex="-1"><a class="header-anchor" href="#面试题-4-题" aria-hidden="true">#</a> 面试题（4 题）</h2><h3 id="_1-缓存策略优化" tabindex="-1"><a class="header-anchor" href="#_1-缓存策略优化" aria-hidden="true">#</a> 1. 缓存策略优化</h3><p>给一个网站设计完整的缓存策略，从 HTTP 缓存到 CDN 到 Service Worker，如何组合使用？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>完整的多层缓存策略设计：\n\n一、HTTP缓存层（浏览器缓存）\n1. HTML文件：\n   Cache-Control: no-cache, must-revalidate\n   ETag: 启用\n   原因：入口文件，必须保证最新\n\n2. JS/CSS文件（带hash）：\n   Cache-Control: public, max-age=31536000, immutable\n   原因：内容hash确保更新，可长期缓存\n\n3. 图片/字体：\n   Cache-Control: public, max-age=2592000\n   Last-Modified: 启用\n   原因：变化频率低，适合中期缓存\n\n4. API响应：\n   - 用户数据：Cache-Control: private, max-age=0\n   - 公共数据：Cache-Control: public, max-age=300\n   - 实时数据：Cache-Control: no-store\n\n二、CDN缓存层\n1. 静态资源（JS/CSS/图片）：\n   - 缓存时间：1年\n   - 回源验证：使用ETag/Last-Modified\n   - 边缘节点缓存，减少源站压力\n\n2. HTML文件：\n   - 缓存时间：5分钟\n   - 回源验证：每次验证\n   - 确保及时更新\n\n3. API：\n   - 根据业务决定是否CDN缓存\n   - 通常不缓存，直接回源\n\n三、Service Worker缓存层\n1. 静态资源策略：\n   - CacheFirst + 长期缓存\n   - 离线可用\n   - 后台更新\n\n2. API策略：\n   - NetworkFirst + 短期缓存\n   - 离线降级\n   - 后台同步\n\n3. HTML策略：\n   - NetworkFirst + 短期缓存\n   - 确保获取最新版本\n\n四、组合使用方案\n1. 首次访问：\n   - 请求 → CDN（未命中）→ 源站\n   - 响应设置HTTP缓存头\n   - SW缓存关键资源\n\n2. 再次访问（在线）：\n   - 检查HTTP缓存（强缓存）\n   - 检查SW缓存\n   - 检查CDN缓存\n   - 按优先级返回\n\n3. 离线访问：\n   - SW缓存提供服务\n   - 显示离线提示\n   - 后台同步数据\n\n4. 更新流程：\n   - HTML更新（no-cache）\n   - 新HTML引用新hash的资源\n   - 旧资源继续缓存（多版本共存）\n   - SW后台更新缓存\n\n五、实际配置示例\nNginx配置：\nlocation ~* \\.(js|css)$ {\n    add_header Cache-Control &quot;public, max-age=31536000, immutable&quot;;\n    add_header ETag on;\n}\n\nlocation ~* \\.(jpg|png|gif|woff|woff2)$ {\n    add_header Cache-Control &quot;public, max-age=2592000&quot;;\n}\n\nlocation = /index.html {\n    add_header Cache-Control &quot;no-cache, must-revalidate&quot;;\n}\n\nService Worker示例：\n// 静态资源：CacheFirst\nworkbox.routing.registerRoute(\n  /\\.(?:js|css|woff2?)$/,\n  new workbox.strategies.CacheFirst({\n    cacheName: &#39;static-resources&#39;,\n    plugins: [{\n      cacheableResponse: { statuses: [0, 200] },\n      expiration: { maxEntries: 100, maxAgeSeconds: 31536000 }\n    }]\n  })\n);\n\n// API：NetworkFirst\nworkbox.routing.registerRoute(\n  /\\/api\\//,\n  new workbox.strategies.NetworkFirst({\n    cacheName: &#39;api-cache&#39;,\n    plugins: [{\n      expiration: { maxEntries: 50, maxAgeSeconds: 300 }\n    }]\n  })\n);\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><hr><h3 id="_2-http-2-优化策略变化" tabindex="-1"><a class="header-anchor" href="#_2-http-2-优化策略变化" aria-hidden="true">#</a> 2. HTTP/2 优化策略变化</h3><p>HTTP/2 下，传统的性能优化策略（合并文件、雪碧图、域名分片）哪些失效了？为什么？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>HTTP/2带来的变化导致以下传统优化策略失效或不再必要：\n\n一、失效的策略\n\n1. 文件合并（Concatenation）\n失效原因：\n- HTTP/1.1：每个文件需要单独请求，合并减少请求数\n- HTTP/2：多路复用，单连接并行请求，请求数不再是瓶颈\n- 合并文件反而带来问题：\n  * 缓存粒度粗：一个文件变化，整个合并文件失效\n  * 并行加载受限：无法利用HTTP/2的多路复用优势\n  * 代码分割困难：难以按需加载\n\n建议：\n- 拆分文件，利用HTTP/2多路复用\n- 使用代码分割，按需加载\n- 保持文件独立性，提高缓存效率\n\n2. 雪碧图（Sprite）\n失效原因：\n- HTTP/1.1：减少图片请求数\n- HTTP/2：多路复用，图片请求并行，不再需要合并\n- 雪碧图的问题：\n  * 维护困难：添加/删除图片需要重新生成\n  * 缓存效率低：一个图片变化，整个雪碧图失效\n  * 无法利用HTTP/2的并行加载优势\n  * 响应式适配困难\n\n建议：\n- 使用单独的图片文件\n- 利用HTTP/2并行加载\n- 使用WebP等现代图片格式\n- 考虑使用SVG图标\n\n3. 域名分片（Domain Sharding）\n失效原因：\n- HTTP/1.1：每个域名最多6个并发连接，分片增加连接数\n- HTTP/2：单连接多路复用，多个域名反而增加开销\n- 域名分片的问题：\n  * DNS查询开销：多个域名需要多次DNS查询\n  * 连接建立开销：每个域名需要建立连接\n  * 无法利用HTTP/2的单连接优势\n  * 可能降低性能\n\n建议：\n- 使用单一域名或少量域名\n- 利用HTTP/2的单连接多路复用\n- 减少DNS查询和连接建立开销\n\n4. 内联关键资源（Inline Critical Resources）\n部分失效：\n- HTTP/1.1：内联关键CSS/JS减少请求\n- HTTP/2：多路复用使内联的必要性降低\n- 但仍有一定价值：\n  * 减少关键路径的RTT\n  * 避免阻塞渲染的资源请求\n\n建议：\n- 可以继续内联关键CSS（首屏渲染）\n- JS内联的必要性降低\n- 平衡内联和缓存的关系\n\n二、仍然有效的策略\n\n1. 资源压缩（Gzip/Brotli）\n- HTTP/2头部压缩不影响内容压缩\n- 继续使用Gzip/Brotli压缩资源\n\n2. 图片优化\n- 使用WebP、AVIF等现代格式\n- 响应式图片（srcset）\n- 懒加载\n\n3. 代码分割\n- 按路由分割\n- 按需加载\n- 利用HTTP/2并行加载优势\n\n4. CDN使用\n- 地理分布\n- 边缘缓存\n- 仍然有效\n\n5. 缓存策略\n- HTTP缓存头\n- 文件hash\n- 仍然重要\n\n三、新的优化策略\n\n1. 服务器推送（Server Push）\n- HTTP/2新特性\n- 主动推送关键资源\n- 减少RTT\n\n2. 资源优先级（Priority）\n- 设置资源加载优先级\n- 优化关键路径\n\n3. HTTP/2特定的优化\n- 利用多路复用拆分资源\n- 利用头部压缩减少开销\n- 利用服务器推送预加载\n\n四、实际建议\n\n1. 迁移策略：\n- 评估当前优化策略\n- 逐步移除失效策略\n- 测试性能影响\n\n2. 混合策略：\n- 考虑HTTP/1.1用户（降级）\n- 为HTTP/2用户优化\n- 使用特性检测\n\n3. 监控和测试：\n- 监控HTTP版本分布\n- A/B测试优化效果\n- 持续优化\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div><hr><h3 id="_3-缓存问题排查" tabindex="-1"><a class="header-anchor" href="#_3-缓存问题排查" aria-hidden="true">#</a> 3. 缓存问题排查</h3><p>用户反馈&quot;看到的是旧版本&quot;，你如何排查缓存问题？从浏览器、CDN、服务器多个层面分析。</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>系统化的缓存问题排查流程：\n\n一、信息收集阶段\n\n1. 收集用户信息：\n   - 浏览器类型和版本\n   - 访问的URL\n   - 具体看到的内容（截图）\n   - 是否强制刷新（Ctrl+F5）后仍显示旧版本\n   - 其他用户是否也有此问题\n   - 问题出现时间\n\n2. 检查服务器状态：\n   - 确认服务器已更新\n   - 检查部署日志\n   - 验证文件内容是否正确\n\n二、浏览器层面排查\n\n1. 开发者工具检查：\n   - Network面板：\n     * 查看资源状态码（200/304/from cache）\n     * 检查响应头（Cache-Control、ETag、Last-Modified）\n     * 查看资源大小和时间戳\n     * 确认资源URL是否正确（hash是否更新）\n\n   - Application面板：\n     * 检查Service Worker缓存\n     * 检查HTTP缓存\n     * 查看存储的缓存内容\n\n2. 缓存验证：\n   - 硬刷新（Ctrl+Shift+R / Cmd+Shift+R）\n   - 清除缓存并硬性重新加载\n   - 无痕模式访问（排除扩展影响）\n   - 禁用Service Worker测试\n\n3. 常见问题：\n   - 强缓存未过期：检查Cache-Control max-age\n   - Service Worker缓存：检查SW缓存策略\n   - 浏览器扩展缓存：禁用扩展测试\n   - 本地存储：检查localStorage/sessionStorage\n\n三、CDN层面排查\n\n1. CDN缓存检查：\n   - CDN控制台查看缓存状态\n   - 检查CDN缓存规则配置\n   - 查看CDN日志（命中/未命中）\n   - 检查CDN节点的缓存时间\n\n2. CDN缓存清理：\n   - 手动清理特定URL\n   - 批量清理（按目录/文件类型）\n   - 检查清理是否生效\n   - 验证清理后的响应\n\n3. CDN配置检查：\n   - 缓存时间设置（s-maxage）\n   - 回源验证配置\n   - 缓存键（Cache Key）配置\n   - 边缘节点同步状态\n\n4. 多节点验证：\n   - 不同地区访问测试\n   - 检查边缘节点缓存一致性\n   - 验证回源策略\n\n四、服务器层面排查\n\n1. HTTP头检查：\n   - 验证Cache-Control设置\n   - 检查ETag生成是否正确\n   - 验证Last-Modified时间\n   - 确认响应头配置\n\n2. 文件内容验证：\n   - 直接访问源站URL\n   - 检查文件内容是否更新\n   - 验证文件hash是否正确\n   - 检查文件时间戳\n\n3. 服务器配置：\n   - Nginx/Apache缓存配置\n   - 反向代理缓存设置\n   - 应用层缓存（Redis等）\n   - 静态文件服务配置\n\n4. 部署验证：\n   - 检查部署是否成功\n   - 验证文件是否覆盖\n   - 检查文件权限\n   - 确认多服务器同步\n\n五、排查工具和方法\n\n1. 浏览器工具：\n   - Chrome DevTools\n   - Firefox Developer Tools\n   - Safari Web Inspector\n\n2. 命令行工具：\n   - curl -I（查看响应头）\n   - curl -v（详细请求信息）\n   - wget --spider（检查资源）\n\n3. 在线工具：\n   - WebPageTest\n   - GTmetrix\n   - Pingdom\n\n4. 日志分析：\n   - 服务器访问日志\n   - CDN日志\n   - 应用日志\n\n六、问题定位流程\n\n1. 快速验证：\n   1. 无痕模式访问 → 排除浏览器缓存\n   2. 直接访问源站 → 排除CDN缓存\n   3. 检查文件hash → 确认文件是否更新\n   4. 查看响应头 → 确认缓存配置\n\n2. 逐步排查：\n   浏览器缓存 → CDN缓存 → 服务器缓存 → 源站文件\n\n3. 验证修复：\n   清理缓存 → 验证响应 → 确认更新 → 监控效果\n\n七、常见问题和解决方案\n\n1. HTML未更新：\n   - 问题：HTML设置了强缓存\n   - 解决：改为no-cache或短时间缓存\n\n2. JS/CSS未更新：\n   - 问题：文件hash未变化或缓存未清理\n   - 解决：确保hash更新，清理CDN缓存\n\n3. 图片未更新：\n   - 问题：CDN缓存时间过长\n   - 解决：清理CDN缓存，调整缓存时间\n\n4. Service Worker缓存：\n   - 问题：SW缓存了旧资源\n   - 解决：更新SW版本，清理旧缓存\n\n5. 多级缓存不同步：\n   - 问题：浏览器/CDN/服务器缓存不一致\n   - 解决：统一缓存策略，清理所有缓存\n\n八、预防措施\n\n1. 合理的缓存策略：\n   - HTML: no-cache\n   - 静态资源: 长期缓存 + hash\n   - API: 短期缓存\n\n2. 版本控制：\n   - 使用文件hash\n   - 确保hash唯一性\n   - 版本化部署\n\n3. 监控告警：\n   - 监控缓存命中率\n   - 监控资源更新\n   - 设置异常告警\n\n4. 文档和流程：\n   - 缓存策略文档\n   - 问题排查手册\n   - 应急处理流程\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br></div></div><hr><h3 id="_4-缓存实践经验" tabindex="-1"><a class="header-anchor" href="#_4-缓存实践经验" aria-hidden="true">#</a> 4. 缓存实践经验</h3><p>讲一个你优化缓存策略的经验：初始状态、优化方案、效果数据、遇到的坑？</p><p><strong>【作答】：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>项目背景：一个中大型React SPA应用，日活10万+，用户反馈加载慢、经常看到旧版本。\n\n一、初始状态\n\n问题表现：\n1. 性能问题：\n   - 首屏加载时间：3.5秒\n   - 重复访问仍需2秒\n   - 大量304请求，浪费带宽\n\n2. 缓存问题：\n   - 用户经常看到旧版本\n   - 更新后需要强制刷新才能看到新功能\n   - 客服收到大量&quot;为什么看不到更新&quot;的反馈\n\n3. 技术现状：\n   - HTML: Cache-Control: max-age=3600（1小时强缓存）\n   - JS/CSS: 无缓存策略，每次请求\n   - 图片: 无统一缓存策略\n   - API: 无缓存\n   - 未使用文件hash\n   - 未使用CDN\n   - 未使用Service Worker\n\n4. 数据指标：\n   - 缓存命中率：&lt; 10%\n   - 平均请求数：45个/页面\n   - 平均传输大小：2.1MB\n   - 服务器带宽：高峰期500Mbps\n\n二、优化方案\n\n阶段一：基础HTTP缓存优化（1周）\n\n1. HTML缓存策略：\n   - 改为：Cache-Control: no-cache, must-revalidate\n   - 启用ETag\n   - 确保每次验证，但304仍可使用缓存\n\n2. 静态资源缓存：\n   - JS/CSS: 设置Cache-Control: public, max-age=86400（1天）\n   - 图片: Cache-Control: public, max-age=604800（7天）\n   - 字体: Cache-Control: public, max-age=2592000（30天）\n\n3. API缓存：\n   - 公共数据: Cache-Control: public, max-age=300（5分钟）\n   - 用户数据: Cache-Control: private, max-age=0\n\n效果：\n- 缓存命中率提升到35%\n- 重复访问时间减少到1.5秒\n- 但仍有缓存更新问题\n\n阶段二：文件hash + 长期缓存（2周）\n\n1. 构建优化：\n   - 配置Webpack使用contenthash\n   - 文件名格式：[name].[contenthash:8].[ext]\n   - HTML中自动引用带hash的文件\n\n2. 缓存策略调整：\n   - JS/CSS: Cache-Control: public, max-age=31536000, immutable\n   - 长期缓存，依赖hash确保更新\n\n3. HTML策略：\n   - 保持no-cache\n   - 确保能获取最新版本\n\n效果：\n- 缓存命中率提升到65%\n- 重复访问时间减少到0.8秒\n- 缓存更新问题基本解决\n\n阶段三：CDN + 进一步优化（3周）\n\n1. CDN接入：\n   - 静态资源全部走CDN\n   - CDN缓存时间：1年（配合hash）\n   - HTML缓存：5分钟\n\n2. 资源优化：\n   - 图片压缩和格式优化（WebP）\n   - Gzip/Brotli压缩\n   - 代码分割优化\n\n3. Service Worker：\n   - 关键资源CacheFirst\n   - API NetworkFirst\n   - 离线支持\n\n效果：\n- 缓存命中率提升到85%\n- 首屏加载时间：1.8秒\n- 重复访问时间：0.3秒\n- 离线可用\n\n三、效果数据\n\n优化前后对比：\n\n1. 性能指标：\n   | 指标 | 优化前 | 优化后 | 提升 |\n   |------|--------|--------|------|\n   | 首屏加载 | 3.5s | 1.8s | 48% ↓ |\n   | 重复访问 | 2.0s | 0.3s | 85% ↓ |\n   | 缓存命中率 | 10% | 85% | 750% ↑ |\n   | 平均请求数 | 45 | 12 | 73% ↓ |\n   | 传输大小 | 2.1MB | 0.8MB | 62% ↓ |\n\n2. 服务器指标：\n   | 指标 | 优化前 | 优化后 | 提升 |\n   |------|--------|--------|------|\n   | 带宽使用 | 500Mbps | 150Mbps | 70% ↓ |\n   | 服务器负载 | 高 | 低 | 显著降低 |\n   | 304请求 | 大量 | 少量 | 大幅减少 |\n\n3. 用户体验：\n   - 用户反馈加载慢的问题减少90%\n   - &quot;看到旧版本&quot;的反馈减少95%\n   - 用户满意度提升\n\n4. 成本：\n   - CDN成本：+2000元/月\n   - 服务器成本：-5000元/月\n   - 净节省：3000元/月\n\n四、遇到的坑\n\n1. HTML缓存问题：\n   - 问题：初期HTML也设置了长期缓存，导致更新不及时\n   - 解决：改为no-cache，确保每次验证\n   - 教训：HTML必须保证能及时更新\n\n2. 文件hash冲突：\n   - 问题：不同环境构建的hash不一致\n   - 解决：统一构建环境，使用CI/CD\n   - 教训：确保构建环境一致性\n\n3. CDN缓存清理：\n   - 问题：紧急更新时CDN缓存未及时清理\n   - 解决：建立CDN缓存清理流程和工具\n   - 教训：需要快速清理机制\n\n4. Service Worker更新：\n   - 问题：SW缓存了旧资源，更新不及时\n   - 解决：实现SW版本管理和缓存清理逻辑\n   - 教训：SW需要版本控制\n\n5. 多版本共存：\n   - 问题：新旧版本资源混用导致错误\n   - 解决：确保HTML和资源版本匹配\n   - 教训：需要版本一致性检查\n\n6. 移动端缓存：\n   - 问题：移动端浏览器缓存行为不同\n   - 解决：针对移动端调整缓存策略\n   - 教训：需要跨平台测试\n\n7. API缓存误用：\n   - 问题：缓存了不应该缓存的用户数据\n   - 解决：仔细区分public/private数据\n   - 教训：API缓存需要谨慎设计\n\n五、经验总结\n\n1. 缓存策略要分层：\n   - 不同资源不同策略\n   - HTML入口必须可更新\n   - 静态资源长期缓存\n\n2. 文件hash是关键：\n   - 解决缓存更新问题\n   - 支持长期缓存\n   - 确保版本一致性\n\n3. 监控和测试：\n   - 持续监控缓存命中率\n   - 测试不同场景\n   - 建立告警机制\n\n4. 文档和流程：\n   - 记录缓存策略\n   - 建立问题排查流程\n   - 团队知识共享\n\n5. 渐进式优化：\n   - 分阶段实施\n   - 验证每阶段效果\n   - 及时调整策略\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br></div></div><hr>',53),r={},l=(0,a(3744).Z)(r,[["render",function(n,s){return e}]])}}]);