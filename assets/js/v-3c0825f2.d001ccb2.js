"use strict";(self.webpackChunkmd_vuepress=self.webpackChunkmd_vuepress||[]).push([[9558],{7158:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-3c0825f2",path:"/mack/React%E6%9B%B4%E6%96%B0%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3.html",title:"React æ›´æ–°æµç¨‹è¯¦è§£",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"æ¦‚è§ˆï¼šä» setState åˆ° DOM æ›´æ–°çš„å®Œæ•´æ—…ç¨‹",slug:"æ¦‚è§ˆ-ä»-setstate-åˆ°-dom-æ›´æ–°çš„å®Œæ•´æ—…ç¨‹",children:[]},{level:2,title:"é˜¶æ®µ 1: è°ƒåº¦é˜¶æ®µ (Schedule)",slug:"é˜¶æ®µ-1-è°ƒåº¦é˜¶æ®µ-schedule",children:[{level:3,title:"1.1 æ ¸å¿ƒèŒè´£",slug:"_1-1-æ ¸å¿ƒèŒè´£",children:[]},{level:3,title:"1.2 è¯¦ç»†æµç¨‹",slug:"_1-2-è¯¦ç»†æµç¨‹",children:[]},{level:3,title:"1.3 ä¼˜å…ˆçº§æ¨¡å‹ï¼ˆLaneï¼‰",slug:"_1-3-ä¼˜å…ˆçº§æ¨¡å‹-lane",children:[]},{level:3,title:"1.4 æ—¶é—´åˆ‡ç‰‡åŸç†",slug:"_1-4-æ—¶é—´åˆ‡ç‰‡åŸç†",children:[]},{level:3,title:"1.5 å®é™…æ¡ˆä¾‹æ¼”ç¤º",slug:"_1-5-å®é™…æ¡ˆä¾‹æ¼”ç¤º",children:[]}]},{level:2,title:"é˜¶æ®µ 2: åè°ƒé˜¶æ®µ (Render/Reconciliation)",slug:"é˜¶æ®µ-2-åè°ƒé˜¶æ®µ-render-reconciliation",children:[{level:3,title:"2.1 æ ¸å¿ƒèŒè´£",slug:"_2-1-æ ¸å¿ƒèŒè´£",children:[]},{level:3,title:"2.2 åŒç¼“å†²æœºåˆ¶",slug:"_2-2-åŒç¼“å†²æœºåˆ¶",children:[]},{level:3,title:"2.3 è¯¦ç»†æµç¨‹ï¼šbeginWork",slug:"_2-3-è¯¦ç»†æµç¨‹-beginwork",children:[]},{level:3,title:"2.4 Diff ç®—æ³•è¯¦è§£",slug:"_2-4-diff-ç®—æ³•è¯¦è§£",children:[]},{level:3,title:"2.5 Diff ç®—æ³•æ¡ˆä¾‹æ¼”ç¤º",slug:"_2-5-diff-ç®—æ³•æ¡ˆä¾‹æ¼”ç¤º",children:[]},{level:3,title:"2.6 completeWorkï¼ˆå‘ä¸Šå›æº¯ï¼‰",slug:"_2-6-completework-å‘ä¸Šå›æº¯",children:[]},{level:3,title:"2.7 effectListï¼ˆå‰¯ä½œç”¨é“¾è¡¨ï¼‰",slug:"_2-7-effectlist-å‰¯ä½œç”¨é“¾è¡¨",children:[]}]},{level:2,title:"é˜¶æ®µ 3: æäº¤é˜¶æ®µ (Commit)",slug:"é˜¶æ®µ-3-æäº¤é˜¶æ®µ-commit",children:[{level:3,title:"3.1 æ ¸å¿ƒèŒè´£",slug:"_3-1-æ ¸å¿ƒèŒè´£",children:[]},{level:3,title:"3.2 ä¸‰ä¸ªå­é˜¶æ®µ",slug:"_3-2-ä¸‰ä¸ªå­é˜¶æ®µ",children:[]},{level:3,title:"3.3 before mutation é˜¶æ®µ",slug:"_3-3-before-mutation-é˜¶æ®µ",children:[]},{level:3,title:"3.4 mutation é˜¶æ®µï¼ˆæ ¸å¿ƒï¼‰",slug:"_3-4-mutation-é˜¶æ®µ-æ ¸å¿ƒ",children:[]},{level:3,title:"3.5 layout é˜¶æ®µ",slug:"_3-5-layout-é˜¶æ®µ",children:[]},{level:3,title:"3.6 å®é™…æ¡ˆä¾‹ï¼šå®Œæ•´æ›´æ–°æµç¨‹",slug:"_3-6-å®é™…æ¡ˆä¾‹-å®Œæ•´æ›´æ–°æµç¨‹",children:[]}]},{level:2,title:"é˜¶æ®µ 4: å‰¯ä½œç”¨æ‰§è¡Œ (Effect)",slug:"é˜¶æ®µ-4-å‰¯ä½œç”¨æ‰§è¡Œ-effect",children:[{level:3,title:"4.1 useEffect çš„å¼‚æ­¥è°ƒåº¦",slug:"_4-1-useeffect-çš„å¼‚æ­¥è°ƒåº¦",children:[]},{level:3,title:"4.2 useEffect vs useLayoutEffect",slug:"_4-2-useeffect-vs-uselayouteffect",children:[]}]},{level:2,title:"å…³é”®æ¦‚å¿µæ€»ç»“",slug:"å…³é”®æ¦‚å¿µæ€»ç»“",children:[{level:3,title:"1. ä¸ºä»€ä¹ˆ Render å¯ä¸­æ–­ï¼ŒCommit ä¸å¯ä¸­æ–­ï¼Ÿ",slug:"_1-ä¸ºä»€ä¹ˆ-render-å¯ä¸­æ–­-commit-ä¸å¯ä¸­æ–­",children:[]},{level:3,title:"2. åŒç¼“å†²çš„æ„ä¹‰",slug:"_2-åŒç¼“å†²çš„æ„ä¹‰",children:[]},{level:3,title:"3. effectList çš„ä½œç”¨",slug:"_3-effectlist-çš„ä½œç”¨",children:[]}]},{level:2,title:"å®Œæ•´æ—¶åºå›¾",slug:"å®Œæ•´æ—¶åºå›¾",children:[]},{level:2,title:"è°ƒè¯•æŠ€å·§",slug:"è°ƒè¯•æŠ€å·§",children:[{level:3,title:"1. åœ¨æµè§ˆå™¨ä¸­è§‚å¯Ÿæ›´æ–°",slug:"_1-åœ¨æµè§ˆå™¨ä¸­è§‚å¯Ÿæ›´æ–°",children:[]},{level:3,title:"2. React DevTools Profiler",slug:"_2-react-devtools-profiler",children:[]},{level:3,title:"3. æ–­ç‚¹è°ƒè¯•æºç ",slug:"_3-æ–­ç‚¹è°ƒè¯•æºç ",children:[]}]},{level:2,title:"æ€»ç»“",slug:"æ€»ç»“",children:[{level:3,title:"React æ›´æ–°çš„æ ¸å¿ƒæ€æƒ³",slug:"react-æ›´æ–°çš„æ ¸å¿ƒæ€æƒ³",children:[]},{level:3,title:"å…³é”®ä¼˜åŒ–ç‚¹",slug:"å…³é”®ä¼˜åŒ–ç‚¹",children:[]},{level:3,title:"æœ€ä½³å®è·µ",slug:"æœ€ä½³å®è·µ",children:[]}]}],git:{updatedTime:1767201013e3},filePathRelative:"mack/Reactæ›´æ–°æµç¨‹è¯¦è§£.md"}},396:(n,s,a)=>{a.r(s),a.d(s,{default:()=>k});var p=a(6252);const e=(0,p.uE)('<h1 id="react-æ›´æ–°æµç¨‹è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#react-æ›´æ–°æµç¨‹è¯¦è§£" aria-hidden="true">#</a> React æ›´æ–°æµç¨‹è¯¦è§£</h1><h2 id="æ¦‚è§ˆ-ä»-setstate-åˆ°-dom-æ›´æ–°çš„å®Œæ•´æ—…ç¨‹" tabindex="-1"><a class="header-anchor" href="#æ¦‚è§ˆ-ä»-setstate-åˆ°-dom-æ›´æ–°çš„å®Œæ•´æ—…ç¨‹" aria-hidden="true">#</a> æ¦‚è§ˆï¼šä» setState åˆ° DOM æ›´æ–°çš„å®Œæ•´æ—…ç¨‹</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ç”¨æˆ·æ“ä½œ\n   â†“\nè§¦å‘æ›´æ–°ï¼ˆsetState/useState/useReducerï¼‰\n   â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  é˜¶æ®µ1: è°ƒåº¦é˜¶æ®µ (Schedule)                      â”‚\nâ”‚  - åˆ›å»º Update å¯¹è±¡                              â”‚\nâ”‚  - è®¡ç®—ä¼˜å…ˆçº§ (lanes)                            â”‚\nâ”‚  - ä»»åŠ¡å…¥é˜Ÿ                                      â”‚\nâ”‚  - Scheduler è°ƒåº¦                                â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n   â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  é˜¶æ®µ2: åè°ƒé˜¶æ®µ (Render/Reconciliation)         â”‚\nâ”‚  âš ï¸ å¯ä¸­æ–­ã€å¯é‡å¤æ‰§è¡Œ                            â”‚\nâ”‚  - beginWork (å‘ä¸‹éå†)                          â”‚\nâ”‚  - Diff ç®—æ³•                                     â”‚\nâ”‚  - æ ‡è®°å‰¯ä½œç”¨ (effectTag)                        â”‚\nâ”‚  - completeWork (å‘ä¸Šå›æº¯)                       â”‚\nâ”‚  - æ„å»º effectList                               â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n   â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  é˜¶æ®µ3: æäº¤é˜¶æ®µ (Commit)                        â”‚\nâ”‚  âš ï¸ åŒæ­¥æ‰§è¡Œã€ä¸å¯ä¸­æ–­                            â”‚\nâ”‚  - before mutation                               â”‚\nâ”‚  - mutation (çœŸå® DOM æ“ä½œ)                      â”‚\nâ”‚  - layout (useLayoutEffect/componentDidMount)   â”‚\nâ”‚  - åˆ‡æ¢ Fiber æ ‘æŒ‡é’ˆ                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n   â†“\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  é˜¶æ®µ4: å‰¯ä½œç”¨æ‰§è¡Œ (Effect)                      â”‚\nâ”‚  âš ï¸ å¼‚æ­¥æ‰§è¡Œ                                      â”‚\nâ”‚  - æ‰§è¡Œ useEffect cleanup                        â”‚\nâ”‚  - æ‰§è¡Œ useEffect callback                       â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n   â†“\næµè§ˆå™¨ç»˜åˆ¶ï¼Œç”¨æˆ·çœ‹åˆ°æ–°ç•Œé¢\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><hr><h2 id="é˜¶æ®µ-1-è°ƒåº¦é˜¶æ®µ-schedule" tabindex="-1"><a class="header-anchor" href="#é˜¶æ®µ-1-è°ƒåº¦é˜¶æ®µ-schedule" aria-hidden="true">#</a> é˜¶æ®µ 1: è°ƒåº¦é˜¶æ®µ (Schedule)</h2><h3 id="_1-1-æ ¸å¿ƒèŒè´£" tabindex="-1"><a class="header-anchor" href="#_1-1-æ ¸å¿ƒèŒè´£" aria-hidden="true">#</a> 1.1 æ ¸å¿ƒèŒè´£</h3><p><strong>å†³å®š&quot;ä½•æ—¶æ‰§è¡Œ&quot;ã€&quot;å¦‚ä½•æ‰§è¡Œ&quot;æ›´æ–°ä»»åŠ¡</strong></p><h3 id="_1-2-è¯¦ç»†æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_1-2-è¯¦ç»†æµç¨‹" aria-hidden="true">#</a> 1.2 è¯¦ç»†æµç¨‹</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ========== æ­¥éª¤1: è§¦å‘æ›´æ–° ==========</span>\n<span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. åˆ›å»º Update å¯¹è±¡</span>\n  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>\n    <span class="token literal-property property">lane</span><span class="token operator">:</span> <span class="token function">getCurrentPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// ä¼˜å…ˆçº§</span>\n    <span class="token literal-property property">action</span><span class="token operator">:</span> newState<span class="token punctuation">,</span> <span class="token comment">// æ–°çŠ¶æ€</span>\n    <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// æŒ‡å‘ä¸‹ä¸€ä¸ª Update</span>\n    <span class="token literal-property property">callback</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token comment">// å›è°ƒå‡½æ•°</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 2. å°† Update åŠ å…¥ Fiber çš„ updateQueue</span>\n  <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getCurrentFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span>\n\n  <span class="token comment">// 3. ä»å½“å‰ Fiber å‘ä¸Šæ ‡è®°åˆ°æ ¹èŠ‚ç‚¹</span>\n  <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ­¥éª¤2: æ ‡è®°æ›´æ–°è·¯å¾„ ==========</span>\n<span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ä»å½“å‰ Fiber ä¸€è·¯å‘ä¸Šåˆ° rootï¼Œæ ‡è®° lanes</span>\n  <span class="token keyword">let</span> node <span class="token operator">=</span> fiber\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    node<span class="token punctuation">.</span>lanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> update<span class="token punctuation">.</span>lane<span class="token punctuation">)</span>\n    node <span class="token operator">=</span> node<span class="token punctuation">.</span>return <span class="token comment">// å‘ä¸Šéå†</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œè°ƒåº¦æ ¹èŠ‚ç‚¹æ›´æ–°</span>\n  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">getRootFromFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ­¥éª¤3: ä¼˜å…ˆçº§è®¡ç®— ==========</span>\n<span class="token keyword">function</span> <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. è·å–å½“å‰æœ€é«˜ä¼˜å…ˆçº§</span>\n  <span class="token keyword">const</span> nextLanes <span class="token operator">=</span> <span class="token function">getNextLanes</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>\n\n  <span class="token comment">// 2. åˆ¤æ–­ä¼˜å…ˆçº§ç±»å‹</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">includesSyncLane</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// åŒæ­¥ä¼˜å…ˆçº§ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰â†’ ç«‹å³æ‰§è¡Œ</span>\n    <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å¹¶å‘ä¼˜å…ˆçº§ â†’ é€šè¿‡ Scheduler è°ƒåº¦</span>\n    <span class="token keyword">const</span> schedulerPriority <span class="token operator">=</span> <span class="token function">lanesToSchedulerPriority</span><span class="token punctuation">(</span>nextLanes<span class="token punctuation">)</span>\n    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>\n      schedulerPriority<span class="token punctuation">,</span>\n      <span class="token function">performConcurrentWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ­¥éª¤4: Scheduler è°ƒåº¦ ==========</span>\n<span class="token keyword">function</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// Scheduler è´Ÿè´£æ—¶é—´åˆ‡ç‰‡å’Œä»»åŠ¡è°ƒåº¦</span>\n  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> timeout <span class="token operator">=</span> <span class="token function">timeoutForPriorityLevel</span><span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> timeout\n\n  <span class="token keyword">const</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>\n    callback<span class="token punctuation">,</span>\n    priorityLevel<span class="token punctuation">,</span>\n    expirationTime<span class="token punctuation">,</span>\n    <span class="token literal-property property">sortIndex</span><span class="token operator">:</span> expirationTime\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå°é¡¶å †ï¼ŒæŒ‰è¿‡æœŸæ—¶é—´æ’åºï¼‰</span>\n  <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span>\n\n  <span class="token comment">// è¯·æ±‚è°ƒåº¦</span>\n  <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h3 id="_1-3-ä¼˜å…ˆçº§æ¨¡å‹-lane" tabindex="-1"><a class="header-anchor" href="#_1-3-ä¼˜å…ˆçº§æ¨¡å‹-lane" aria-hidden="true">#</a> 1.3 ä¼˜å…ˆçº§æ¨¡å‹ï¼ˆLaneï¼‰</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 31 æ¡è½¦é“ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span>\n<span class="token keyword">const</span> SyncLane <span class="token operator">=</span> <span class="token number">0b0000000000000000000000000000001</span><span class="token punctuation">;</span>              <span class="token comment">// 1 - åŒæ­¥ï¼ˆæœ€é«˜ï¼‰</span>\n<span class="token keyword">const</span> InputContinuousLane <span class="token operator">=</span> <span class="token number">0b0000000000000000000000000000100</span><span class="token punctuation">;</span>   <span class="token comment">// 4 - è¿ç»­è¾“å…¥</span>\n<span class="token keyword">const</span> DefaultLane <span class="token operator">=</span> <span class="token number">0b0000000000000000000000000010000</span><span class="token punctuation">;</span>           <span class="token comment">// 16 - é»˜è®¤</span>\n<span class="token keyword">const</span> TransitionLane1 <span class="token operator">=</span> <span class="token number">0b0000000000000000000000001000000</span><span class="token punctuation">;</span>       <span class="token comment">// 64 - Transition</span>\n<span class="token keyword">const</span> IdleLane <span class="token operator">=</span> <span class="token number">0b0100000000000000000000000000000</span><span class="token punctuation">;</span>              <span class="token comment">// æœ€ä½ä¼˜å…ˆçº§</span>\n\n<span class="token comment">// å®é™…æ¡ˆä¾‹</span>\nonClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// SyncLane - ç”¨æˆ·äº¤äº’ï¼Œç«‹å³å“åº”</span>\n<span class="token punctuation">}</span><span class="token punctuation">}</span>\n\n<span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token function">setList</span><span class="token punctuation">(</span>newList<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// TransitionLane - å¯å»¶è¿Ÿæ›´æ–°</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_1-4-æ—¶é—´åˆ‡ç‰‡åŸç†" tabindex="-1"><a class="header-anchor" href="#_1-4-æ—¶é—´åˆ‡ç‰‡åŸç†" aria-hidden="true">#</a> 1.4 æ—¶é—´åˆ‡ç‰‡åŸç†</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Scheduler çš„å·¥ä½œå¾ªç¯</span>\n<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> initialTime\n  <span class="token keyword">let</span> currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token comment">// è·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡</span>\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> currentTime <span class="token operator">&amp;&amp;</span> <span class="token comment">// æœªè¿‡æœŸ</span>\n      <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining <span class="token operator">||</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// ä¸”æ—¶é—´ç‰‡ç”¨å®Œ</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// è®©å‡ºä¸»çº¿ç¨‹ï¼Œä¸‹ä¸€å¸§ç»§ç»­</span>\n      <span class="token keyword">break</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">const</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback\n    <span class="token keyword">const</span> continuationCallback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// æ‰§è¡Œä»»åŠ¡</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> continuationCallback <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ä»»åŠ¡æœªå®Œæˆï¼Œç»§ç»­ç­‰å¾…è°ƒåº¦</span>\n      currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> continuationCallback\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ä»»åŠ¡å®Œæˆï¼Œç§»å‡ºé˜Ÿåˆ—</span>\n      <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// å¦‚æœè¿˜æœ‰ä»»åŠ¡ï¼Œç»§ç»­è°ƒåº¦</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token boolean">true</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> <span class="token boolean">false</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// åˆ¤æ–­æ˜¯å¦åº”è¯¥è®©å‡ºä¸»çº¿ç¨‹</span>\n<span class="token keyword">function</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> currentTime <span class="token operator">&gt;=</span> deadline <span class="token comment">// é»˜è®¤ 5ms ä¸€ä¸ªæ—¶é—´ç‰‡</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><h3 id="_1-5-å®é™…æ¡ˆä¾‹æ¼”ç¤º" tabindex="-1"><a class="header-anchor" href="#_1-5-å®é™…æ¡ˆä¾‹æ¼”ç¤º" aria-hidden="true">#</a> 1.5 å®é™…æ¡ˆä¾‹æ¼”ç¤º</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿè¾“å…¥æœç´¢æ¡†</span>\n<span class="token keyword">function</span> <span class="token function">SearchBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>query<span class="token punctuation">,</span> setQuery<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>results<span class="token punctuation">,</span> setResults<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> value <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value\n\n    <span class="token comment">// ç´§æ€¥æ›´æ–°ï¼šç«‹å³æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤ºï¼ˆSyncLaneï¼‰</span>\n    <span class="token function">setQuery</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>\n\n    <span class="token comment">// éç´§æ€¥æ›´æ–°ï¼šæœç´¢ç»“æœå¯ä»¥å»¶è¿Ÿï¼ˆTransitionLaneï¼‰</span>\n    <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> filtered <span class="token operator">=</span> hugeDataSet<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>\n      <span class="token function">setResults</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>input value<span class="token operator">=</span><span class="token punctuation">{</span>query<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n      <span class="token punctuation">{</span><span class="token comment">/* ç”¨æˆ·è¾“å…¥ä¸ä¼šè¢«æœç´¢è®¡ç®—é˜»å¡ */</span><span class="token punctuation">}</span>\n      <span class="token operator">&lt;</span>ResultList data<span class="token operator">=</span><span class="token punctuation">{</span>results<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>è°ƒåº¦æµç¨‹åˆ†æï¼š</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ç”¨æˆ·è¾“å…¥ &quot;R&quot;\n  â†“\nåˆ›å»º 2 ä¸ª Updateï¼š\n  - Update1: setQuery(&quot;R&quot;) - SyncLane (ä¼˜å…ˆçº§1)\n  - Update2: setResults([...]) - TransitionLane (ä¼˜å…ˆçº§64)\n  â†“\nScheduler è°ƒåº¦ï¼š\n  - å…ˆæ‰§è¡Œ Update1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰â†’ è¾“å…¥æ¡†ç«‹å³æ˜¾ç¤º &quot;R&quot;\n  - åæ‰§è¡Œ Update2ï¼ˆä½ä¼˜å…ˆçº§ï¼‰â†’ æœç´¢ç»“æœå»¶è¿Ÿæ›´æ–°\n  â†“\nå¦‚æœç”¨æˆ·ç»§ç»­è¾“å…¥ &quot;Re&quot;ï¼š\n  - æ–°çš„ Update1 æ‰“æ–­ Update2\n  - åºŸå¼ƒæœªå®Œæˆçš„æœç´¢ä»»åŠ¡\n  - é‡æ–°å¼€å§‹æ–°çš„æœç´¢\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><hr><h2 id="é˜¶æ®µ-2-åè°ƒé˜¶æ®µ-render-reconciliation" tabindex="-1"><a class="header-anchor" href="#é˜¶æ®µ-2-åè°ƒé˜¶æ®µ-render-reconciliation" aria-hidden="true">#</a> é˜¶æ®µ 2: åè°ƒé˜¶æ®µ (Render/Reconciliation)</h2><h3 id="_2-1-æ ¸å¿ƒèŒè´£" tabindex="-1"><a class="header-anchor" href="#_2-1-æ ¸å¿ƒèŒè´£" aria-hidden="true">#</a> 2.1 æ ¸å¿ƒèŒè´£</h3><p><strong>è®¡ç®—&quot;è¦åšä»€ä¹ˆ&quot;DOM å˜æ›´ï¼Œä½†ä¸çœŸæ­£æ‰§è¡Œ</strong></p><h3 id="_2-2-åŒç¼“å†²æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-2-åŒç¼“å†²æœºåˆ¶" aria-hidden="true">#</a> 2.2 åŒç¼“å†²æœºåˆ¶</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// React ç»´æŠ¤ä¸¤æ£µ Fiber æ ‘</span>\n<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token literal-property property">current</span><span class="token operator">:</span> currentFiberTree<span class="token punctuation">,</span> <span class="token comment">// å½“å‰å±å¹•æ˜¾ç¤ºçš„æ ‘</span>\n  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token comment">// æ­£åœ¨æ„å»ºçš„æ–°æ ‘</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// current æ ‘å’Œ workInProgress æ ‘é€šè¿‡ alternate äº’ç›¸æŒ‡å‘</span>\ncurrentFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgressFiber\nworkInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentFiber\n\n<span class="token comment">// åè°ƒé˜¶æ®µï¼šåœ¨ workInProgress æ ‘ä¸Šå·¥ä½œ</span>\n<span class="token comment">// æäº¤é˜¶æ®µï¼šåˆ‡æ¢ current æŒ‡é’ˆ</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>åˆå§‹çŠ¶æ€ï¼š\ncurrent æ ‘ (æ˜¾ç¤ºåœ¨å±å¹•)        workInProgress æ ‘ (ä¸å­˜åœ¨)\n    App                              null\n    â†“\n   div\n    â†“\n  &quot;Hello&quot;\n\nè§¦å‘æ›´æ–° setState(&quot;World&quot;)ï¼š\ncurrent æ ‘ (ä»ç„¶æ˜¾ç¤º)          workInProgress æ ‘ (åå°æ„å»º)\n    App â†â”€â”€alternateâ”€â”€â†’            App&#39;\n    â†“                              â†“\n   div  â†â”€â”€alternateâ”€â”€â†’           div&#39;\n    â†“                              â†“\n  &quot;Hello&quot;                        &quot;World&quot;  (æ–°è®¡ç®—çš„)\n\næäº¤å®Œæˆåï¼š\næ—§ current æ ‘                   æ–° current æ ‘ (åˆ‡æ¢æŒ‡é’ˆ)\n    App                              App&#39;\n    â†“                                â†“\n   div                              div&#39;\n    â†“                                â†“\n  &quot;Hello&quot;                          &quot;World&quot; â† ç”¨æˆ·çœ‹åˆ°è¿™ä¸ª\n  (å˜æˆå¤‡ç”¨æ ‘)\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_2-3-è¯¦ç»†æµç¨‹-beginwork" tabindex="-1"><a class="header-anchor" href="#_2-3-è¯¦ç»†æµç¨‹-beginwork" aria-hidden="true">#</a> 2.3 è¯¦ç»†æµç¨‹ï¼šbeginWork</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ========== å‘ä¸‹éå†ï¼šbeginWork ==========</span>\n<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// current: æ—§ Fiber</span>\n  <span class="token comment">// workInProgress: æ–° Fiber</span>\n\n  <span class="token comment">// 1. åˆ¤æ–­æ˜¯å¦å¯ä»¥å¤ç”¨</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps\n    <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>\n      oldProps <span class="token operator">===</span> newProps <span class="token operator">&amp;&amp;</span> <span class="token comment">// props æ²¡å˜</span>\n      <span class="token operator">!</span><span class="token function">hasContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// context æ²¡å˜</span>\n    <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ğŸ¯ bailoutï¼šè·³è¿‡è¯¥å­æ ‘ï¼Œå¤ç”¨æ—§ Fiber</span>\n      <span class="token keyword">return</span> <span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// 2. æ ¹æ®ç»„ä»¶ç±»å‹å¤„ç†</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>\n    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span>\n      <span class="token keyword">return</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>\n    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span> <span class="token comment">// åŸç”Ÿ DOM æ ‡ç­¾</span>\n      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== å‡½æ•°ç»„ä»¶æ›´æ–° ==========</span>\n<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type\n  <span class="token keyword">const</span> props <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps\n\n  <span class="token comment">// 1. æ‰§è¡Œå‡½æ•°ç»„ä»¶ï¼Œè·å– children</span>\n  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token comment">// è°ƒç”¨ useStateã€useEffect ç­‰</span>\n\n  <span class="token comment">// 2. è°ƒå’Œå­èŠ‚ç‚¹ï¼ˆDiff ç®—æ³•æ ¸å¿ƒï¼‰</span>\n  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> children<span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child <span class="token comment">// è¿”å›ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== åè°ƒå­èŠ‚ç‚¹ï¼ˆDiffï¼‰ ==========</span>\n<span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// åˆæ¬¡æŒ‚è½½ï¼šç›´æ¥åˆ›å»ºæ–° Fiber</span>\n    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> children<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    <span class="token comment">// æ›´æ–°ï¼šå¯¹æ¯”æ–°æ—§å­èŠ‚ç‚¹</span>\n    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>\n      workInProgress<span class="token punctuation">,</span>\n      current<span class="token punctuation">.</span>child<span class="token punctuation">,</span> <span class="token comment">// æ—§å­èŠ‚ç‚¹</span>\n      children <span class="token comment">// æ–°å­èŠ‚ç‚¹</span>\n    <span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="_2-4-diff-ç®—æ³•è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#_2-4-diff-ç®—æ³•è¯¦è§£" aria-hidden="true">#</a> 2.4 Diff ç®—æ³•è¯¦è§£</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ========== Diff ç®—æ³•ï¼š3 ç§æƒ…å†µ ==========</span>\n<span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// æƒ…å†µ1: å•èŠ‚ç‚¹ Diff</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// æƒ…å†µ2: å¤šèŠ‚ç‚¹ Diffï¼ˆæœ€å¤æ‚ï¼‰</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// æƒ…å†µ3: æ–‡æœ¬èŠ‚ç‚¹</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token function">reconcileSingleTextNode</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// å…¶ä»–æƒ…å†µï¼šåˆ é™¤æ‰€æœ‰æ—§å­èŠ‚ç‚¹</span>\n  <span class="token keyword">return</span> <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== å•èŠ‚ç‚¹ Diff ==========</span>\n<span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key\n  <span class="token keyword">let</span> child <span class="token operator">=</span> currentFirstChild\n\n  <span class="token comment">// éå†æ—§å­èŠ‚ç‚¹ï¼Œæ‰¾æ˜¯å¦æœ‰å¯å¤ç”¨çš„</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>type <span class="token operator">===</span> element<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// âœ… key å’Œ type éƒ½ç›¸åŒ â†’ å¤ç”¨</span>\n        <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token comment">// åˆ é™¤å…¶ä»–å…„å¼Ÿ</span>\n        <span class="token keyword">const</span> existing <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> element<span class="token punctuation">.</span>props<span class="token punctuation">)</span>\n        existing<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber\n        <span class="token keyword">return</span> existing\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// âŒ key ç›¸åŒä½† type ä¸åŒ â†’ åˆ é™¤æ‰€æœ‰æ—§èŠ‚ç‚¹</span>\n        <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span>\n        <span class="token keyword">break</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// âŒ key ä¸åŒ â†’ æ ‡è®°åˆ é™¤</span>\n      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n    child <span class="token operator">=</span> child<span class="token punctuation">.</span>sibling\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// æ²¡æœ‰å¯å¤ç”¨çš„ï¼Œåˆ›å»ºæ–° Fiber</span>\n  <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>\n  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber\n  <span class="token keyword">return</span> created\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== å¤šèŠ‚ç‚¹ Diffï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰==========</span>\n<span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span>\n  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span>\n  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild\n  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span>\n  <span class="token keyword">let</span> lastPlacedIndex <span class="token operator">=</span> <span class="token number">0</span>\n\n  <span class="token comment">// ğŸ”¹ ç¬¬ä¸€è½®éå†ï¼šå¤„ç†æ›´æ–°çš„èŠ‚ç‚¹</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>key <span class="token operator">===</span> newChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// key ç›¸åŒï¼Œå°è¯•å¤ç”¨</span>\n      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// âœ… å¤ç”¨æˆåŠŸ</span>\n        newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIdx\n        lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>previousNewFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        resultingFirstChild <span class="token operator">=</span> newFiber\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber\n      <span class="token punctuation">}</span>\n      previousNewFiber <span class="token operator">=</span> newFiber\n      oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// key ä¸åŒï¼Œè·³å‡ºç¬¬ä¸€è½®</span>\n      <span class="token keyword">break</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ğŸ”¹ ç¬¬äºŒè½®éå†ï¼šå¤„ç†å‰©ä½™èŠ‚ç‚¹</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// æ–°èŠ‚ç‚¹éå†å®Œï¼Œåˆ é™¤å‰©ä½™æ—§èŠ‚ç‚¹</span>\n    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span>\n    <span class="token keyword">return</span> resultingFirstChild\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// æ—§èŠ‚ç‚¹éå†å®Œï¼Œæ–°å¢å‰©ä½™æ–°èŠ‚ç‚¹</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span>\n      <span class="token comment">// ... æ’å…¥é€»è¾‘</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">return</span> resultingFirstChild\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// ğŸ”¹ ç¬¬ä¸‰è½®éå†ï¼šå¤„ç†ç§»åŠ¨çš„èŠ‚ç‚¹</span>\n  <span class="token comment">// å°†å‰©ä½™æ—§èŠ‚ç‚¹æ”¾å…¥ Mapï¼Œkey â†’ fiber</span>\n  <span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span>\n\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span>\n    <span class="token keyword">const</span> matchedFiber <span class="token operator">=</span> existingChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>matchedFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// åœ¨ Map ä¸­æ‰¾åˆ°äº†ï¼Œå¯ä»¥å¤ç”¨</span>\n      existingChildren<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span>\n      <span class="token comment">// ... æ ‡è®°ç§»åŠ¨æˆ–ä¸ç§»åŠ¨</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// æ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹</span>\n      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span>\n      <span class="token comment">// ...</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// åˆ é™¤ Map ä¸­å‰©ä½™çš„æ—§èŠ‚ç‚¹ï¼ˆåœ¨æ–°åˆ—è¡¨ä¸­ä¸å­˜åœ¨ï¼‰</span>\n  existingChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> resultingFirstChild\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br></div></div><h3 id="_2-5-diff-ç®—æ³•æ¡ˆä¾‹æ¼”ç¤º" tabindex="-1"><a class="header-anchor" href="#_2-5-diff-ç®—æ³•æ¡ˆä¾‹æ¼”ç¤º" aria-hidden="true">#</a> 2.5 Diff ç®—æ³•æ¡ˆä¾‹æ¼”ç¤º</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// æ¡ˆä¾‹1: ç®€å•æ›´æ–°</span>\n<span class="token comment">// æ—§: [A, B, C]</span>\n<span class="token comment">// æ–°: [A, B, D]</span>\n\n<span class="token comment">// ç¬¬ä¸€è½®éå†ï¼š</span>\n<span class="token comment">// A vs A: key ç›¸åŒï¼Œtype ç›¸åŒ â†’ âœ… å¤ç”¨</span>\n<span class="token comment">// B vs B: key ç›¸åŒï¼Œtype ç›¸åŒ â†’ âœ… å¤ç”¨</span>\n<span class="token comment">// C vs D: key ä¸åŒ â†’ è·³å‡º</span>\n\n<span class="token comment">// ç¬¬ä¸‰è½®éå†ï¼š</span>\n<span class="token comment">// åˆ é™¤ Cï¼Œæ–°å¢ D</span>\n\n<span class="token comment">// ç»“æœï¼šeffectTag</span>\n<span class="token comment">// A: Update (æ— å˜åŒ–ä½†æ£€æŸ¥è¿‡)</span>\n<span class="token comment">// B: Update</span>\n<span class="token comment">// C: Deletion</span>\n<span class="token comment">// D: Placement</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// æ¡ˆä¾‹2: åˆ—è¡¨åè½¬</span>\n<span class="token comment">// æ—§: [A(0), B(1), C(2)]</span>\n<span class="token comment">// æ–°: [C(2), B(1), A(0)]</span>\n\n<span class="token comment">// ç¬¬ä¸€è½®éå†ï¼š</span>\n<span class="token comment">// A vs C: key ä¸åŒ â†’ ç«‹å³è·³å‡º</span>\n\n<span class="token comment">// ç¬¬ä¸‰è½®éå†ï¼ˆç”¨ Mapï¼‰ï¼š</span>\n<span class="token comment">// existingChildren = { A: fiber_A, B: fiber_B, C: fiber_C }</span>\n\n<span class="token comment">// å¤„ç† C: åœ¨ Map ä¸­æ‰¾åˆ° fiber_C</span>\n<span class="token comment">//   - oldIndex = 2, lastPlacedIndex = 0</span>\n<span class="token comment">//   - 2 &gt; 0 â†’ ä¸éœ€è¦ç§»åŠ¨ âœ…</span>\n<span class="token comment">//   - lastPlacedIndex = 2</span>\n\n<span class="token comment">// å¤„ç† B: åœ¨ Map ä¸­æ‰¾åˆ° fiber_B</span>\n<span class="token comment">//   - oldIndex = 1, lastPlacedIndex = 2</span>\n<span class="token comment">//   - 1 &lt; 2 â†’ éœ€è¦ç§»åŠ¨ âš ï¸</span>\n<span class="token comment">//   - effectTag = Placement</span>\n\n<span class="token comment">// å¤„ç† A: åœ¨ Map ä¸­æ‰¾åˆ° fiber_A</span>\n<span class="token comment">//   - oldIndex = 0, lastPlacedIndex = 2</span>\n<span class="token comment">//   - 0 &lt; 2 â†’ éœ€è¦ç§»åŠ¨ âš ï¸</span>\n<span class="token comment">//   - effectTag = Placement</span>\n\n<span class="token comment">// ç»“æœï¼š</span>\n<span class="token comment">// C: ä¸åŠ¨</span>\n<span class="token comment">// B: ç§»åŠ¨åˆ° C åé¢</span>\n<span class="token comment">// A: ç§»åŠ¨åˆ° B åé¢</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_2-6-completework-å‘ä¸Šå›æº¯" tabindex="-1"><a class="header-anchor" href="#_2-6-completework-å‘ä¸Šå›æº¯" aria-hidden="true">#</a> 2.6 completeWorkï¼ˆå‘ä¸Šå›æº¯ï¼‰</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ========== completeWorkï¼šå®ŒæˆèŠ‚ç‚¹å¤„ç† ==========</span>\n<span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps\n\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// åŸç”Ÿ DOM æ ‡ç­¾</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// æ›´æ–°ï¼šæ ‡è®°éœ€è¦æ›´æ–°çš„å±æ€§</span>\n        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        <span class="token comment">// æŒ‚è½½ï¼šåˆ›å»ºçœŸå® DOM èŠ‚ç‚¹</span>\n        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span>\n\n        <span class="token comment">// å°†å­èŠ‚ç‚¹çš„ DOM æ’å…¥åˆ°å½“å‰ DOM</span>\n        <span class="token function">appendAllChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span>\n\n        workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance\n      <span class="token punctuation">}</span>\n      <span class="token keyword">break</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token keyword">null</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== åˆ›å»ºçœŸå® DOM ==========</span>\n<span class="token keyword">function</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> domElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>\n  <span class="token comment">// è®¾ç½®å±æ€§</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> propKey <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token keyword">continue</span>\n    domElement<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> domElement\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ”¶é›†å­èŠ‚ç‚¹çš„ DOM ==========</span>\n<span class="token keyword">function</span> <span class="token function">appendAllChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> node <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>child\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// æ˜¯åŸç”ŸèŠ‚ç‚¹ï¼Œç›´æ¥æ’å…¥</span>\n      parent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// æ˜¯ç»„ä»¶ï¼Œç»§ç»­å‘ä¸‹æ‰¾</span>\n      node <span class="token operator">=</span> node<span class="token punctuation">.</span>child\n      <span class="token keyword">continue</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// å‘ä¸Šå›æº¯åˆ°å…„å¼ŸèŠ‚ç‚¹</span>\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span>\n      <span class="token punctuation">}</span>\n      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return\n    <span class="token punctuation">}</span>\n    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h3 id="_2-7-effectlist-å‰¯ä½œç”¨é“¾è¡¨" tabindex="-1"><a class="header-anchor" href="#_2-7-effectlist-å‰¯ä½œç”¨é“¾è¡¨" aria-hidden="true">#</a> 2.7 effectListï¼ˆå‰¯ä½œç”¨é“¾è¡¨ï¼‰</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// åœ¨ completeWork ä¸­æ”¶é›†æœ‰å‰¯ä½œç”¨çš„èŠ‚ç‚¹</span>\n<span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ... å¤„ç†èŠ‚ç‚¹ ...</span>\n\n  <span class="token comment">// æ”¶é›† effect</span>\n  <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>return\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å°†å½“å‰èŠ‚ç‚¹çš„ effectList æ¥åˆ°çˆ¶èŠ‚ç‚¹</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>firstEffect\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>firstEffect\n      <span class="token punctuation">}</span>\n      returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>lastEffect\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å‰¯ä½œç”¨ï¼ŒåŠ å…¥é“¾è¡¨</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>flags <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> workInProgress\n      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n        returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgress\n      <span class="token punctuation">}</span>\n      returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgress\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ç¤ºä¾‹ Fiber æ ‘ï¼š\n       App\n      /   \\\n    div   div(Update)\n    /      \\\n  p(Placement)  span(Deletion)\n\næ„å»ºçš„ effectListï¼ˆå•é“¾è¡¨ï¼‰ï¼š\np(Placement) â†’ span(Deletion) â†’ div(Update) â†’ null\n\næäº¤é˜¶æ®µåªéœ€éå†è¿™ä¸ªé“¾è¡¨ï¼Œè€Œä¸æ˜¯æ•´æ£µæ ‘ï¼\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><hr><h2 id="é˜¶æ®µ-3-æäº¤é˜¶æ®µ-commit" tabindex="-1"><a class="header-anchor" href="#é˜¶æ®µ-3-æäº¤é˜¶æ®µ-commit" aria-hidden="true">#</a> é˜¶æ®µ 3: æäº¤é˜¶æ®µ (Commit)</h2><h3 id="_3-1-æ ¸å¿ƒèŒè´£" tabindex="-1"><a class="header-anchor" href="#_3-1-æ ¸å¿ƒèŒè´£" aria-hidden="true">#</a> 3.1 æ ¸å¿ƒèŒè´£</h3><p><strong>æ‰§è¡ŒçœŸå®çš„ DOM æ“ä½œå’Œç”Ÿå‘½å‘¨æœŸ</strong></p><h3 id="_3-2-ä¸‰ä¸ªå­é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_3-2-ä¸‰ä¸ªå­é˜¶æ®µ" aria-hidden="true">#</a> 3.2 ä¸‰ä¸ªå­é˜¶æ®µ</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork <span class="token comment">// workInProgress æ ‘çš„æ ¹èŠ‚ç‚¹</span>\n\n  <span class="token comment">// ğŸ”¹ å­é˜¶æ®µ1: before mutationï¼ˆDOM å˜æ›´å‰ï¼‰</span>\n  <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span>\n\n  <span class="token comment">// ğŸ”¹ å­é˜¶æ®µ2: mutationï¼ˆDOM å˜æ›´ï¼‰</span>\n  <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> root<span class="token punctuation">)</span>\n\n  <span class="token comment">// ğŸ¯ åˆ‡æ¢ Fiber æ ‘æŒ‡é’ˆï¼ˆå…³é”®æ—¶åˆ»ï¼‰</span>\n  root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork\n\n  <span class="token comment">// ğŸ”¹ å­é˜¶æ®µ3: layoutï¼ˆDOM å˜æ›´åï¼‰</span>\n  <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> root<span class="token punctuation">)</span>\n\n  <span class="token comment">// å¼‚æ­¥è°ƒåº¦ useEffect</span>\n  <span class="token function">schedulePassiveEffects</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_3-3-before-mutation-é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_3-3-before-mutation-é˜¶æ®µ" aria-hidden="true">#</a> 3.3 before mutation é˜¶æ®µ</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">firstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> fiber <span class="token operator">=</span> firstChild\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>fiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// å¤„ç†ç±»ç»„ä»¶çš„ getSnapshotBeforeUpdate</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> ClassComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> instance <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>\n          fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">,</span>\n          fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>memoizedState\n        <span class="token punctuation">)</span>\n        instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token operator">=</span> snapshot\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// å¤„ç† DOM èŠ‚ç‚¹çš„ç„¦ç‚¹çŠ¶æ€</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// è®°å½•å½“å‰èšç„¦çš„å…ƒç´ </span>\n      <span class="token keyword">const</span> focusedElement <span class="token operator">=</span> document<span class="token punctuation">.</span>activeElement\n      <span class="token comment">// åœ¨ layout é˜¶æ®µå¯èƒ½éœ€è¦æ¢å¤ç„¦ç‚¹</span>\n    <span class="token punctuation">}</span>\n\n    fiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>nextEffect\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>ä½œç”¨ï¼š</strong></p><ul><li>è·å– DOM å˜æ›´å‰çš„å¿«ç…§ï¼ˆå¦‚æ»šåŠ¨ä½ç½®ï¼‰</li><li>ä¸º componentDidUpdate çš„ç¬¬ä¸‰ä¸ªå‚æ•° <code>snapshot</code> å‡†å¤‡æ•°æ®</li></ul><h3 id="_3-4-mutation-é˜¶æ®µ-æ ¸å¿ƒ" tabindex="-1"><a class="header-anchor" href="#_3-4-mutation-é˜¶æ®µ-æ ¸å¿ƒ" aria-hidden="true">#</a> 3.4 mutation é˜¶æ®µï¼ˆæ ¸å¿ƒï¼‰</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">firstChild<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> fiber <span class="token operator">=</span> firstChild\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>fiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> flags <span class="token operator">=</span> fiber<span class="token punctuation">.</span>flags\n\n    <span class="token comment">// ğŸ”¹ å¤„ç† ContentResetï¼ˆé‡ç½®æ–‡æœ¬å†…å®¹ï¼‰</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ContentReset<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// ğŸ”¹ å¤„ç† Refï¼ˆå…ˆè§£ç»‘æ—§ refï¼‰</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> current <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// ğŸ”¹ æ ¸å¿ƒï¼šæ ¹æ® effectTag æ‰§è¡Œ DOM æ“ä½œ</span>\n    <span class="token keyword">const</span> primaryFlags <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion<span class="token punctuation">)</span>\n\n    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Placement</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// â• æ’å…¥ DOM</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n        fiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement <span class="token comment">// æ¸…é™¤æ ‡è®°</span>\n        <span class="token keyword">break</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Update</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// ğŸ”„ æ›´æ–° DOM</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n        <span class="token keyword">break</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">Deletion</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// â– åˆ é™¤ DOM</span>\n        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span>\n        <span class="token keyword">break</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">case</span> <span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token comment">// æ’å…¥ + æ›´æ–°</span>\n        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n        <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n        <span class="token keyword">break</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    fiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>nextEffect\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ’å…¥ DOM ==========</span>\n<span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">finishedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. æ‰¾åˆ°çˆ¶ DOM èŠ‚ç‚¹</span>\n  <span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span>\n  <span class="token keyword">const</span> parentDOM <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode\n\n  <span class="token comment">// 2. æ‰¾åˆ°æ’å…¥ä½ç½®ï¼ˆå…„å¼ŸèŠ‚ç‚¹ï¼‰</span>\n  <span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span>\n\n  <span class="token comment">// 3. æ‰§è¡Œæ’å…¥</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    parentDOM<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n    parentDOM<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ›´æ–° DOM ==========</span>\n<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">finishedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token comment">// æ‰§è¡Œ useLayoutEffect çš„ cleanup</span>\n      <span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span>HookLayout<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> newProps <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>memoizedProps\n        <span class="token keyword">const</span> oldProps <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>alternate<span class="token operator">?.</span>memoizedProps\n\n        <span class="token comment">// æ›´æ–° DOM å±æ€§</span>\n        <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> oldProps<span class="token punctuation">)</span>\n      <span class="token punctuation">}</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ›´æ–° DOM å±æ€§ ==========</span>\n<span class="token keyword">function</span> <span class="token function">updateDOMProperties</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> oldProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// åˆ é™¤æ—§å±æ€§</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> propKey <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>oldProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">continue</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      domElement<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;on&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ç§»é™¤äº‹ä»¶ç›‘å¬</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      domElement<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token comment">// è®¾ç½®æ–°å±æ€§</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> propKey <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> newValue <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>\n    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> oldProps<span class="token operator">?.</span><span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> oldValue<span class="token punctuation">)</span> <span class="token keyword">continue</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// æ›´æ–°æ ·å¼</span>\n      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> styleKey <span class="token keyword">in</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        domElement<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleKey<span class="token punctuation">]</span> <span class="token operator">=</span> newValue<span class="token punctuation">[</span>styleKey<span class="token punctuation">]</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newValue <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> newValue <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        domElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newValue\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;on&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// ç»‘å®šäº‹ä»¶</span>\n      <span class="token keyword">const</span> eventType <span class="token operator">=</span> propKey<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>\n      domElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      domElement<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span> <span class="token operator">=</span> newValue\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== åˆ é™¤ DOM ==========</span>\n<span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. è§£ç»‘ ref</span>\n  <span class="token function">detachFiberRef</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n\n  <span class="token comment">// 2. é€’å½’åˆ é™¤å­æ ‘</span>\n  <span class="token function">unmountHostComponents</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n\n  <span class="token comment">// 3. ä»çˆ¶èŠ‚ç‚¹ç§»é™¤ DOM</span>\n  <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">removeChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">unmountHostComponents</span><span class="token punctuation">(</span><span class="token parameter">current</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> node <span class="token operator">=</span> current\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> ClassComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// è°ƒç”¨ componentWillUnmount</span>\n      <span class="token keyword">const</span> instance <span class="token operator">=</span> node<span class="token punctuation">.</span>stateNode\n      instance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> FunctionComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// æ‰§è¡Œ useEffect çš„ cleanup</span>\n      <span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span>HookPassive<span class="token punctuation">,</span> node<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      node <span class="token operator">=</span> node<span class="token punctuation">.</span>child\n      <span class="token keyword">continue</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">return</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span>\n      <span class="token punctuation">}</span>\n      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return\n    <span class="token punctuation">}</span>\n    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br></div></div><h3 id="_3-5-layout-é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#_3-5-layout-é˜¶æ®µ" aria-hidden="true">#</a> 3.5 layout é˜¶æ®µ</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter">finishedWork<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> fiber <span class="token operator">=</span> finishedWork\n\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>fiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> flags <span class="token operator">=</span> fiber<span class="token punctuation">.</span>flags\n\n    <span class="token comment">// ğŸ”¹ æ‰§è¡Œç”Ÿå‘½å‘¨æœŸå’Œ Hook</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Update <span class="token operator">|</span> Callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">switch</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> instance <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode\n          <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// é¦–æ¬¡æŒ‚è½½ï¼šcomponentDidMount</span>\n            instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            <span class="token comment">// æ›´æ–°ï¼šcomponentDidUpdate</span>\n            <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate\n            instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>\n              fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">,</span>\n              fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>\n              snapshot\n            <span class="token punctuation">)</span>\n          <span class="token punctuation">}</span>\n          <span class="token keyword">break</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n          <span class="token comment">// æ‰§è¡Œ useLayoutEffect çš„ callback</span>\n          <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>HookLayout<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span>\n          <span class="token keyword">break</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token comment">// ğŸ”¹ ç»‘å®š Ref</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n\n    fiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>nextEffect\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== ç»‘å®š Ref ==========</span>\n<span class="token keyword">function</span> <span class="token function">commitAttachRef</span><span class="token punctuation">(</span><span class="token parameter">finishedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> ref <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>ref\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ref <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// å‡½æ•°å½¢å¼ï¼šref={(node) =&gt; this.divRef = node}</span>\n      <span class="token function">ref</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// å¯¹è±¡å½¢å¼ï¼šref={this.divRef}</span>\n      ref<span class="token punctuation">.</span>current <span class="token operator">=</span> instance\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h3 id="_3-6-å®é™…æ¡ˆä¾‹-å®Œæ•´æ›´æ–°æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_3-6-å®é™…æ¡ˆä¾‹-å®Œæ•´æ›´æ–°æµç¨‹" aria-hidden="true">#</a> 3.6 å®é™…æ¡ˆä¾‹ï¼šå®Œæ•´æ›´æ–°æµç¨‹</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// åˆå§‹ç»„ä»¶</span>\n<span class="token keyword">function</span> <span class="token function">TodoApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> <span class="token punctuation">[</span>todos<span class="token punctuation">,</span> setTodos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;Learn React&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;Build App&#39;</span> <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">const</span> <span class="token function-variable function">addTodo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token function">setTodos</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span>todos<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">&#39;Deploy&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token keyword">return</span> <span class="token punctuation">(</span>\n    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>addTodo<span class="token punctuation">}</span><span class="token operator">&gt;</span>Add<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>\n      <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>\n        <span class="token punctuation">{</span>todos<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">todo</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>\n          <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>\n        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n      <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>\n  <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>ç‚¹å‡»æŒ‰é’®åçš„å®Œæ•´æµç¨‹ï¼š</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>1ï¸âƒ£ è°ƒåº¦é˜¶æ®µï¼š\n   - ç”¨æˆ·ç‚¹å‡» button\n   - è§¦å‘ setTodos\n   - åˆ›å»º Update {lane: SyncLane, action: newTodos}\n   - æ ‡è®° Fiber æ ‘è·¯å¾„ï¼šli â†’ ul â†’ div â†’ TodoApp â†’ root\n   - Scheduler ç«‹å³è°ƒåº¦ï¼ˆSyncLaneï¼‰\n\n2ï¸âƒ£ åè°ƒé˜¶æ®µï¼ˆRenderï¼‰ï¼š\n\n   beginWork(TodoApp):\n     - è°ƒç”¨ TodoApp() å‡½æ•°\n     - useState è¿”å›æ–°çš„ todosï¼ˆ3 ä¸ªå…ƒç´ ï¼‰\n     - è¿”å›æ–° ReactElement æ ‘\n     - reconcileChildren â†’ å‘ç° ul çš„ children å˜åŒ–\n\n   beginWork(ul):\n     - reconcileChildrenArrayï¼šDiff åˆ—è¡¨\n     - æ—§: [li(id=1), li(id=2)]\n     - æ–°: [li(id=1), li(id=2), li(id=3)]\n     - ç¬¬ä¸€è½®éå†ï¼šli(1) å¤ç”¨ âœ…ï¼Œli(2) å¤ç”¨ âœ…\n     - ç¬¬äºŒè½®éå†ï¼šæ–°å¢ li(3) â†’ effectTag = Placement\n\n   completeWork(li(id=3)):\n     - createInstanceï¼šdocument.createElement(&#39;li&#39;)\n     - li.textContent = &#39;Deploy&#39;\n     - æ”¶é›†åˆ° effectList\n\n   completeWork(ul):\n     - æ›´æ–° ul çš„ effectList\n\n   æœ€ç»ˆ effectListï¼š\n     li(id=3, Placement) â†’ null\n\n3ï¸âƒ£ æäº¤é˜¶æ®µï¼ˆCommitï¼‰ï¼š\n\n   before mutation:\n     - æ—  getSnapshotBeforeUpdateï¼Œè·³è¿‡\n\n   mutation:\n     - éå† effectList\n     - å¤„ç† li(id=3, Placement)\n     - commitPlacement:\n       â†’ æ‰¾åˆ°çˆ¶èŠ‚ç‚¹ï¼šul.stateNode (çœŸå® DOM)\n       â†’ ul.appendChild(li_3_dom)\n       â†’ çœŸå® DOM æ ‘æ›´æ–°å®Œæˆï¼\n\n   åˆ‡æ¢æŒ‡é’ˆ:\n     - root.current = workInProgress æ ‘\n\n   layout:\n     - æ—  useLayoutEffectï¼Œè·³è¿‡\n     - ç»‘å®š refï¼ˆå¦‚æœæœ‰ï¼‰\n\n4ï¸âƒ£ æµè§ˆå™¨ç»˜åˆ¶ï¼š\n   - React è®©å‡ºä¸»çº¿ç¨‹\n   - æµè§ˆå™¨é‡ç»˜ï¼Œç”¨æˆ·çœ‹åˆ°æ–°çš„ &quot;Deploy&quot; é¡¹\n\n5ï¸âƒ£ å‰¯ä½œç”¨æ‰§è¡Œï¼ˆEffectï¼‰ï¼š\n   - å¼‚æ­¥æ‰§è¡Œ useEffectï¼ˆå¦‚æœæœ‰ï¼‰\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><hr><h2 id="é˜¶æ®µ-4-å‰¯ä½œç”¨æ‰§è¡Œ-effect" tabindex="-1"><a class="header-anchor" href="#é˜¶æ®µ-4-å‰¯ä½œç”¨æ‰§è¡Œ-effect" aria-hidden="true">#</a> é˜¶æ®µ 4: å‰¯ä½œç”¨æ‰§è¡Œ (Effect)</h2><h3 id="_4-1-useeffect-çš„å¼‚æ­¥è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#_4-1-useeffect-çš„å¼‚æ­¥è°ƒåº¦" aria-hidden="true">#</a> 4.1 useEffect çš„å¼‚æ­¥è°ƒåº¦</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// åœ¨ commit çš„ layout é˜¶æ®µç»“æŸåè°ƒåº¦</span>\n<span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ... before mutation, mutation, layout ...</span>\n\n  <span class="token comment">// ğŸ”¹ è°ƒåº¦ useEffect</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token keyword">return</span> <span class="token keyword">null</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// ========== æ‰§è¡Œ useEffect ==========</span>\n<span class="token keyword">function</span> <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. å…ˆæ‰§è¡Œæ‰€æœ‰ cleanup å‡½æ•°</span>\n  <span class="token function">commitPassiveUnmountEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">)</span>\n\n  <span class="token comment">// 2. å†æ‰§è¡Œæ‰€æœ‰ effect å‡½æ•°</span>\n  <span class="token function">commitPassiveMountEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">commitPassiveUnmountEffects</span><span class="token punctuation">(</span><span class="token parameter">firstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> fiber <span class="token operator">=</span> firstChild\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>fiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> FunctionComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> lastEffect <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>lastEffect\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next\n          <span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect\n          <span class="token keyword">do</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> destroy <span class="token operator">=</span> effect<span class="token punctuation">.</span>destroy\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>destroy <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n              <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// æ‰§è¡Œ cleanup</span>\n            <span class="token punctuation">}</span>\n            effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next\n          <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    fiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>nextEffect\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">function</span> <span class="token function">commitPassiveMountEffects</span><span class="token punctuation">(</span><span class="token parameter">firstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> fiber <span class="token operator">=</span> firstChild\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>fiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> FunctionComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">const</span> lastEffect <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>lastEffect\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n          <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next\n          <span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect\n          <span class="token keyword">do</span> <span class="token punctuation">{</span>\n            <span class="token keyword">const</span> create <span class="token operator">=</span> effect<span class="token punctuation">.</span>create\n            effect<span class="token punctuation">.</span>destroy <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// æ‰§è¡Œ effectï¼Œä¿å­˜ cleanup</span>\n            effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next\n          <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n    fiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>nextEffect\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><h3 id="_4-2-useeffect-vs-uselayouteffect" tabindex="-1"><a class="header-anchor" href="#_4-2-useeffect-vs-uselayouteffect" aria-hidden="true">#</a> 4.2 useEffect vs useLayoutEffect</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// æ‰§è¡Œæ—¶æœºå¯¹æ¯”</span>\n<span class="token keyword">function</span> <span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;1. useLayoutEffect&#39;</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;2. useLayoutEffect cleanup&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;3. useEffect&#39;</span><span class="token punctuation">)</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;4. useEffect cleanup&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;0. render&#39;</span><span class="token punctuation">)</span>\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// é¦–æ¬¡æŒ‚è½½æ‰“å°é¡ºåºï¼š</span>\n<span class="token comment">// 0. render</span>\n<span class="token comment">// 1. useLayoutEffect         â† layout é˜¶æ®µï¼ŒåŒæ­¥æ‰§è¡Œ</span>\n<span class="token comment">// (æµè§ˆå™¨ç»˜åˆ¶)</span>\n<span class="token comment">// 3. useEffect               â† æµè§ˆå™¨ç»˜åˆ¶åï¼Œå¼‚æ­¥æ‰§è¡Œ</span>\n\n<span class="token comment">// æ›´æ–°æ—¶æ‰“å°é¡ºåºï¼š</span>\n<span class="token comment">// 0. render</span>\n<span class="token comment">// 2. useLayoutEffect cleanup â† layout é˜¶æ®µï¼ŒåŒæ­¥æ‰§è¡Œ</span>\n<span class="token comment">// 1. useLayoutEffect</span>\n<span class="token comment">// (æµè§ˆå™¨ç»˜åˆ¶)</span>\n<span class="token comment">// 4. useEffect cleanup       â† æµè§ˆå™¨ç»˜åˆ¶åï¼Œå¼‚æ­¥æ‰§è¡Œ</span>\n<span class="token comment">// 3. useEffect</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><strong>é€‰æ‹©æŒ‡å—ï¼š</strong></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// âœ… ä½¿ç”¨ useEffectï¼ˆé»˜è®¤é€‰æ‹©ï¼‰</span>\n<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// - æ•°æ®è·å–</span>\n  <span class="token comment">// - è®¢é˜…äº‹ä»¶</span>\n  <span class="token comment">// - æ—¥å¿—ä¸ŠæŠ¥</span>\n  <span class="token comment">// - ä¸å½±å“å¸ƒå±€çš„ DOM æ“ä½œ</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token comment">// âœ… ä½¿ç”¨ useLayoutEffectï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰</span>\n<span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token comment">// - éœ€è¦è¯»å– DOM å¸ƒå±€ä¿¡æ¯</span>\n  <span class="token comment">// - éœ€è¦åœ¨æµè§ˆå™¨ç»˜åˆ¶å‰åŒæ­¥æ›´æ–° DOMï¼ˆé¿å…é—ªçƒï¼‰</span>\n  <span class="token comment">// - ä¸ç¬¬ä¸‰æ–¹ DOM åº“é›†æˆ</span>\n\n  <span class="token keyword">const</span> rect <span class="token operator">=</span> divRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token function">setPosition</span><span class="token punctuation">(</span>rect<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token comment">// åŸºäº DOM å°ºå¯¸çš„è®¡ç®—</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><hr><h2 id="å…³é”®æ¦‚å¿µæ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å…³é”®æ¦‚å¿µæ€»ç»“" aria-hidden="true">#</a> å…³é”®æ¦‚å¿µæ€»ç»“</h2><h3 id="_1-ä¸ºä»€ä¹ˆ-render-å¯ä¸­æ–­-commit-ä¸å¯ä¸­æ–­" tabindex="-1"><a class="header-anchor" href="#_1-ä¸ºä»€ä¹ˆ-render-å¯ä¸­æ–­-commit-ä¸å¯ä¸­æ–­" aria-hidden="true">#</a> 1. ä¸ºä»€ä¹ˆ Render å¯ä¸­æ–­ï¼ŒCommit ä¸å¯ä¸­æ–­ï¼Ÿ</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Render é˜¶æ®µï¼š\n  âœ… çº¯è®¡ç®—ï¼Œæ— å‰¯ä½œç”¨\n  âœ… åœ¨ workInProgress æ ‘ä¸Šå·¥ä½œï¼Œä¸å½±å“å±å¹•æ˜¾ç¤º\n  âœ… å¯ä»¥è¢«æ‰“æ–­åé‡æ–°å¼€å§‹ï¼Œä¸¢å¼ƒæœªå®Œæˆçš„å·¥ä½œ\n  âœ… å¤šæ¬¡æ‰§è¡ŒåŒä¸€è®¡ç®—ä¸ä¼šæœ‰é—®é¢˜\n\nCommit é˜¶æ®µï¼š\n  âŒ æœ‰å‰¯ä½œç”¨ï¼ˆDOM æ“ä½œã€ç”Ÿå‘½å‘¨æœŸï¼‰\n  âŒ ç›´æ¥å½±å“ç”¨æˆ·çœ‹åˆ°çš„ç•Œé¢\n  âŒ ä¸èƒ½æ‰§è¡Œä¸€åŠï¼Œå¿…é¡»åŸå­æ€§å®Œæˆ\n  âŒ ä¸­æ–­ä¼šå¯¼è‡´ UI æ’•è£‚ã€çŠ¶æ€ä¸ä¸€è‡´\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-åŒç¼“å†²çš„æ„ä¹‰" tabindex="-1"><a class="header-anchor" href="#_2-åŒç¼“å†²çš„æ„ä¹‰" aria-hidden="true">#</a> 2. åŒç¼“å†²çš„æ„ä¹‰</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>å°±åƒè§†é¢‘æ’­æ”¾çš„&quot;åŒç¼“å†²&quot;ï¼š\n- å‰å°ç¼“å†²åŒºï¼šç”¨æˆ·æ­£åœ¨çœ‹çš„ç”»é¢ï¼ˆcurrent æ ‘ï¼‰\n- åå°ç¼“å†²åŒºï¼šæ­£åœ¨å‡†å¤‡çš„ä¸‹ä¸€å¸§ï¼ˆworkInProgress æ ‘ï¼‰\n\nåå°å¯ä»¥ï¼š\n  âœ… æ…¢æ…¢å‡†å¤‡ï¼ˆå¯ä¸­æ–­ï¼‰\n  âœ… åå¤ä¿®æ”¹ï¼ˆå¯é‡æ¥ï¼‰\n  âœ… ä¸å½±å“å‰å°æ˜¾ç¤º\n\nå‡†å¤‡å¥½åï¼š\n  âš¡ ä¸€æ¬¡æ€§åˆ‡æ¢æŒ‡é’ˆï¼ˆroot.current = workInProgressï¼‰\n  âš¡ ç”¨æˆ·ç«‹å³çœ‹åˆ°å®Œæ•´çš„æ–°ç•Œé¢ï¼Œæ— é—ªçƒ\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-effectlist-çš„ä½œç”¨" tabindex="-1"><a class="header-anchor" href="#_3-effectlist-çš„ä½œç”¨" aria-hidden="true">#</a> 3. effectList çš„ä½œç”¨</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ä¸ç”¨ effectListï¼š\n  - æäº¤é˜¶æ®µéœ€è¦éå†æ•´æ£µ Fiber æ ‘\n  - å¤§éƒ¨åˆ†èŠ‚ç‚¹æ²¡æœ‰å˜åŒ–ï¼Œæµªè´¹æ—¶é—´\n  - å¤æ‚åº¦ O(n)ï¼Œn = æ‰€æœ‰èŠ‚ç‚¹æ•°\n\nä½¿ç”¨ effectListï¼š\n  - åªéå†æœ‰å˜åŒ–çš„èŠ‚ç‚¹ï¼ˆå•é“¾è¡¨ï¼‰\n  - å¤æ‚åº¦ O(m)ï¼Œm = æœ‰å˜åŒ–çš„èŠ‚ç‚¹æ•°\n  - é€šå¸¸ m &lt;&lt; nï¼Œæ€§èƒ½æå‡æ˜¾è‘—\n\nç¤ºä¾‹ï¼š\n  - Fiber æ ‘ 10000 ä¸ªèŠ‚ç‚¹\n  - åªæœ‰ 3 ä¸ªèŠ‚ç‚¹å˜åŒ–\n  - ä¸ç”¨ effectListï¼šéå† 10000 æ¬¡\n  - ç”¨ effectListï¼šéå† 3 æ¬¡ âš¡\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><hr><h2 id="å®Œæ•´æ—¶åºå›¾" tabindex="-1"><a class="header-anchor" href="#å®Œæ•´æ—¶åºå›¾" aria-hidden="true">#</a> å®Œæ•´æ—¶åºå›¾</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>æ—¶é—´çº¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’\n\nç”¨æˆ·ç‚¹å‡»\n  â”‚\n  â”œâ”€ è°ƒåº¦é˜¶æ®µ (Schedule)\n  â”‚   â””â”€ 0-1ms: åˆ›å»º Updateã€è®¡ç®—ä¼˜å…ˆçº§ã€Scheduler è°ƒåº¦\n  â”‚\n  â”œâ”€ åè°ƒé˜¶æ®µ (Render) âš¡ å¯ä¸­æ–­\n  â”‚   â”œâ”€ 1-10ms: beginWork (éå†ã€Diff)\n  â”‚   â”œâ”€ å¯èƒ½è¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡æ‰“æ–­\n  â”‚   â”œâ”€ 10-15ms: completeWork (åˆ›å»º DOMã€æ”¶é›† effect)\n  â”‚   â””â”€ æ„å»º effectList\n  â”‚\n  â”œâ”€ æäº¤é˜¶æ®µ (Commit) âš ï¸ åŒæ­¥ï¼Œä¸å¯ä¸­æ–­\n  â”‚   â”œâ”€ 15-16ms: before mutation\n  â”‚   â”œâ”€ 16-18ms: mutation (çœŸå® DOM æ“ä½œ)\n  â”‚   â”œâ”€ 18ms: åˆ‡æ¢ current æŒ‡é’ˆ âš¡\n  â”‚   â””â”€ 18-20ms: layout (useLayoutEffectã€ref)\n  â”‚\n  â”œâ”€ æµè§ˆå™¨ç»˜åˆ¶\n  â”‚   â””â”€ 20-36ms: Paintã€Composite\n  â”‚       ç”¨æˆ·çœ‹åˆ°æ–°ç•Œé¢ ğŸ‘€\n  â”‚\n  â””â”€ å‰¯ä½œç”¨æ‰§è¡Œ (Effect) âš¡ å¼‚æ­¥\n      â””â”€ 36-40ms: useEffect (ä¸é˜»å¡ç»˜åˆ¶)\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><hr><h2 id="è°ƒè¯•æŠ€å·§" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•æŠ€å·§" aria-hidden="true">#</a> è°ƒè¯•æŠ€å·§</h2><h3 id="_1-åœ¨æµè§ˆå™¨ä¸­è§‚å¯Ÿæ›´æ–°" tabindex="-1"><a class="header-anchor" href="#_1-åœ¨æµè§ˆå™¨ä¸­è§‚å¯Ÿæ›´æ–°" aria-hidden="true">#</a> 1. åœ¨æµè§ˆå™¨ä¸­è§‚å¯Ÿæ›´æ–°</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// åœ¨ç»„ä»¶ä¸­æ·»åŠ æ—¥å¿—</span>\n<span class="token keyword">function</span> <span class="token function">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ğŸ¨ [Render] MyComponent&#39;</span><span class="token punctuation">)</span>\n\n  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;âš¡ [Layout] MyComponent&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ğŸŒŠ [Effect] MyComponent&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Hello<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// æ§åˆ¶å°è¾“å‡ºï¼š</span>\n<span class="token comment">// ğŸ¨ [Render] MyComponent       â† Render é˜¶æ®µ</span>\n<span class="token comment">// âš¡ [Layout] MyComponent       â† Commit.layout é˜¶æ®µ</span>\n<span class="token comment">// (ç•Œé¢å·²æ›´æ–°)</span>\n<span class="token comment">// ğŸŒŠ [Effect] MyComponent       â† å¼‚æ­¥ Effect é˜¶æ®µ</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_2-react-devtools-profiler" tabindex="-1"><a class="header-anchor" href="#_2-react-devtools-profiler" aria-hidden="true">#</a> 2. React DevTools Profiler</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Profiler <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span>\n\n<span class="token punctuation">;</span><span class="token operator">&lt;</span>Profiler id<span class="token operator">=</span><span class="token string">&quot;App&quot;</span> onRender<span class="token operator">=</span><span class="token punctuation">{</span>onRenderCallback<span class="token punctuation">}</span><span class="token operator">&gt;</span>\n  <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>Profiler<span class="token operator">&gt;</span>\n\n<span class="token keyword">function</span> <span class="token function">onRenderCallback</span><span class="token punctuation">(</span>\n  id<span class="token punctuation">,</span> <span class="token comment">// &quot;App&quot;</span>\n  phase<span class="token punctuation">,</span> <span class="token comment">// &quot;mount&quot; æˆ– &quot;update&quot;</span>\n  actualDuration<span class="token punctuation">,</span> <span class="token comment">// æœ¬æ¬¡æ¸²æŸ“è€—æ—¶</span>\n  baseDuration<span class="token punctuation">,</span> <span class="token comment">// ç†æƒ³è€—æ—¶ï¼ˆæ—  memoï¼‰</span>\n  startTime<span class="token punctuation">,</span> <span class="token comment">// å¼€å§‹æ—¶é—´</span>\n  commitTime <span class="token comment">// æäº¤æ—¶é—´</span>\n<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> took </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>actualDuration<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_3-æ–­ç‚¹è°ƒè¯•æºç " tabindex="-1"><a class="header-anchor" href="#_3-æ–­ç‚¹è°ƒè¯•æºç " aria-hidden="true">#</a> 3. æ–­ç‚¹è°ƒè¯•æºç </h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// åœ¨ React æºç ä¸­æ‰“æ–­ç‚¹çš„ä½ç½®ï¼š</span>\n<span class="token comment">// 1. packages/react-reconciler/src/ReactFiberWorkLoop.js</span>\n<span class="token comment">//    - performUnitOfWork (å·¥ä½œå¾ªç¯)</span>\n<span class="token comment">//    - beginWork (å‘ä¸‹éå†)</span>\n<span class="token comment">//    - completeWork (å‘ä¸Šå›æº¯)</span>\n\n<span class="token comment">// 2. packages/react-reconciler/src/ReactFiberCommitWork.js</span>\n<span class="token comment">//    - commitMutationEffects (DOM æ“ä½œ)</span>\n<span class="token comment">//    - commitLayoutEffects (ç”Ÿå‘½å‘¨æœŸ)</span>\n\n<span class="token comment">// 3. packages/scheduler/src/Scheduler.js</span>\n<span class="token comment">//    - scheduleCallback (ä»»åŠ¡è°ƒåº¦)</span>\n<span class="token comment">//    - workLoop (æ—¶é—´åˆ‡ç‰‡)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><hr><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><h3 id="react-æ›´æ–°çš„æ ¸å¿ƒæ€æƒ³" tabindex="-1"><a class="header-anchor" href="#react-æ›´æ–°çš„æ ¸å¿ƒæ€æƒ³" aria-hidden="true">#</a> React æ›´æ–°çš„æ ¸å¿ƒæ€æƒ³</h3><ol><li><strong>åˆ†å±‚æ¶æ„</strong>ï¼šè°ƒåº¦ã€åè°ƒã€æ¸²æŸ“åˆ†ç¦»</li><li><strong>å¼‚æ­¥å¯ä¸­æ–­</strong>ï¼šRender é˜¶æ®µå¯ä¸­æ–­ï¼ŒCommit åŸå­æ€§</li><li><strong>ä¼˜å…ˆçº§è°ƒåº¦</strong>ï¼šç´§æ€¥ä»»åŠ¡ä¼˜å…ˆï¼Œéç´§æ€¥ä»»åŠ¡å¯å»¶è¿Ÿ</li><li><strong>åŒç¼“å†²</strong>ï¼šåå°å‡†å¤‡ï¼Œå‰å°å±•ç¤ºï¼Œä¸€æ¬¡æ€§åˆ‡æ¢</li><li><strong>å¢é‡æ›´æ–°</strong>ï¼šæ—¶é—´åˆ‡ç‰‡ï¼Œé¿å…é•¿ä»»åŠ¡é˜»å¡ä¸»çº¿ç¨‹</li></ol><h3 id="å…³é”®ä¼˜åŒ–ç‚¹" tabindex="-1"><a class="header-anchor" href="#å…³é”®ä¼˜åŒ–ç‚¹" aria-hidden="true">#</a> å…³é”®ä¼˜åŒ–ç‚¹</h3><ul><li>âš¡ Fiber æ¶æ„ï¼šå¯ä¸­æ–­ + é“¾è¡¨ç»“æ„</li><li>âš¡ Diff ç®—æ³•ï¼šæœ€å°åŒ– DOM æ“ä½œ</li><li>âš¡ effectListï¼šåªå¤„ç†å˜åŒ–çš„èŠ‚ç‚¹</li><li>âš¡ æ‰¹å¤„ç†ï¼šåˆå¹¶å¤šæ¬¡ setState</li><li>âš¡ Lane æ¨¡å‹ï¼šç²¾ç»†åŒ–ä¼˜å…ˆçº§æ§åˆ¶</li></ul><h3 id="æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#æœ€ä½³å®è·µ" aria-hidden="true">#</a> æœ€ä½³å®è·µ</h3><ol><li>ä½¿ç”¨ <code>startTransition</code> åŒºåˆ†ç´§æ€¥/éç´§æ€¥æ›´æ–°</li><li>ä½¿ç”¨ <code>useDeferredValue</code> å»¶è¿Ÿæ˜‚è´µè®¡ç®—</li><li>é¿å…åœ¨ Render é˜¶æ®µæ‰§è¡Œå‰¯ä½œç”¨</li><li>ä¸º <code>useEffect</code> æä¾›æ­£ç¡®çš„ cleanup</li><li>ä½¿ç”¨ React DevTools Profiler åˆ†ææ€§èƒ½</li></ol><hr><p><strong>æ‰©å±•é˜…è¯»ï¼š</strong></p>',91),t={href:"https://github.com/acdlite/react-fiber-architecture",target:"_blank",rel:"noopener noreferrer"},o=(0,p.Uk)("React Fiber Architecture"),c={href:"https://react.dev/blog/2022/03/29/react-v18",target:"_blank",rel:"noopener noreferrer"},l=(0,p.Uk)("React 18 å¹¶å‘ç‰¹æ€§"),r={href:"https://react.dev/learn/reconciliation",target:"_blank",rel:"noopener noreferrer"},u=(0,p.Uk)("Deep Dive: Reconciliation"),i={},k=(0,a(3744).Z)(i,[["render",function(n,s){const a=(0,p.up)("ExternalLinkIcon");return(0,p.wg)(),(0,p.iD)(p.HY,null,[e,(0,p._)("ul",null,[(0,p._)("li",null,[(0,p._)("a",t,[o,(0,p.Wm)(a)])]),(0,p._)("li",null,[(0,p._)("a",c,[l,(0,p.Wm)(a)])]),(0,p._)("li",null,[(0,p._)("a",r,[u,(0,p.Wm)(a)])])])],64)}]])},3744:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,p]of s)a[n]=p;return a}}}]);