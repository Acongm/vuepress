"use strict";(self.webpackChunkmd_vuepress=self.webpackChunkmd_vuepress||[]).push([[899],{1716:(n,s,e)=>{e.r(s),e.d(s,{data:()=>a});const a={key:"v-4581920c",path:"/react/react-render.html",title:"React çš„æ¸²æŸ“æµç¨‹",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"ğŸŒŸ ä¸€å¥è¯æ¦‚æ‹¬ React æ¸²æŸ“æµç¨‹ï¼š",slug:"ğŸŒŸ-ä¸€å¥è¯æ¦‚æ‹¬-react-æ¸²æŸ“æµç¨‹",children:[]},{level:2,title:"ä¸€ã€æ•´ä½“æ¶æ„å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰",slug:"ä¸€ã€æ•´ä½“æ¶æ„å›¾-æ–‡å­—ç‰ˆ",children:[]},{level:2,title:"äºŒã€åˆ†æ­¥è¯¦è§£ï¼ˆç»“åˆæºç é€»è¾‘ï¼‰",slug:"äºŒã€åˆ†æ­¥è¯¦è§£-ç»“åˆæºç é€»è¾‘",children:[{level:3,title:"æ­¥éª¤ 1ï¸âƒ£ï¼šåˆå§‹åŒ–æ ¹å®¹å™¨ï¼ˆcreateRootï¼‰",slug:"æ­¥éª¤-1ï¸âƒ£-åˆå§‹åŒ–æ ¹å®¹å™¨-createroot",children:[]},{level:3,title:"æ­¥éª¤ 2ï¸âƒ£ï¼šè°ƒåº¦æ›´æ–°ï¼ˆScheduler ä»‹å…¥ï¼‰",slug:"æ­¥éª¤-2ï¸âƒ£-è°ƒåº¦æ›´æ–°-scheduler-ä»‹å…¥",children:[]},{level:3,title:"æ­¥éª¤ 3ï¸âƒ£ï¼šå·¥ä½œå¾ªç¯ï¼ˆworkLoopï¼‰",slug:"æ­¥éª¤-3ï¸âƒ£-å·¥ä½œå¾ªç¯-workloop",children:[]},{level:3,title:"æ­¥éª¤ 4ï¸âƒ£ï¼šperformUnitOfWork â†’ beginWorkï¼ˆå‘ä¸‹ï¼‰",slug:"æ­¥éª¤-4ï¸âƒ£-performunitofwork-â†’-beginwork-å‘ä¸‹",children:[]},{level:3,title:"æ­¥éª¤ 5ï¸âƒ£ï¼šcompleteUnitOfWork â†’ completeWorkï¼ˆå‘ä¸Šï¼‰",slug:"æ­¥éª¤-5ï¸âƒ£-completeunitofwork-â†’-completework-å‘ä¸Š",children:[]},{level:3,title:"æ­¥éª¤ 6ï¸âƒ£ï¼šæäº¤é˜¶æ®µï¼ˆCommit Phaseï¼‰",slug:"æ­¥éª¤-6ï¸âƒ£-æäº¤é˜¶æ®µ-commit-phase",children:[]},{level:3,title:"æ­¥éª¤ 7ï¸âƒ£ï¼šåŒç¼“å†²åˆ‡æ¢ï¼ˆDouble Bufferingï¼‰",slug:"æ­¥éª¤-7ï¸âƒ£-åŒç¼“å†²åˆ‡æ¢-double-buffering",children:[]}]},{level:2,title:"ä¸‰ã€å…³é”®æ•°æ®ç»“æ„å›é¡¾",slug:"ä¸‰ã€å…³é”®æ•°æ®ç»“æ„å›é¡¾",children:[{level:3,title:"Fiber èŠ‚ç‚¹æ ¸å¿ƒå­—æ®µ",slug:"fiber-èŠ‚ç‚¹æ ¸å¿ƒå­—æ®µ",children:[]},{level:3,title:"Effect é“¾è¡¨",slug:"effect-é“¾è¡¨",children:[]}]},{level:2,title:"å››ã€ç»“åˆä½ çš„é¡¹ç›®åœºæ™¯ï¼ˆmy-ticket-agentï¼‰",slug:"å››ã€ç»“åˆä½ çš„é¡¹ç›®åœºæ™¯-my-ticket-agent",children:[]},{level:2,title:"äº”ã€å…³é”®æºç æ–‡ä»¶é€ŸæŸ¥ï¼ˆReact 18ï¼‰",slug:"äº”ã€å…³é”®æºç æ–‡ä»¶é€ŸæŸ¥-react-18",children:[]},{level:2,title:"âœ… æ€»ç»“ï¼šReact æ¸²æŸ“ä¸‰é˜¶æ®µ",slug:"âœ…-æ€»ç»“-react-æ¸²æŸ“ä¸‰é˜¶æ®µ",children:[]}],git:{updatedTime:1769876936e3},filePathRelative:"react/react-render.md"}},8017:(n,s,e)=>{e.r(s),e.d(s,{default:()=>o});const a=(0,e(6252).uE)('<h1 id="react-çš„æ¸²æŸ“æµç¨‹" tabindex="-1"><a class="header-anchor" href="#react-çš„æ¸²æŸ“æµç¨‹" aria-hidden="true">#</a> React çš„æ¸²æŸ“æµç¨‹</h1><p>ç°åœ¨æˆ‘ä»¬ä» <strong>React æºç è§’åº¦</strong>ï¼ˆä»¥ <strong>React 18+</strong> ä¸ºä¸»ï¼ŒåŸºäº <code>react-reconciler</code> å’Œ <code>react-dom</code>ï¼‰ç³»ç»Ÿæ€§åœ°è®²è§£ <strong>React ä» <code>createRoot().render(&lt;App /&gt;)</code> åˆ°çœŸå® DOM æ¸²æŸ“å®Œæˆçš„å®Œæ•´æµç¨‹</strong>ã€‚</p><p>æˆ‘ä»¬å°†èšç„¦ <strong>Fiber æ¶æ„ä¸‹çš„æ ¸å¿ƒæœºåˆ¶</strong>ï¼Œæ¶µç›–ï¼šåˆå§‹åŒ–ã€è°ƒåº¦ã€æ¸²æŸ“ï¼ˆrender é˜¶æ®µï¼‰ã€æäº¤ï¼ˆcommit é˜¶æ®µï¼‰ã€å‰¯ä½œç”¨å¤„ç†ç­‰ï¼ŒåŒæ—¶è¯´æ˜å…³é”®å‡½æ•°ï¼ˆå¦‚ <code>beginWork</code>ã€<code>completeWork</code>ã€<code>commitRoot</code>ï¼‰çš„ä½œç”¨å’Œè°ƒç”¨æ—¶æœºã€‚</p><hr><h2 id="ğŸŒŸ-ä¸€å¥è¯æ¦‚æ‹¬-react-æ¸²æŸ“æµç¨‹" tabindex="-1"><a class="header-anchor" href="#ğŸŒŸ-ä¸€å¥è¯æ¦‚æ‹¬-react-æ¸²æŸ“æµç¨‹" aria-hidden="true">#</a> ğŸŒŸ ä¸€å¥è¯æ¦‚æ‹¬ React æ¸²æŸ“æµç¨‹ï¼š</h2><blockquote><p><strong>è§¦å‘æ›´æ–° â†’ åˆ›å»º Fiber æ ‘ï¼ˆworkInProgressï¼‰â†’ åè°ƒï¼ˆreconcileï¼‰ç”Ÿæˆ Effect é“¾è¡¨ â†’ æäº¤ï¼ˆcommitï¼‰æ›´æ–°çœŸå® DOM â†’ æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ/å‰¯ä½œç”¨</strong></p></blockquote><p>æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªå¤§é˜¶æ®µï¼š</p><ul><li><strong>Render Phase</strong>ï¼ˆå¯ä¸­æ–­ã€å¼‚æ­¥ï¼Œæ„å»º Fiber æ ‘ + Effect listï¼‰</li><li><strong>Commit Phase</strong>ï¼ˆä¸å¯ä¸­æ–­ã€åŒæ­¥ï¼Œæ“ä½œ DOM + æ‰§è¡Œå‰¯ä½œç”¨ï¼‰</li></ul><hr><h2 id="ä¸€ã€æ•´ä½“æ¶æ„å›¾-æ–‡å­—ç‰ˆ" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€æ•´ä½“æ¶æ„å›¾-æ–‡å­—ç‰ˆ" aria-hidden="true">#</a> ä¸€ã€æ•´ä½“æ¶æ„å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[createRoot().render(&lt;App /&gt;)]\n         â†“\nscheduleUpdateOnFiber(fiber, update)  â† è§¦å‘æ›´æ–°\n         â†“\nensureRootIsScheduled(root)           â† è°ƒåº¦å™¨ä»‹å…¥\n         â†“\nworkLoopConcurrent() æˆ– workLoopSync()\n         â”‚\n         â”œâ”€â–¶ performUnitOfWork(fiber)\n         â”‚        â†“\n         â”‚    beginWork(fiber)         â† å‘ä¸‹åè°ƒï¼Œå¤„ç†å­èŠ‚ç‚¹\n         â”‚        â†“\n         â”‚    reconcileChildren()      â† diff æ–°æ—§ childrenï¼Œåˆ›å»ºå­ Fiber\n         â”‚\n         â””â”€â–¶ completeUnitOfWork(fiber)\n                  â†“\n              completeWork(fiber)      â† å‘ä¸Šæ”¶å°¾ï¼Œæ”¶é›† DOM å‰¯ä½œç”¨\n                  â†“\n              æ„å»º effectListï¼ˆé“¾è¡¨ï¼šnextEffectï¼‰\n         â†“\næ‰€æœ‰ Fiber å¤„ç†å®Œï¼Ÿ â†’ æ˜¯\n         â†“\ncommitRoot(root)\n         â†“\ncommitMutationEffects(root)        â† æ‰§è¡Œ DOM æ’å…¥/æ›´æ–°/åˆ é™¤\n         â†“\ncommitLayoutEffects(root)          â† æ‰§è¡Œ useLayoutEffect / componentDidMount\n         â†“\nschedulePassiveEffects()           â† å¼‚æ­¥è°ƒåº¦ useEffectï¼ˆå¾®ä»»åŠ¡ï¼‰\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><hr><h2 id="äºŒã€åˆ†æ­¥è¯¦è§£-ç»“åˆæºç é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#äºŒã€åˆ†æ­¥è¯¦è§£-ç»“åˆæºç é€»è¾‘" aria-hidden="true">#</a> äºŒã€åˆ†æ­¥è¯¦è§£ï¼ˆç»“åˆæºç é€»è¾‘ï¼‰</h2><h3 id="æ­¥éª¤-1ï¸âƒ£-åˆå§‹åŒ–æ ¹å®¹å™¨-createroot" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-1ï¸âƒ£-åˆå§‹åŒ–æ ¹å®¹å™¨-createroot" aria-hidden="true">#</a> æ­¥éª¤ 1ï¸âƒ£ï¼šåˆå§‹åŒ–æ ¹å®¹å™¨ï¼ˆcreateRootï¼‰</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> root <span class="token operator">=</span> ReactDOM<span class="token punctuation">.</span><span class="token function">createRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>\nroot<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>æºç ä½ç½®</strong>ï¼š<code>packages/react-dom/src/client/ReactDOMRoot.js</code></p><ul><li>åˆ›å»º <strong>FiberRoot</strong>ï¼ˆå…¨å±€æ ¹å¯¹è±¡ï¼ŒåŒ…å« current Fiber æ ‘ï¼‰</li><li>åˆ›å»º <strong>root Fiber</strong>ï¼ˆtype = HostRootï¼Œtag = HostRootï¼‰</li><li>è°ƒç”¨ <code>updateContainer(&lt;App /&gt;, root)</code> â†’ åˆ›å»ºä¸€ä¸ª <strong>Update å¯¹è±¡</strong> å¹¶å…¥é˜Ÿ</li></ul><blockquote><p>âœ… <code>FiberRoot</code> æ˜¯ React çš„â€œè°ƒåº¦å•å…ƒâ€ï¼Œ<code>root.current</code> æŒ‡å‘å½“å‰æ˜¾ç¤ºçš„ Fiber æ ‘ã€‚</p></blockquote><hr><h3 id="æ­¥éª¤-2ï¸âƒ£-è°ƒåº¦æ›´æ–°-scheduler-ä»‹å…¥" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-2ï¸âƒ£-è°ƒåº¦æ›´æ–°-scheduler-ä»‹å…¥" aria-hidden="true">#</a> æ­¥éª¤ 2ï¸âƒ£ï¼šè°ƒåº¦æ›´æ–°ï¼ˆScheduler ä»‹å…¥ï¼‰</h3><p><strong>å‡½æ•°</strong>ï¼š<code>scheduleUpdateOnFiber(fiber, update)</code> â†’ <code>ensureRootIsScheduled(root)</code></p><ul><li>åˆ¤æ–­æ˜¯å¦å¹¶å‘æ¨¡å¼ï¼ˆ<code>createRoot</code>ï¼‰â†’ ä½¿ç”¨ <code>Scheduler</code> è°ƒåº¦</li><li>è°ƒç”¨ <code>scheduleCallback(priorityLevel, workLoop)</code><ul><li>åº•å±‚ç”¨ <code>MessageChannel</code> æ¨¡æ‹Ÿ <code>requestIdleCallback</code></li><li>æŠŠ <code>workLoopConcurrent</code> æ”¾å…¥å¾®ä»»åŠ¡/å®ä»»åŠ¡é˜Ÿåˆ—</li></ul></li></ul><blockquote><p>ğŸ’¡ æ­¤æ—¶ <strong>è¿˜æ²¡æœ‰å¼€å§‹æ¸²æŸ“</strong>ï¼Œåªæ˜¯â€œå®‰æ’äº†ä¸€ä¸ªä»»åŠ¡â€ã€‚</p></blockquote><hr><h3 id="æ­¥éª¤-3ï¸âƒ£-å·¥ä½œå¾ªç¯-workloop" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-3ï¸âƒ£-å·¥ä½œå¾ªç¯-workloop" aria-hidden="true">#</a> æ­¥éª¤ 3ï¸âƒ£ï¼šå·¥ä½œå¾ªç¯ï¼ˆworkLoopï¼‰</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><code>workInProgress</code>ï¼šå½“å‰æ­£åœ¨æ„å»ºçš„ Fiber èŠ‚ç‚¹ï¼ˆWIP æ ‘ï¼‰</li><li><code>shouldYield()</code>ï¼šæ£€æŸ¥æ˜¯å¦è¯¥è®©å‡ºä¸»çº¿ç¨‹ï¼ˆåŸºäº 5ms æ—¶é—´ç‰‡ï¼‰</li></ul><hr><h3 id="æ­¥éª¤-4ï¸âƒ£-performunitofwork-â†’-beginwork-å‘ä¸‹" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-4ï¸âƒ£-performunitofwork-â†’-beginwork-å‘ä¸‹" aria-hidden="true">#</a> æ­¥éª¤ 4ï¸âƒ£ï¼šperformUnitOfWork â†’ beginWorkï¼ˆå‘ä¸‹ï¼‰</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">unitOfWork</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate\n  <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span>\n\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// æ²¡æœ‰å­èŠ‚ç‚¹ â†’ å®Œæˆå½“å‰èŠ‚ç‚¹</span>\n    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n  <span class="token keyword">return</span> next <span class="token comment">// è¿”å› childï¼Œç»§ç»­å‘ä¸‹</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="ğŸ”-beginwork-åšäº†ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ”-beginwork-åšäº†ä»€ä¹ˆ" aria-hidden="true">#</a> ğŸ” <code>beginWork</code> åšäº†ä»€ä¹ˆï¼Ÿ</h4><p><strong>æºç ä½ç½®</strong>ï¼š<code>packages/react-reconciler/src/ReactFiberBeginWork.js</code></p><ul><li>æ ¹æ® <code>fiber.tag</code> ç±»å‹å¤„ç†ï¼š <ul><li><code>FunctionComponent</code> â†’ è°ƒç”¨ <code>renderWithHooks()</code> â†’ æ‰§è¡Œä½ çš„å‡½æ•°ç»„ä»¶</li><li><code>HostComponent</code>ï¼ˆå¦‚ <code>div</code>ï¼‰â†’ å‡†å¤‡ props</li></ul></li><li>è°ƒç”¨ <code>reconcileChildren(current, workInProgress, nextChildren)</code><ul><li><strong>æ ¸å¿ƒ diff é€»è¾‘</strong>ï¼šå¯¹æ¯”æ–°æ—§ childrenï¼Œå¤ç”¨/åˆ›å»º/åˆ é™¤ Fiber</li><li>ä½¿ç”¨ key ä¼˜åŒ–ï¼ˆç±»ä¼¼ Vueï¼‰</li><li>è¿”å› <code>workInProgress.child</code></li></ul></li></ul><blockquote><p>âœ… æ­¤é˜¶æ®µ <strong>ä¸æ“ä½œ DOM</strong>ï¼Œåªæ„å»ºæ–°çš„ Fiber æ ‘ï¼ˆWIP æ ‘ï¼‰ã€‚</p></blockquote><hr><h3 id="æ­¥éª¤-5ï¸âƒ£-completeunitofwork-â†’-completework-å‘ä¸Š" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-5ï¸âƒ£-completeunitofwork-â†’-completework-å‘ä¸Š" aria-hidden="true">#</a> æ­¥éª¤ 5ï¸âƒ£ï¼šcompleteUnitOfWork â†’ completeWorkï¼ˆå‘ä¸Šï¼‰</h3><p>å½“ä¸€ä¸ª Fiber èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼ˆæˆ–å­èŠ‚ç‚¹å·²å¤„ç†å®Œï¼‰ï¼Œå¼€å§‹å›æº¯ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">unitOfWork</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>\n  <span class="token keyword">let</span> completedWork <span class="token operator">=</span> unitOfWork<span class="token punctuation">;</span>\n  <span class="token keyword">do</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> current <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>\n    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>return<span class="token punctuation">;</span>\n    <span class="token function">completeWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> completedWork<span class="token punctuation">,</span> subtreeRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// æ„å»º effect listï¼ˆç”¨äº commit é˜¶æ®µï¼‰</span>\n    <span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token comment">/* sibling or parent */</span><span class="token punctuation">;</span>\n    completedWork <span class="token operator">=</span> next<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>completedWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="ğŸ”-completework-åšäº†ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ”-completework-åšäº†ä»€ä¹ˆ" aria-hidden="true">#</a> ğŸ” <code>completeWork</code> åšäº†ä»€ä¹ˆï¼Ÿ</h4><p><strong>æºç ä½ç½®</strong>ï¼š<code>packages/react-reconciler/src/ReactFiberCompleteWork.js</code></p><ul><li>å¯¹ <code>HostComponent</code>ï¼ˆå¦‚ <code>div</code>ï¼‰ï¼š <ul><li>è°ƒç”¨ <code>createInstance(type, props)</code> â†’ <strong>åˆ›å»º DOM èŠ‚ç‚¹æè¿°</strong>ï¼ˆéçœŸå®åˆ›å»ºï¼‰</li><li>è°ƒç”¨ <code>appendAllChildren(instance, completedWork)</code> â†’ æŠŠå­ DOM æŒ‚åˆ°è‡ªå·±</li><li>è®¾ç½® <code>fiber.stateNode = instance</code></li></ul></li><li>æ ‡è®°å‰¯ä½œç”¨ï¼š <ul><li><code>Placement</code>ï¼ˆéœ€è¦æ’å…¥ï¼‰</li><li><code>Update</code>ï¼ˆéœ€è¦æ›´æ–°å±æ€§ï¼‰</li><li><code>Deletion</code>ï¼ˆéœ€è¦åˆ é™¤ï¼‰</li></ul></li><li>æ„å»º <code>effectList</code> é“¾è¡¨ï¼ˆé€šè¿‡ <code>nextEffect</code> æŒ‡é’ˆï¼‰</li></ul><blockquote><p>âœ… æ­¤é˜¶æ®µ <strong>æ”¶é›†æ‰€æœ‰ DOM æ“ä½œ</strong>ï¼Œä½† <strong>ä»æœªæ“ä½œçœŸå® DOM</strong>ã€‚</p></blockquote><hr><h3 id="æ­¥éª¤-6ï¸âƒ£-æäº¤é˜¶æ®µ-commit-phase" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-6ï¸âƒ£-æäº¤é˜¶æ®µ-commit-phase" aria-hidden="true">#</a> æ­¥éª¤ 6ï¸âƒ£ï¼šæäº¤é˜¶æ®µï¼ˆCommit Phaseï¼‰</h3><p>å½“æ•´æ£µ WIP æ ‘æ„å»ºå®Œæˆï¼Œè¿›å…¥ <strong>ä¸å¯ä¸­æ–­çš„åŒæ­¥é˜¶æ®µ</strong>ï¼š</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// 1. before mutationï¼ˆå¿«ç…§ï¼‰</span>\n  <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>\n\n  <span class="token comment">// 2. mutationï¼ˆæ“ä½œ DOMï¼‰</span>\n  <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> rootFiber<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span>\n\n  <span class="token comment">// 3. layoutï¼ˆåŒæ­¥å‰¯ä½œç”¨ï¼‰</span>\n  <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span>\n\n  <span class="token comment">// 4. è°ƒåº¦ passive effectsï¼ˆuseEffectï¼‰</span>\n  <span class="token function">schedulePassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="ğŸ§¨-6-1-commitmutationeffects-çœŸå®-dom-æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#ğŸ§¨-6-1-commitmutationeffects-çœŸå®-dom-æ“ä½œ" aria-hidden="true">#</a> ğŸ§¨ 6.1 commitMutationEffectsï¼ˆçœŸå® DOM æ“ä½œï¼‰</h4><ul><li>éå† <code>effectList</code></li><li>æ ¹æ® <code>effectTag</code> æ‰§è¡Œï¼š <ul><li><code>Placement</code> â†’ <code>parent.appendChild(child.stateNode)</code></li><li><code>Update</code> â†’ <code>updateDOMProperties(oldProps, newProps)</code></li><li><code>Deletion</code> â†’ <code>parent.removeChild(child.stateNode)</code></li></ul></li></ul><h4 id="ğŸ§ª-6-2-commitlayouteffects" tabindex="-1"><a class="header-anchor" href="#ğŸ§ª-6-2-commitlayouteffects" aria-hidden="true">#</a> ğŸ§ª 6.2 commitLayoutEffects</h4><ul><li>æ‰§è¡Œ <code>useLayoutEffect</code> å›è°ƒ</li><li>æ‰§è¡Œ Class ç»„ä»¶çš„ <code>componentDidMount</code> / <code>componentDidUpdate</code></li><li><strong>æ­¤æ—¶ DOM å·²æ›´æ–°ï¼Œå¯è¯»å–å¸ƒå±€</strong></li></ul><h4 id="â³-6-3-schedulepassiveeffects" tabindex="-1"><a class="header-anchor" href="#â³-6-3-schedulepassiveeffects" aria-hidden="true">#</a> â³ 6.3 schedulePassiveEffects</h4><ul><li>ç”¨ <code>Scheduler.scheduleCallback(NormalPriority, flushPassiveEffects)</code></li><li>åœ¨ <strong>ä¸‹ä¸€ä¸ªå®ä»»åŠ¡</strong>ï¼ˆæˆ–å¾®ä»»åŠ¡ï¼‰ä¸­æ‰§è¡Œ <code>useEffect</code></li><li><strong>é¿å…é˜»å¡ paint</strong></li></ul><hr><h3 id="æ­¥éª¤-7ï¸âƒ£-åŒç¼“å†²åˆ‡æ¢-double-buffering" tabindex="-1"><a class="header-anchor" href="#æ­¥éª¤-7ï¸âƒ£-åŒç¼“å†²åˆ‡æ¢-double-buffering" aria-hidden="true">#</a> æ­¥éª¤ 7ï¸âƒ£ï¼šåŒç¼“å†²åˆ‡æ¢ï¼ˆDouble Bufferingï¼‰</h3><ul><li>æäº¤å®Œæˆåï¼š<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork <span class="token comment">// WIP æ ‘å˜æˆ current æ ‘</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li>ä¸‹æ¬¡æ›´æ–°æ—¶ï¼Œæ–°çš„ WIP æ ‘ä¼šå¤ç”¨ <code>current.alternate</code></li></ul><blockquote><p>âœ… é¿å…å†…å­˜æŠ–åŠ¨ï¼Œé«˜æ•ˆå¤ç”¨ Fiber èŠ‚ç‚¹ã€‚</p></blockquote><hr><h2 id="ä¸‰ã€å…³é”®æ•°æ®ç»“æ„å›é¡¾" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€å…³é”®æ•°æ®ç»“æ„å›é¡¾" aria-hidden="true">#</a> ä¸‰ã€å…³é”®æ•°æ®ç»“æ„å›é¡¾</h2><h3 id="fiber-èŠ‚ç‚¹æ ¸å¿ƒå­—æ®µ" tabindex="-1"><a class="header-anchor" href="#fiber-èŠ‚ç‚¹æ ¸å¿ƒå­—æ®µ" aria-hidden="true">#</a> Fiber èŠ‚ç‚¹æ ¸å¿ƒå­—æ®µ</h3><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Fiber</span> <span class="token punctuation">{</span>\n  tag<span class="token operator">:</span> WorkTag <span class="token comment">// FunctionComponent, HostComponent...</span>\n  type<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token comment">// ç»„ä»¶ç±»å‹æˆ– &#39;div&#39;</span>\n  stateNode<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token comment">// çœŸå® DOM æˆ–ç»„ä»¶å®ä¾‹</span>\n  <span class="token keyword">return</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// çˆ¶</span>\n  child<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// ç¬¬ä¸€ä¸ªå­</span>\n  sibling<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// ä¸‹ä¸€ä¸ªå…„å¼Ÿ</span>\n  alternate<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// åŒç¼“å†²æŒ‡é’ˆ</span>\n  effectTag<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">// Placement | Update | Deletion</span>\n  nextEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// Effect é“¾è¡¨</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="effect-é“¾è¡¨" tabindex="-1"><a class="header-anchor" href="#effect-é“¾è¡¨" aria-hidden="true">#</a> Effect é“¾è¡¨</h3><ul><li>æ‰€æœ‰æœ‰å‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹é€šè¿‡ <code>nextEffect</code> ä¸²æˆå•é“¾è¡¨</li><li>commit é˜¶æ®µåªéœ€éå†è¯¥é“¾è¡¨ï¼Œæ— éœ€éå†æ•´æ£µæ ‘</li></ul><hr><h2 id="å››ã€ç»“åˆä½ çš„é¡¹ç›®åœºæ™¯-my-ticket-agent" tabindex="-1"><a class="header-anchor" href="#å››ã€ç»“åˆä½ çš„é¡¹ç›®åœºæ™¯-my-ticket-agent" aria-hidden="true">#</a> å››ã€ç»“åˆä½ çš„é¡¹ç›®åœºæ™¯ï¼ˆmy-ticket-agentï¼‰</h2><p>ä½ åœ¨æ¸²æŸ“åŠ¨æ€è¡¨å•ï¼š</p><div class="language-tsx ext-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token punctuation">{</span>\n  fields<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">TicketField</span></span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>f<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span> <span class="token attr-name">config</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>f<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol><li>å½“ <code>fields</code> æ›´æ–° â†’ è§¦å‘ <code>setState</code></li><li>React è¿›å…¥ <code>beginWork</code> â†’ æ‰§è¡Œä½ çš„ç»„ä»¶å‡½æ•° â†’ å¾—åˆ°æ–° children</li><li><code>reconcileChildren</code> å¯¹æ¯”æ–°æ—§ <code>fields</code>ï¼š <ul><li>å¤ç”¨å·²æœ‰ <code>&lt;TicketField&gt;</code> Fiberï¼ˆé  keyï¼‰</li><li>æ ‡è®°æ–°å¢/åˆ é™¤</li></ul></li><li><code>completeWork</code> ä¸ºæ¯ä¸ªå­—æ®µæ”¶é›† DOM æ“ä½œ</li><li><code>commitMutationEffects</code> æ‰¹é‡æ›´æ–° DOM</li><li><code>useEffect</code> æœ€åæ‰§è¡Œï¼ˆå¯ç”¨äºæ—¥å¿—/åŸ‹ç‚¹ï¼‰</li></ol><blockquote><p>ğŸ’¡ å› ä¸º React <strong>ä¸çŸ¥é“å…·ä½“å“ªå˜äº†</strong>ï¼Œæ‰€ä»¥é»˜è®¤ä¼šé‡æ–°æ‰§è¡Œæ•´ä¸ªç»„ä»¶å‡½æ•°ï¼ˆé™¤é <code>memo</code> ä¼˜åŒ–ï¼‰ã€‚</p></blockquote><hr><h2 id="äº”ã€å…³é”®æºç æ–‡ä»¶é€ŸæŸ¥-react-18" tabindex="-1"><a class="header-anchor" href="#äº”ã€å…³é”®æºç æ–‡ä»¶é€ŸæŸ¥-react-18" aria-hidden="true">#</a> äº”ã€å…³é”®æºç æ–‡ä»¶é€ŸæŸ¥ï¼ˆReact 18ï¼‰</h2><table><thead><tr><th>åŠŸèƒ½</th><th>æºç è·¯å¾„</th></tr></thead><tbody><tr><td>Fiber å·¥ä½œå¾ªç¯</td><td><code>react-reconciler/src/ReactFiberWorkLoop.js</code></td></tr><tr><td>beginWork</td><td><code>ReactFiberBeginWork.js</code></td></tr><tr><td>completeWork</td><td><code>ReactFiberCompleteWork.js</code></td></tr><tr><td>commit é˜¶æ®µ</td><td><code>ReactFiberCommitWork.js</code></td></tr><tr><td>è°ƒåº¦å™¨</td><td><code>scheduler/src/Scheduler.js</code></td></tr><tr><td>React DOM å…¥å£</td><td><code>react-dom/src/client/ReactDOMRoot.js</code></td></tr></tbody></table><hr><h2 id="âœ…-æ€»ç»“-react-æ¸²æŸ“ä¸‰é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#âœ…-æ€»ç»“-react-æ¸²æŸ“ä¸‰é˜¶æ®µ" aria-hidden="true">#</a> âœ… æ€»ç»“ï¼šReact æ¸²æŸ“ä¸‰é˜¶æ®µ</h2><table><thead><tr><th>é˜¶æ®µ</th><th>æ˜¯å¦å¯ä¸­æ–­</th><th>ä¸»è¦å·¥ä½œ</th><th>å…³é”®å‡½æ•°</th></tr></thead><tbody><tr><td><strong>Render</strong></td><td>âœ…</td><td>æ„å»º Fiber æ ‘ã€diffã€æ”¶é›† effect</td><td><code>beginWork</code>, <code>completeWork</code></td></tr><tr><td><strong>Pre-commit</strong></td><td>âŒ</td><td>å¿«ç…§ï¼ˆgetSnapshotBeforeUpdateï¼‰</td><td><code>commitBeforeMutationEffects</code></td></tr><tr><td><strong>Commit</strong></td><td>âŒ</td><td>æ“ä½œ DOMã€æ‰§è¡Œå‰¯ä½œç”¨</td><td><code>commitMutationEffects</code>, <code>commitLayoutEffects</code></td></tr></tbody></table><hr><p>å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥ï¼š</p><ul><li>æä¾›ä¸€ä¸ª <strong>æç®€ React Fiber æ¨¡æ‹Ÿå™¨</strong>ï¼ˆ&lt; 100 è¡Œ JSï¼Œæ¼”ç¤º beginWork/completeWorkï¼‰</li><li>å¯¹æ¯” <strong>React å’Œ Vue åœ¨åŠ¨æ€è¡¨å•æ›´æ–°æ—¶çš„æ€§èƒ½å·®å¼‚</strong></li><li>æˆ–æ·±å…¥è®²è§£ <strong>å¹¶å‘æ¨¡å¼ä¸‹çš„ Suspense / Transition å¦‚ä½•å½±å“æ­¤æµç¨‹</strong></li></ul>',77),t={},o=(0,e(3744).Z)(t,[["render",function(n,s){return a}]])},3744:(n,s)=>{s.Z=(n,s)=>{const e=n.__vccOpts||n;for(const[n,a]of s)e[n]=a;return e}}}]);