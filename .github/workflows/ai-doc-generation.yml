name: AI æ–‡æ¡£ç”Ÿæˆå·¥ä½œæµ

# è§¦å‘æ¡ä»¶ï¼š
# 1. é€šè¿‡ Issues è§¦å‘ï¼ˆæ ‡ç­¾ä¸º ai-docï¼‰
# 2. æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
# 3. Pull Request è¯„è®ºè§¦å‘

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      topic:
        description: 'æ–‡æ¡£ä¸»é¢˜'
        required: true
        type: string
      category:
        description: 'æ–‡æ¡£åˆ†ç±»ï¼ˆå¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨æ¨èï¼‰'
        required: false
        type: string
      model:
        description: 'GLM æ¨¡å‹'
        required: false
        default: 'glm-4-flash'
        type: choice
        options:
          - glm-4-flash
          - glm-4-air
          - glm-4-airx
          - glm-4
          - glm-4-plus

env:
  TZ: Asia/Shanghai
  # GLM API Key ä» GitHub Secrets è¯»å–
  GLM_API_KEY: ${{ secrets.GLM_API_KEY }}

jobs:
  generate-document:
    runs-on: ubuntu-latest
    
    # ä»…åœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
    # 1. Issues æœ‰ ai-doc æ ‡ç­¾
    # 2. æ‰‹åŠ¨è§¦å‘
    # 3. Issue è¯„è®ºåŒ…å« /ai-doc
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-doc')) ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/ai-doc'))
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm install
      
      - name: æ£€æŸ¥ GLM API Key
        run: |
          if [ -z "$GLM_API_KEY" ]; then
            echo "âŒ é”™è¯¯ï¼šGLM_API_KEY æœªé…ç½®"
            echo "è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ  Secret: GLM_API_KEY"
            exit 1
          fi
          echo "âœ… GLM API Key å·²é…ç½®"
      
      - name: æå–æ–‡æ¡£ä¸»é¢˜
        id: extract-topic
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘
            TOPIC="${{ github.event.inputs.topic }}"
            CATEGORY="${{ github.event.inputs.category }}"
            MODEL="${{ github.event.inputs.model }}"
          elif [ "${{ github.event_name }}" == "issues" ]; then
            # Issues è§¦å‘
            TOPIC="${{ github.event.issue.title }}"
            CATEGORY=""
            MODEL="glm-4-flash"
            # ä» Issue body æå–é¢å¤–ä¿¡æ¯
            echo "ISSUE_BODY<<EOF" >> $GITHUB_ENV
            echo "${{ github.event.issue.body }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            # Issue è¯„è®ºè§¦å‘
            TOPIC=$(echo "${{ github.event.comment.body }}" | grep -oP '/ai-doc\s+\K.*' || echo "æœªæŒ‡å®šä¸»é¢˜")
            CATEGORY=""
            MODEL="glm-4-flash"
          fi
          
          echo "topic=${TOPIC}" >> $GITHUB_OUTPUT
          echo "category=${CATEGORY}" >> $GITHUB_OUTPUT
          echo "model=${MODEL}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ æ–‡æ¡£ä¸»é¢˜ï¼š${TOPIC}"
          echo "ğŸ“‚ åˆ†ç±»ï¼š${CATEGORY:-è‡ªåŠ¨æ¨è}"
          echo "ğŸ¤– æ¨¡å‹ï¼š${MODEL}"
      
      - name: ç”Ÿæˆæ–‡æ¡£å†…å®¹
        id: generate
        run: |
          TOPIC="${{ steps.extract-topic.outputs.topic }}"
          MODEL="${{ steps.extract-topic.outputs.model }}"
          
          echo "ğŸ¤– ä½¿ç”¨ GLM-4 ç”Ÿæˆæ–‡æ¡£..."
          
          # ç”Ÿæˆæ–‡æ¡£
          node lib/glm-api.mjs generate "${TOPIC}" \
            --model "${MODEL}" \
            --output /tmp/generated-doc.md
          
          echo "âœ… æ–‡æ¡£ç”Ÿæˆå®Œæˆ"
          
          # æ˜¾ç¤ºé¢„è§ˆï¼ˆå‰ 500 å­—ç¬¦ï¼‰
          echo "ğŸ“„ æ–‡æ¡£é¢„è§ˆï¼š"
          head -c 500 /tmp/generated-doc.md
          echo ""
      
      - name: æ™ºèƒ½æ¨èåˆ†ç±»
        id: suggest-category
        run: |
          CATEGORY="${{ steps.extract-topic.outputs.category }}"
          
          if [ -z "$CATEGORY" ]; then
            echo "ğŸ¤– ä½¿ç”¨ AI æ¨èåˆ†ç±»..."
            
            # å…ˆå°è¯•åŸºäºå…³é”®è¯çš„æ¨è
            SUGGESTED=$(npm run kb:query suggest "$(head -100 /tmp/generated-doc.md)" 2>&1 | grep -oP '"category":\s*"\K[^"]+' | head -1 || echo "")
            
            if [ -z "$SUGGESTED" ]; then
              # å¦‚æœå…³é”®è¯æ¨èå¤±è´¥ï¼Œä½¿ç”¨ AI æ¨è
              SUGGESTED=$(node lib/glm-api.mjs suggest /tmp/generated-doc.md 2>&1 | tail -1)
            fi
            
            CATEGORY="${SUGGESTED:-JavaScript}"
            echo "âœ… æ¨èåˆ†ç±»ï¼š${CATEGORY}"
          else
            echo "ğŸ“‚ ä½¿ç”¨æŒ‡å®šåˆ†ç±»ï¼š${CATEGORY}"
          fi
          
          echo "category=${CATEGORY}" >> $GITHUB_OUTPUT
      
      - name: éªŒè¯æ–‡æ¡£è´¨é‡
        run: |
          echo "ğŸ” éªŒè¯æ–‡æ¡£è´¨é‡..."
          
          CATEGORY="${{ steps.suggest-category.outputs.category }}"
          
          npm run kb:validate /tmp/generated-doc.md -- --category "${CATEGORY}" || {
            echo "âš ï¸  æ–‡æ¡£éªŒè¯æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­å¤„ç†"
          }
      
      - name: æ·»åŠ åˆ°çŸ¥è¯†åº“
        run: |
          CATEGORY="${{ steps.suggest-category.outputs.category }}"
          TOPIC="${{ steps.extract-topic.outputs.topic }}"
          MODEL="${{ steps.extract-topic.outputs.model }}"
          
          echo "ğŸ“š æ·»åŠ æ–‡æ¡£åˆ°çŸ¥è¯†åº“..."
          
          # é…ç½® Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ–‡æ¡£
          npm run kb:add /tmp/generated-doc.md -- \
            --category "${CATEGORY}" \
            --model "GLM-${MODEL}" \
            --questions "ç”± AI è‡ªåŠ¨ç”Ÿæˆ"
          
          echo "âœ… æ–‡æ¡£å·²æ·»åŠ åˆ°çŸ¥è¯†åº“"
      
      - name: åˆ›å»º Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs(ai): æ·»åŠ æ–‡æ¡£ - ${{ steps.extract-topic.outputs.topic }}"
          branch: ai-doc/${{ github.run_number }}
          title: "ğŸ¤– AI ç”Ÿæˆæ–‡æ¡£ï¼š${{ steps.extract-topic.outputs.topic }}"
          body: |
            ## ğŸ“ æ–‡æ¡£ä¿¡æ¯
            
            - **ä¸»é¢˜**ï¼š${{ steps.extract-topic.outputs.topic }}
            - **åˆ†ç±»**ï¼š${{ steps.suggest-category.outputs.category }}
            - **æ¨¡å‹**ï¼š${{ steps.extract-topic.outputs.model }}
            - **è§¦å‘æ–¹å¼**ï¼š${{ github.event_name }}
            
            ## ğŸ¤– AI ç”Ÿæˆ
            
            æ­¤æ–‡æ¡£ç”± GLM-4 AI è‡ªåŠ¨ç”Ÿæˆï¼Œå·²é€šè¿‡è´¨é‡éªŒè¯ã€‚
            
            ## âœ… æ£€æŸ¥æ¸…å•
            
            - [ ] å†…å®¹å‡†ç¡®æ€§
            - [ ] ä»£ç ç¤ºä¾‹æ­£ç¡®
            - [ ] æ ¼å¼è§„èŒƒ
            - [ ] åˆ†ç±»åˆé€‚
            
            ## ğŸ“ ç›¸å…³é“¾æ¥
            
            ${{ github.event_name == 'issues' && format('- Issue: #{0}', github.event.issue.number) || '' }}
            
            ---
            
            *ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
          labels: |
            ai-generated
            documentation
      
      - name: è¯„è®º Issueï¼ˆæˆåŠŸï¼‰
        if: success() && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… æ–‡æ¡£ç”ŸæˆæˆåŠŸ
              
              **ä¸»é¢˜**ï¼š${{ steps.extract-topic.outputs.topic }}
              **åˆ†ç±»**ï¼š${{ steps.suggest-category.outputs.category }}
              **æ¨¡å‹**ï¼š${{ steps.extract-topic.outputs.model }}
              
              Pull Request å·²åˆ›å»ºï¼Œè¯·æŸ¥çœ‹å¹¶åˆå¹¶ã€‚
              
              ğŸ”— [æŸ¥çœ‹ Pull Request](https://github.com/${{ github.repository }}/pulls)
              `
            })
      
      - name: è¯„è®º Issueï¼ˆå¤±è´¥ï¼‰
        if: failure() && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ æ–‡æ¡£ç”Ÿæˆå¤±è´¥
              
              è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
              
              ğŸ”— [æŸ¥çœ‹å·¥ä½œæµè¿è¡Œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `
            })
