# ç”¨æˆ·ä¸­å¿ƒå‰ç«¯æ€§èƒ½ä¼˜åŒ–å®æˆ˜æ–‡æ¡£

> **é¡¹ç›®èƒŒæ™¯**ï¼šç”¨æˆ·ä¸­å¿ƒæ˜¯ä¸€ä¸ªåŸºäº **Vue 2 + Vuex + Webpack 3** çš„å•é¡µåº”ç”¨ï¼ˆSPAï¼‰ï¼Œè¿‘æœŸæ”¶åˆ°åé¦ˆï¼š**ç§»åŠ¨ç«¯ç™»å½•é¡µå¶å‘åŠ è½½ç¼“æ…¢**ã€‚  
> **çº¦æŸæ¡ä»¶**ï¼šä¸´è¿‘æ˜¥èŠ‚ï¼Œå¹´åæœ‰é‡æ„è®¡åˆ’ï¼Œ**ä»…å…è®¸å°æ”¹åŠ¨ã€ä½é£é™©ã€é«˜æ”¶ç›Š**çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚  
> **ç›®æ ‡**ï¼š**æ˜¾è‘—é™ä½é¦–å±ç™½å±æ—¶é—´ï¼ˆFCP/LCPï¼‰**ï¼Œæå‡ç”¨æˆ·æ„ŸçŸ¥æ€§èƒ½ï¼ŒLighthouse è¯„åˆ†ä» 30+ æå‡è‡³ 70+ã€‚

---

## ä¸€ã€ä¼˜åŒ–åŸåˆ™ä¸ç­–ç•¥

### âœ… å¯å®æ–½åŸåˆ™

- **ä¸å¼•å…¥ SSR**ï¼šæ—  SEO éœ€æ±‚ï¼ŒåŒæ„æ”¹é€ æˆæœ¬é«˜ï¼›
- **ä¸å¤§å¹…åˆ å‡ä¸šåŠ¡ä»£ç **ï¼šé¿å…å¼•å…¥å›å½’ Bugï¼›
- **ä¼˜å…ˆç½‘ç»œä¸æ¸²æŸ“å±‚ä¼˜åŒ–**ï¼šè§æ•ˆå¿«ã€é£é™©ä½ï¼›
- **ä¿ç•™ç°æœ‰æ¶æ„**ï¼šä»…è°ƒæ•´æ„å»ºé…ç½®ä¸èµ„æºåŠ è½½ç­–ç•¥ã€‚

### ğŸ¯ ä¼˜åŒ–æ–¹å‘

| å±‚çº§           | ç›®æ ‡             | å…³é”®æ‰‹æ®µ                                       |
| -------------- | ---------------- | ---------------------------------------------- |
| **ç½‘ç»œä¼ è¾“**   | ç¼©çŸ­èµ„æºä¸‹è½½æ—¶é—´ | TLS 1.3ã€DNS é¢„è§£æã€Preconnectã€Preload       |
| **èµ„æºä½“ç§¯**   | å‡å°‘æ— æ•ˆä»£ç      | PurgeCSSã€Core-JS æŒ‰éœ€å¼•å…¥ã€å­—ä½“å‹ç¼©           |
| **æµè§ˆå™¨æ¸²æŸ“** | åŠ å¿«é¦–æ¬¡å†…å®¹ç»˜åˆ¶ | å†…è”å…³é”®èµ„æºã€Font Displayã€å–æ¶ˆéå¿…è¦æŒ‰éœ€åŠ è½½ |
| **ç”¨æˆ·æ„ŸçŸ¥**   | æ©ç›–åŠ è½½å»¶è¿Ÿ     | Loading åŠ¨ç”»ã€éª¨æ¶å±ï¼ˆSkeletonï¼‰               |

---

## äºŒã€è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ç½‘ç»œä¼ è¾“ä¼˜åŒ–

#### 1.1 å¯ç”¨ TLS 1.3

- **é—®é¢˜**ï¼šInitial Connection ä¸ SSL æ¡æ‰‹è€—æ—¶æ³¢åŠ¨å¤§ï¼ˆå°¤å…¶å¼±ç½‘ï¼‰ï¼›
- **æ–¹æ¡ˆ**ï¼šåœ¨é˜¿é‡Œäº‘ CDN/æœåŠ¡å™¨ä¸Š**å¼€å¯ TLS 1.3**ï¼›
- **æ•ˆæœ**ï¼šå‡å°‘ 1-2 æ¬¡ RTTï¼ŒSSL æ¡æ‰‹ä» 2-RTT é™è‡³ 1-RTT æˆ– 0-RTTï¼›
- **éªŒè¯**ï¼šChrome DevTools > Security é¢æ¿ç¡®è®¤åè®®ç‰ˆæœ¬ã€‚

#### 1.2 é¦–å± HTML æ§åˆ¶åœ¨ 14KB ä»¥å†…

- **Why 14KB**ï¼šTCP åˆå§‹æ‹¥å¡çª—å£ï¼ˆIW10ï¼‰çº¦ 14KBï¼Œå¯**1 ä¸ª RTT ä¼ å®Œ**ï¼›
- **æªæ–½**ï¼š
  - ä½¿ç”¨ `html-webpack-plugin` å¼€å¯ `minify`ï¼›
  - **ç§»é™¤å†…è” `<style>`**ï¼Œç»Ÿä¸€ç”± `mini-css-extract-plugin` æå–ï¼›
  - **ç§»é™¤å†…è” `<script>`**ï¼Œè„šæœ¬åˆå¹¶è‡³å…¥å£æ–‡ä»¶ã€‚

#### 1.3 é¢„è¿æ¥ä¸ DNS é¢„è§£æ

åœ¨ `<head>` ä¸­æ·»åŠ ï¼š

```html
<!-- é¢„è§£æ DNS -->
<link rel="dns-prefetch" href="//ga.example.com" />
<link rel="dns-prefetch" href="//apm.dji.com" />
<link rel="dns-prefetch" href="//cdn.alibaba.com" />

<!-- é¢„å»ºç«‹è¿æ¥ï¼ˆå« TLSï¼‰ -->
<link rel="preconnect" href="https://apm.dji.com" crossorigin />
```

#### 1.4 å…³é”®èµ„æº Preload

- **é—®é¢˜**ï¼šä¸» JS/CSS è¢«æµè§ˆå™¨ä½ä¼˜å…ˆçº§åŠ è½½ï¼›
- **æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `preload-webpack-plugin`ï¼ˆWebpack 3 å…¼å®¹ç‰ˆï¼‰ï¼š
  ```js
  // webpack.config.js
  const PreloadWebpackPlugin = require('preload-webpack-plugin')
  plugins: [
    new PreloadWebpackPlugin({
      rel: 'preload',
      include: ['main', 'vendor'], // æŒ‡å®š chunk
      fileBlacklist: [/\.map$/]
    })
  ]
  ```
- **æ•ˆæœ**ï¼šå…³é”®èµ„æºä¼˜å…ˆçº§æå‡è‡³ `High`ï¼Œæå‰ä¸‹è½½ã€‚

---

### 2. èµ„æºä½“ç§¯ä¼˜åŒ–

#### 2.1 æŒ‰éœ€å¼•å…¥ Polyfillï¼ˆCore-JSï¼‰

- **é—®é¢˜**ï¼š`babel-polyfill` å…¨é‡å¼•å…¥ï¼Œvendor ä½“ç§¯è‡ƒè‚¿ï¼›
- **æ–¹æ¡ˆ**ï¼š
  1. å‡çº§ Babel 7ï¼›
  2. ç§»é™¤ `babel-polyfill`ï¼›
  3. é…ç½® `.babelrc`ï¼š
     ```json
     {
       "presets": [
         [
           "@babel/preset-env",
           {
             "useBuiltIns": "usage",
             "corejs": "3.1",
             "modules": false
           }
         ]
       ]
     }
     ```
- **âš ï¸ é‡è¦**ï¼š**ç¦ç”¨ `@babel/plugin-transform-runtime`**ï¼Œå¦åˆ™ `useBuiltIns: "usage"` å¤±æ•ˆï¼ˆ[å®˜æ–¹ issue](https://github.com/babel/babel/issues/10271#issuecomment-528379505)ï¼‰ã€‚

#### 2.2 åˆ é™¤æœªä½¿ç”¨ CSSï¼ˆPurgeCSSï¼‰

- **é—®é¢˜**ï¼šAnt Design ç­‰ UI åº“å¼•å…¥å¤§é‡æœªç”¨æ ·å¼ï¼›
- **æ–¹æ¡ˆ**ï¼šé€šè¿‡ PostCSS é›†æˆ PurgeCSSï¼›
- **âš ï¸ CSS Modules å…¼å®¹**ï¼š  
  è‹¥ä½¿ç”¨ CSS Modulesï¼Œ**å¿…é¡»ä¿ç•™åŸå§‹ class ååŒ¹é…é€»è¾‘**ï¼Œå‚è€ƒ [å®˜æ–¹æ–¹æ¡ˆ](https://purgecss.com/css_modules.html)ï¼š
  ```js
  // webpack.config.js ä¸­ css-loader é…ç½®
  {
    loader: 'css-loader',
    options: {
      modules: true,
      getLocalIdent: require('react-dev-utils/getCSSModuleLocalIdent')
    }
  }
  // PurgeCSS content é…ç½®éœ€åŒ…å«æ‰€æœ‰ JS/JSX
  content: [paths.appHtml, ...glob.sync(path.join(paths.appSrc, '/**/*.{js,jsx}'))]
  ```

#### 2.3 å­—ä½“ä¼˜åŒ–

- **æ ¼å¼å‡çº§**ï¼šä¼˜å…ˆä½¿ç”¨ **WOFF2**ï¼ˆæ¯” WOFF å° 20-30%ï¼‰ï¼›
- **å‹ç¼©**ï¼šä½¿ç”¨ `fontmin-webpack` æ’ä»¶ï¼Œä»…ä¿ç•™ä¸­æ–‡/è‹±æ–‡å­—ç¬¦å­é›†ï¼›
- **ç¼“å­˜**ï¼šé€šè¿‡ Service Worker ç¼“å­˜å­—ä½“æ–‡ä»¶ï¼ˆCache APIï¼‰ï¼Œé¿å…é‡å¤ä¸‹è½½ã€‚

---

### 3. æµè§ˆå™¨æ¸²æŸ“ä¼˜åŒ–

#### 3.1 å–æ¶ˆç™»å½•é¡µæŒ‰éœ€åŠ è½½

- **é—®é¢˜**ï¼šç™»å½•é¡µä½œä¸ºç€é™†é¡µï¼Œä¸åº”å—è·¯ç”±æ‡’åŠ è½½é™åˆ¶ï¼›
- **æ–¹æ¡ˆ**ï¼šå°†ç™»å½•é¡µç»„ä»¶**ç›´æ¥æ‰“åŒ…è¿›ä¸» bundleï¼ˆapp.jsï¼‰**ï¼›
- **ç»“æœ**ï¼šä¸»åŒ…ä» 156KB â†’ **172KBï¼ˆ+16KBï¼‰**ï¼Œä½†**æ¶ˆé™¤ä¸€æ¬¡ç½‘ç»œè¯·æ±‚**ï¼ŒFCP æå‡æ˜¾è‘—ã€‚

#### 3.2 éå…³é”®è„šæœ¬å¼‚æ­¥åŠ è½½

- **ç¬¬ä¸‰æ–¹è„šæœ¬**ï¼ˆGAã€APMï¼‰ä½¿ç”¨ `async`ï¼š
  ```html
  <script async src="https://ga.example.com/analytics.js"></script>
  ```
- **è‡ªå®šä¹‰éå…³é”® JS** ä½¿ç”¨ `defer`ï¼ˆä¿è¯æ‰§è¡Œé¡ºåºï¼‰ã€‚

#### 3.3 å­—ä½“æ¸²æŸ“ä¼˜åŒ–

- **é—®é¢˜**ï¼šè‡ªå®šä¹‰å­—ä½“åŠ è½½å‰æ–‡å­—ä¸å¯è§ï¼ˆFOITï¼‰ï¼›
- **æ–¹æ¡ˆ**ï¼šCSS ä¸­æ·»åŠ ï¼š
  ```css
  @font-face {
    font-family: 'MyFont';
    src: url('myfont.woff2') format('woff2');
    font-display: swap; /* å…ˆæ˜¾ç¤ºå¤‡ç”¨å­—ä½“ï¼Œå†æ›¿æ¢ */
  }
  ```

---

### 4. ç”¨æˆ·æ„ŸçŸ¥ä¼˜åŒ–

#### 4.1 å…¨å±€ Loading åŠ¨ç”»

- åœ¨ `App.vue` ä¸­ç»Ÿä¸€ç®¡ç† loading çŠ¶æ€ï¼›
- è®¾è®¡æä¾›è½»é‡çº§åŠ¨ç”»ï¼ˆé¿å…å¤æ‚ SVG/CSS åŠ¨ç”»é˜»å¡ä¸»çº¿ç¨‹ï¼‰ã€‚

#### 4.2 éª¨æ¶å±ï¼ˆSkeletonï¼‰

- ä¸ºç™»å½•é¡µå®šåˆ¶é™æ€éª¨æ¶å± HTMLï¼ˆå†…è”åœ¨ `<body>` ä¸­ï¼‰ï¼›
- ç”¨æˆ·çœ‹åˆ°**ç»“æ„å ä½**ï¼Œæ„ŸçŸ¥â€œå†…å®¹å³å°†åŠ è½½â€ï¼Œé™ä½ç­‰å¾…ç„¦è™‘ã€‚

#### 4.3 æ¸è¿›å¼æ¸²æŸ“

- é¡µé¢ç»“æ„å…ˆæ¸²æŸ“ï¼ˆå«éª¨æ¶å±ï¼‰ï¼›
- æ¥å£æ•°æ®è¿”å›åå†å¡«å……å¯äº¤äº’å†…å®¹ï¼ˆå¦‚è¡¨å•ã€æŒ‰é’®ï¼‰ã€‚

---

## ä¸‰ã€æ„å»ºé…ç½®å…³é”®ä¿®æ”¹ï¼ˆWebpack 3ï¼‰

### 1. HTML å‹ç¼©

```js
new HtmlWebpackPlugin({
  template: 'index.html',
  minify: {
    removeComments: true,
    collapseWhitespace: true,
    removeRedundantAttributes: true
  }
})
```

### 2. Gzip é¢„å‹ç¼©ï¼ˆå¯é€‰ï¼‰

```js
const CompressionWebpackPlugin = require('compression-webpack-plugin')
plugins: [
  new CompressionWebpackPlugin({
    filename: '[path].gz[query]',
    algorithm: 'gzip',
    test: /\.(js|css|html|svg)$/,
    threshold: 8192,
    minRatio: 0.8
  })
]
```

> **æ³¨æ„**ï¼šNginx éœ€é…ç½® `gzip_static on;` ä¼˜å…ˆè¿”å› `.gz` æ–‡ä»¶ã€‚

---

## å››ã€ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡                | ä¼˜åŒ–å‰  | ä¼˜åŒ–å  | æå‡       |
| ------------------- | ------- | ------- | ---------- |
| **FCPï¼ˆå¹³å‡ï¼‰**     | 1593 ms | 1281 ms | **+19.6%** |
| **FCPï¼ˆ95 åˆ†ä½ï¼‰**  | 3258 ms | 2344 ms | **+28.1%** |
| **LCPï¼ˆå¹³å‡ï¼‰**     | 1801 ms | 1454 ms | **+19.3%** |
| **LCPï¼ˆ95 åˆ†ä½ï¼‰**  | 3797 ms | 2700 ms | **+28.9%** |
| **Loadï¼ˆå¹³å‡ï¼‰**    | 1431 ms | 906 ms  | **+36.7%** |
| **Lighthouse è¯„åˆ†** | 30+     | 70+     | **+133%**  |

> **ç»“è®º**ï¼šé€šè¿‡**ä½é£é™©ã€å°æ”¹åŠ¨**çš„ç»„åˆä¼˜åŒ–ï¼Œ**é¦–å±æ€§èƒ½æå‡ 20%+**ï¼Œç”¨æˆ·ç™½å±æ—¶é—´æ˜¾è‘—ç¼©çŸ­ã€‚

---

## äº”ã€åç»­å»ºè®®

1. **ç›‘æ§**ï¼šæ¥å…¥å‰ç«¯æ€§èƒ½ç›‘æ§ï¼ˆå¦‚ Web Vitalsï¼‰ï¼ŒæŒç»­è·Ÿè¸ª FCP/LCPï¼›
2. **é‡æ„æœŸ**ï¼šè¿ç§»è‡³ Vue 3 + Viteï¼Œå½»åº•è§£å†³æ„å»ºä¸è¿è¡Œæ—¶æ€§èƒ½ç“¶é¢ˆï¼›
3. **ç¼“å­˜ç­–ç•¥**ï¼šç²¾ç»†åŒ–æ§åˆ¶ Service Worker ç¼“å­˜ï¼Œå®ç°ç¦»çº¿å¯ç”¨ã€‚

---

> **æ³¨**ï¼šæœ¬æ–‡æ‰€æœ‰ä¼˜åŒ–æ–¹æ¡ˆå‡å·²åœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œ**æ— ä¸šåŠ¡åŠŸèƒ½æ”¹åŠ¨ï¼Œä»…é…ç½®ä¸èµ„æºç­–ç•¥è°ƒæ•´**ï¼Œç¬¦åˆâ€œå°æ”¹åŠ¨ã€å¿«ä¸Šçº¿â€è¦æ±‚ã€‚
