## node_modules é—®é¢˜

è¿‡å»çš„å®‰è£…æ–¹å¼å¾ˆç®€å•ï¼šè¿è¡Œ`yarn install`Yarn æ—¶ä¼šç”Ÿæˆä¸€ä¸ª`node_modules`ç›®å½•ï¼Œç„¶å Node å¯ä»¥ä½¿ç”¨å…¶å†…ç½®çš„[Node Resolution Algorithm](https://nodejs.org/api/modules.html#modules_all_together)æ¥ä½¿ç”¨è¯¥ç›®å½•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒNode ä¸å¿…é¦–å…ˆçŸ¥é“â€œåŒ…â€æ˜¯ä»€ä¹ˆï¼šå®ƒåªæ ¹æ®æ–‡ä»¶è¿›è¡Œæ¨ç†ã€‚â€œè¿™ä¸ªæ–‡ä»¶åœ¨è¿™é‡Œå­˜åœ¨å—ï¼Ÿä¸ï¼šå¥½çš„ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹çˆ¶æ–‡ä»¶`node_modules`ã€‚å®ƒåœ¨è¿™é‡Œå­˜åœ¨å—ï¼Ÿä»ç„¶ä¸å­˜åœ¨ï¼šå¥½çš„â€¦â€¦â€ï¼Œå®ƒç»§ç»­è¿è¡Œï¼Œç›´åˆ°æ‰¾åˆ°æ­£ç¡®çš„æ–‡ä»¶ã€‚ç”±äºä»¥ä¸‹å‡ ä¸ªåŸå› ï¼Œè¿™ä¸ªè¿‡ç¨‹éå¸¸ä½æ•ˆï¼š

- è¿™äº›`node_modules`ç›®å½•é€šå¸¸åŒ…å«å¤§é‡æ–‡ä»¶ã€‚ç”Ÿæˆå®ƒä»¬å¯ä»¥å¼¥è¡¥è¿è¡Œæ‰€éœ€æ—¶é—´çš„ 70% ä»¥ä¸Š`yarn install`ã€‚å³ä½¿æœ‰é¢„å…ˆå­˜åœ¨çš„å®‰è£…ä¹Ÿä¸ä¼šæ‹¯æ•‘ä½ ï¼Œå› ä¸ºåŒ…ç®¡ç†å™¨ä»ç„¶å¿…é¡»åŒºåˆ†`node_modules`å®ƒ*åº”è¯¥*åŒ…å«çš„å†…å®¹ã€‚
- å› ä¸º`node_modules`ç”Ÿæˆæ˜¯ä¸€ä¸ª I/O ç¹é‡çš„æ“ä½œï¼ŒåŒ…ç®¡ç†å™¨é™¤äº†åšä¸€ä¸ªç®€å•çš„æ–‡ä»¶å¤åˆ¶ä¹‹å¤–æ²¡æœ‰å¤ªå¤šçš„ä½™åœ°æ¥ä¼˜åŒ–å®ƒâ€”â€”å³ä½¿å®ƒå¯ä»¥åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨ç¡¬é“¾æ¥æˆ–å†™æ—¶å¤åˆ¶ï¼Œå®ƒä¹Ÿä¼šåœ¨è¿›è¡Œä¸€å †ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œç£ç›˜ä¹‹å‰ï¼Œä»ç„¶éœ€è¦åŒºåˆ†æ–‡ä»¶ç³»ç»Ÿçš„å½“å‰çŠ¶æ€ã€‚
- å› ä¸º Node æ²¡æœ‰åŒ…çš„æ¦‚å¿µï¼Œå®ƒä¹Ÿä¸çŸ¥é“æ–‡ä»¶æ˜¯å¦*åº”è¯¥*è¢«è®¿é—®ã€‚å®Œå…¨æœ‰å¯èƒ½æ‚¨ç¼–å†™çš„ä»£ç æœ‰ä¸€å¤©åœ¨å¼€å‘ä¸­æœ‰æ•ˆï¼Œä½†åæ¥åœ¨ç”Ÿäº§ä¸­ä¸­æ–­ï¼Œå› ä¸ºæ‚¨å¿˜è®°åœ¨`package.json`.
- å³ä½¿åœ¨è¿è¡Œæ—¶ï¼ŒNode è§£æä¹Ÿå¿…é¡»è¿›è¡Œå¤§é‡è°ƒç”¨`stat`ï¼Œ`readdir`ä»¥ç¡®å®šä»ä½•å¤„åŠ è½½æ¯ä¸ªæ‰€éœ€æ–‡ä»¶ã€‚è¿™æ˜¯éå¸¸æµªè´¹çš„ï¼Œä¹Ÿæ˜¯å¯åŠ¨ Node åº”ç”¨ç¨‹åºèŠ±è´¹å¦‚æ­¤å¤šæ—¶é—´çš„éƒ¨åˆ†åŸå› ã€‚
- æœ€åï¼Œ`node_modules`æ–‡ä»¶å¤¹çš„è®¾è®¡æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œå› ä¸ºå®ƒä¸å…è®¸åŒ…ç®¡ç†å™¨æ­£ç¡®åœ°å¯¹åŒ…è¿›è¡Œé‡å¤æ•°æ®åˆ é™¤ã€‚å°½ç®¡å¯ä»¥ä½¿ç”¨ä¸€äº›ç®—æ³•æ¥ä¼˜åŒ–æ ‘å¸ƒå±€ï¼ˆ[æå‡](https://yarnpkg.com/advanced/lexicon#hoisting)ï¼‰ï¼Œä½†æˆ‘ä»¬ä»ç„¶æ— æ³•ä¼˜åŒ–æŸäº›ç‰¹å®šæ¨¡å¼â€”â€”ä¸ä»…å¯¼è‡´ç£ç›˜ä½¿ç”¨ç‡é«˜äºæ‰€éœ€ï¼Œè€Œä¸”ä¸€äº›åŒ…åœ¨å†…å­˜ä¸­è¢«å¤šæ¬¡å®ä¾‹åŒ–.

## ä¿®å¤ node_modules

Yarn å·²ç»çŸ¥é“å…³äºä½ çš„ä¾èµ–æ ‘çš„æ‰€æœ‰ä¿¡æ¯â€”â€”å®ƒç”šè‡³ä¼šä¸ºä½ å°†å®ƒå®‰è£…åœ¨ç£ç›˜ä¸Šã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦ç”± Node æ¥æŸ¥æ‰¾ä½ çš„åŒ…åœ¨å“ªé‡Œå‘¢ï¼Ÿç›¸åï¼ŒåŒ…ç®¡ç†å™¨çš„å·¥ä½œåº”è¯¥æ˜¯é€šçŸ¥è§£é‡Šå™¨åŒ…åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ï¼Œå¹¶ç®¡ç†åŒ…ä¹‹é—´çš„ä»»ä½•ä¾èµ–å…³ç³»ï¼Œç”šè‡³åŒ…çš„ç‰ˆæœ¬ã€‚è¿™å°±æ˜¯åˆ›å»ºå³æ’å³ç”¨çš„åŸå› ã€‚

åœ¨è¿™ç§å®‰è£…æ¨¡å¼ä¸‹ï¼ˆé»˜è®¤ä» Yarn 2.0 å¼€å§‹ï¼‰ï¼ŒYarn ç”Ÿæˆå•ä¸ªæ–‡ä»¶è€Œä¸æ˜¯åŒ…å«å„ç§åŒ…å‰¯æœ¬`.pnp.cjs`çš„é€šå¸¸æ–‡ä»¶å¤¹ã€‚`node_modules`è¯¥`.pnp.cjs`æ–‡ä»¶åŒ…å«å„ç§æ˜ å°„ï¼šä¸€ä¸ªå°†åŒ…åç§°å’Œç‰ˆæœ¬é“¾æ¥åˆ°å®ƒä»¬åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ï¼Œå¦ä¸€ä¸ªå°†åŒ…åç§°å’Œç‰ˆæœ¬é“¾æ¥åˆ°å®ƒä»¬çš„ä¾èµ–é¡¹åˆ—è¡¨ã€‚æœ‰äº†è¿™äº›æŸ¥æ‰¾è¡¨ï¼ŒYarn å¯ä»¥ç«‹å³å‘Šè¯‰ Node åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å®ƒéœ€è¦è®¿é—®çš„ä»»ä½•åŒ…ï¼Œåªè¦å®ƒä»¬æ˜¯ä¾èµ–å…³ç³»æ ‘çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”åªè¦è¿™ä¸ªæ–‡ä»¶è¢«åŠ è½½åˆ°æ‚¨çš„ç¯å¢ƒä¸­ï¼ˆä¸‹ä¸€èŠ‚å°†è¯¦ç»†ä»‹ç»ï¼‰ ï¼‰ã€‚

è¿™ç§æ–¹æ³•æœ‰å¤šç§å¥½å¤„ï¼š

- å®‰è£…ç°åœ¨å‡ ä¹æ˜¯å³æ—¶çš„ã€‚Yarn åªéœ€è¦ç”Ÿæˆä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼ˆè€Œä¸æ˜¯å¯èƒ½çš„æ•°ä¸‡ä¸ªï¼‰ã€‚ä¸»è¦ç“¶é¢ˆæ˜¯é¡¹ç›®ä¸­ä¾èµ–é¡¹çš„æ•°é‡è€Œä¸æ˜¯ç£ç›˜æ€§èƒ½ã€‚
- ç”±äºå‡å°‘äº† I/O æ“ä½œï¼Œå®‰è£…æ›´åŠ ç¨³å®šå’Œå¯é ã€‚å°¤å…¶æ˜¯åœ¨ Windows ä¸Šï¼ˆæ‰¹é‡å†™å…¥å’Œåˆ é™¤æ–‡ä»¶å¯èƒ½ä¼šè§¦å‘ä¸ Windows Defender å’Œç±»ä¼¼å·¥å…·çš„å„ç§æ„å¤–äº¤äº’ï¼‰ï¼ŒI/O ç¹é‡çš„`node_modules`æ“ä½œæ›´å®¹æ˜“å¤±è´¥ã€‚
- å®Œç¾ä¼˜åŒ–ä¾èµ–æ ‘ï¼ˆåˆåå®Œç¾æå‡ï¼‰å’Œå¯é¢„æµ‹çš„åŒ…å®ä¾‹åŒ–ã€‚
- ç”Ÿæˆçš„`.pnp.cjs`æ–‡ä»¶å¯ä»¥ä½œä¸º[é›¶å®‰è£…](https://yarnpkg.com/features/zero-installs)å·¥ä½œçš„ä¸€éƒ¨åˆ†æäº¤åˆ°æ‚¨çš„å­˜å‚¨åº“ï¼Œä»è€Œæ— éœ€é¦–å…ˆè¿è¡Œ`yarn install`ã€‚
- æ›´å¿«çš„åº”ç”¨ç¨‹åºå¯åŠ¨ï¼èŠ‚ç‚¹è§£æä¸å¿…åƒä»¥å‰é‚£æ ·è¿­ä»£æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„ï¼ˆå¾ˆå¿«å°±ä¸å¿…è¿™æ ·åšäº†ï¼ï¼‰ã€‚

## åˆå§‹åŒ–å³æ’å³ç”¨

Yarn ä¼šç”Ÿæˆä¸€ä¸ª`.pnp.cjs`éœ€è¦å®‰è£…çš„æ–‡ä»¶ï¼Œä»¥ä¾¿ Node çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°ç›¸å…³çš„åŒ…ã€‚è¿™ç§æ³¨å†Œé€šå¸¸æ˜¯é€æ˜çš„ï¼š`node`é€šè¿‡æ‚¨çš„æ¡ç›®ä¹‹ä¸€æ‰§è¡Œçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥å‘½ä»¤`scripts`éƒ½ä¼šè‡ªåŠ¨å°†è¯¥`.pnp.cjs`æ–‡ä»¶æ³¨å†Œä¸ºè¿è¡Œæ—¶ä¾èµ–é¡¹ã€‚å¯¹äºç»å¤§å¤šæ•°ç”¨ä¾‹ï¼Œä»¥ä¸‹å†…å®¹å°†æŒ‰ç…§æ‚¨çš„é¢„æœŸå·¥ä½œï¼š

```json
{
  "scripts": {
    "start": "node ./server.js",
    "test": "jest"
  }
}
```

å¯¹äºä¸€äº›å‰©ä½™çš„è¾¹ç¼˜æƒ…å†µï¼Œå¯èƒ½éœ€è¦ä¸€ä¸ªå°çš„è®¾ç½®ï¼š

- å¦‚æœæ‚¨éœ€è¦è¿è¡Œä»»æ„ Node è„šæœ¬ï¼Œè¯·ä½¿ç”¨[`yarn node`](https://yarnpkg.com/cli/node)è§£é‡Šå™¨ï¼Œè€Œä¸æ˜¯`node`. è¿™è¶³ä»¥å°†`.pnp.cjs`æ–‡ä»¶æ³¨å†Œä¸ºè¿è¡Œæ—¶ä¾èµ–é¡¹ã€‚

```text
yarn node ./server.js
```

- å¦‚æœæ‚¨åœ¨è‡ªåŠ¨æ‰§è¡Œ Node è„šæœ¬çš„ç³»ç»Ÿä¸Šæ“ä½œï¼ˆä¾‹å¦‚åœ¨ Google Cloud Platform ä¸Šï¼ˆ--æ­¤å¤„éœ€è¦å‚è€ƒ--ï¼‰ï¼‰ï¼Œåªéœ€åœ¨ init è„šæœ¬é¡¶éƒ¨éœ€è¦ PnP æ–‡ä»¶å¹¶è°ƒç”¨å…¶`setup`å‡½æ•°å³å¯ã€‚

```text
require('./.pnp.cjs').setup();
```

ä½œä¸ºä¸€ä¸ªå¿«é€Ÿæç¤ºï¼Œ`yarn node`é€šå¸¸æ‰€åšçš„åªæ˜¯å°†`NODE_OPTIONS`ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºä½¿ç”¨[`--require`](https://nodejs.org/api/cli.html#cli_r_require_module)æ¥è‡ª Node çš„é€‰é¡¹ï¼Œä¸`.pnp.cjs`æ–‡ä»¶çš„è·¯å¾„ç›¸å…³è”ã€‚å¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨å¯ä»¥è‡ªå·±è½»æ¾åœ°åº”ç”¨æ­¤æ“ä½œï¼š

```text
node -r ./.pnp.cjs ./server.js
NODE_OPTIONS="--require $(pwd)/.pnp.cjs" node ./server.js
```

## å³æ’å³ç”¨`loose`æ¨¡å¼

ç”±äºæå‡å¯å‘å¼ä¸æ˜¯æ ‡å‡†åŒ–å’Œå¯é¢„æµ‹çš„ï¼Œå› æ­¤åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹è¿è¡Œçš„ PnP å°†é˜»æ­¢åŒ…éœ€è¦æœªæ˜ç¡®åˆ—å‡ºçš„ä¾èµ–é¡¹ï¼›å³ä½¿å…¶ä»–ä¾èµ–é¡¹ä¹Ÿä¾èµ–å®ƒã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æŸäº›è½¯ä»¶åŒ…å‡ºç°é—®é¢˜ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒYarn æä¾›äº†ä¸€ç§â€œæ¾æ•£â€æ¨¡å¼ï¼Œè¿™å°†å¯¼è‡´ PnP é“¾æ¥å™¨ä¸æå‡å™¨ååŒå·¥ä½œ`node-modules`- æˆ‘ä»¬å°†é¦–å…ˆç”Ÿæˆåœ¨å…¸å‹å®‰è£…ä¸­å°†è¢«æå‡åˆ°é¡¶å±‚çš„è½¯ä»¶åŒ…åˆ—è¡¨`node_modules`ï¼Œç„¶åè®°ä½è¿™ä¸ªåˆ—è¡¨ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œåå¤‡æ± â€ã€‚

> è¯·æ³¨æ„ï¼Œå› ä¸ºæ¾æ•£æ¨¡å¼ç›´æ¥è°ƒç”¨æå‡å™¨ï¼Œå®ƒéµå¾ªä¸[é“¾æ¥å™¨](https://github.com/yarnpkg/berry/tree/master/packages/plugin-nm)`node-modules`ä½¿ç”¨çš„çœŸæ­£ç®—æ³•å®Œå…¨ç›¸åŒçš„å®ç°ï¼[`node-modules`](https://github.com/yarnpkg/berry/tree/master/packages/plugin-nm)

åœ¨è¿è¡Œæ—¶ï¼Œå¦‚æœä¾èµ–é¡¹çš„ä»»ä½•ç‰ˆæœ¬æœ€ç»ˆåœ¨å›é€€æ± ä¸­ï¼Œä»ç„¶å…è®¸éœ€è¦æœªåˆ—å‡ºçš„ä¾èµ–é¡¹çš„åŒ…è®¿é—®å®ƒä»¬ï¼ˆå¯ä»¥ä½¿ç”¨[pnpFallbackMode](https://yarnpkg.com/configuration/yarnrc#pnpFallbackMode)è°ƒæ•´å“ªäº›åŒ…å®Œå…¨è¢«å…è®¸ä¾èµ–å›é€€æ± ï¼‰ã€‚

è¯·æ³¨æ„ï¼Œå¤‡ç”¨æ± çš„å†…å®¹æ˜¯ä¸ç¡®å®šçš„ã€‚å¦‚æœä¾èµ–å…³ç³»æ ‘åŒ…å«åŒä¸€ä¸ªåŒ…çš„å¤šä¸ªç‰ˆæœ¬ï¼Œåˆ™æ— æ³•ç¡®å®šå°†å“ªä¸ªç‰ˆæœ¬æå‡åˆ°é¡¶å±‚ã€‚å› æ­¤ï¼Œè®¿é—®å›é€€æ± çš„åŒ…ä»ç„¶ä¼šç”Ÿæˆè­¦å‘Šï¼ˆé€šè¿‡[process.emitWarning](https://nodejs.org/api/process.html#process_process_emitwarning_warning_type_code_ctor) APIï¼‰ã€‚

æ­¤æ¨¡å¼æä¾›äº†`strict`PnP é“¾æ¥å™¨å’Œ`node_modules`é“¾æ¥å™¨ä¹‹é—´çš„æŠ˜è¡·æ–¹æ¡ˆã€‚

ä¸ºäº†å¯ç”¨`loose`æ¨¡å¼ï¼Œè¯·ç¡®ä¿è¯¥[`nodeLinker`](https://yarnpkg.com/configuration/yarnrc#nodeLinker)é€‰é¡¹è®¾ç½®ä¸º`pnp`ï¼ˆé»˜è®¤ï¼‰å¹¶å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°æ‚¨çš„æœ¬åœ°[`.yarnrc.yml`](https://yarnpkg.com/configuration/yarnrc)æ–‡ä»¶ä¸­ï¼š

```yaml
pnpMode: loose
```

[æœ‰å…³è¯¥`pnpMode`é€‰é¡¹çš„æ›´å¤šä¿¡æ¯ã€‚](https://yarnpkg.com/configuration/yarnrc#pnpMode)

### è­¦å‘Š

å› ä¸ºæˆ‘ä»¬åœ¨è§£å†³é”™è¯¯æ—¶*å‘å‡º*è­¦å‘Šï¼ˆè€Œä¸æ˜¯*æŠ›å‡º*é”™è¯¯ï¼‰ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºæ— æ³•*æ•è·*å®ƒä»¬ã€‚è¿™æ„å‘³ç€`require`å¦‚æœç¼ºå°‘ä¾èµ–é¡¹ï¼Œå°è¯•åœ¨ try/catch å—å†…å°è¯•å¯é€‰å¯¹ç­‰ä¾èµ–é¡¹çš„å¸¸è§æ¨¡å¼å°†åœ¨è¿è¡Œæ—¶æ‰“å°è­¦å‘Šï¼Œå³ä½¿å®ƒä¸åº”è¯¥ã€‚å”¯ä¸€çš„è¿è¡Œæ—¶å«ä¹‰æ˜¯è¿™æ ·çš„è­¦å‘Šå¯èƒ½ä¼šå¯¼è‡´æ··æ·†ï¼Œä½†å¯ä»¥æ”¾å¿ƒåœ°å¿½ç•¥å®ƒã€‚

å› æ­¤ï¼Œä» 2.1 ç‰ˆå¼€å§‹ï¼Œå³æ’å³ç”¨`loose`æ¨¡å¼**å°†ä¸å†æ˜¯**é»˜è®¤æ¨¡å¼ï¼ˆæ­£å¦‚æˆ‘ä»¬æœ€åˆè®¡åˆ’çš„é‚£æ ·ï¼‰ã€‚å®ƒå°†ç»§ç»­ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆå¾—åˆ°æ”¯æŒï¼Œå¸Œæœ›èƒ½å¤Ÿè½»æ¾è¿‡æ¸¡åˆ°é»˜è®¤å’Œæ¨èçš„å·¥ä½œæµç¨‹ï¼šå³æ’å³ç”¨`strict`æ¨¡å¼ã€‚

## å¤‡æ‹©æ–¹æ¡ˆ

åœ¨ Plug'n'Play è¢«æ‰¹å‡†ä¸ºä¸»è¦å®‰è£…ç­–ç•¥ä¹‹å‰çš„å‡ å¹´é‡Œï¼Œå…¶ä»–é¡¹ç›®æå‡ºäº†èŠ‚ç‚¹è§£æç®—æ³•çš„æ›¿ä»£å®ç°â€”â€”é€šå¸¸æ˜¯ä¸ºäº†è§„é¿`require.resolve`API çš„ç¼ºç‚¹ã€‚ç¤ºä¾‹åŒ…æ‹¬ Webpack ( `enhanced-resolve`)ã€Babel ( `resolve`)ã€Jest ( `jest-resolve`) å’Œ Metro ( `metro-resolver`)ã€‚è¿™äº›æ›¿ä»£æ–¹æ¡ˆåº”è¢«è§†ä¸ºä¸ Plug'n'Play çš„é€‚å½“é›†æˆæ‰€å–ä»£ã€‚

### å…¼å®¹æ€§è¡¨

ä¸‹é¢çš„å…¼å®¹æ€§è¡¨è®©æ‚¨äº†è§£ä¸ç¤¾åŒºä¸­å„ç§å·¥å…·çš„é›†æˆçŠ¶æ€ã€‚è¯·æ³¨æ„ï¼Œæ­¤å¤„ä»…åˆ—å‡ºäº† CLI å·¥å…·ï¼Œå› ä¸ºå‰ç«¯åº“ï¼ˆä¾‹å¦‚`react`, `vue`, `lodash`, ...ï¼‰ä¸ä¼šé‡æ–°å®ç°èŠ‚ç‚¹è§£æï¼Œå› æ­¤ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šé€»è¾‘æ¥åˆ©ç”¨ Plug'n'Playï¼š

**[å»ºè®®åœ¨æ­¤è¡¨ä¸­æ·»åŠ ](https://github.com/yarnpkg/berry/edit/master/packages/gatsby/content/features/plugnplay.md)**

#### åŸç”Ÿæ”¯æŒ

è®¸å¤šå¸¸è§çš„å‰ç«¯å·¥å…·ç°åœ¨åŸç”Ÿæ”¯æŒå³æ’å³ç”¨ï¼

| é¡¹ç›®å            | ç¬”è®°                                                                                                                  |
| :---------------- | :-------------------------------------------------------------------------------------------------------------------- |
| è§’                | ä» 13+ å¼€å§‹                                                                                                           |
| é€šå¤©å¡”            | ä»`resolve`1.9 å¼€å§‹                                                                                                   |
| åˆ›å»ºååº”åº”ç”¨ç¨‹åº  | ä» 2.0+ å¼€å§‹                                                                                                          |
| å‰‘é¾™              | ä» 2.0.0-beta.14 å¼€å§‹                                                                                                 |
| ESLint            | å…±äº«é…ç½®çš„ä¸€äº›å…¼å®¹æ€§é—®é¢˜ï¼ˆå¯ä½¿ç”¨[@rushstack/eslint-patch ä¿®å¤](https://yarnpkg.com/package/@rushstack/eslint-patch)ï¼‰ |
| ç›–èŒ¨æ¯”            | æ”¯æŒç‰ˆæœ¬ â‰¥2.15.0ã€â‰¥3.7.0                                                                                              |
| åå’½              | æ”¯æŒ 4.0+ ç‰ˆæœ¬                                                                                                        |
| æ²™å“‘              | ä» 4.0.0-1+ å¼€å§‹                                                                                                      |
| ç¬‘è¯              | ä» 24.1+ å¼€å§‹                                                                                                         |
| Next.js           | ä» 9.1.2+ å¼€å§‹                                                                                                        |
| åŒ…è£¹              | ä» 2.0.0-nightly.212+ å¼€å§‹                                                                                            |
| Preact CLI        | ä» 3.1.0+ å¼€å§‹                                                                                                        |
| æ›´æ¼‚äº®            | ä» 1.17+ å¼€å§‹                                                                                                         |
| å·èµ·              | ä»`resolve`1.9+å¼€å§‹                                                                                                   |
| æ•…äº‹ä¹¦            | ä» 6.0+ å¼€å§‹                                                                                                          |
| æ‰“å­—ç¨¿            | é€šè¿‡[`plugin-compat`](https://github.com/yarnpkg/berry/tree/master/packages/plugin-compat)ï¼ˆé»˜è®¤å¯ç”¨ï¼‰                |
| TypeScript-ESLint | ä» 2.12+ å¼€å§‹                                                                                                         |
| VSCode-Stylelint  | ä» 1.1+ å¼€å§‹                                                                                                          |
| ç½‘ç»œé£æš´          | ä» 2019.3+å¼€å§‹ï¼›è¯·å‚é˜…[ç¼–è¾‘å™¨ SDK](https://yarnpkg.com/getting-started/editor-sdks)                                   |
| ç½‘é¡µåŒ…            | ä» 5+ å¼€å§‹ï¼ˆ[æ’ä»¶](https://github.com/arcanis/pnp-webpack-plugin)å¯ç”¨äº 4.xï¼‰                                         |

#### é€šè¿‡æ’ä»¶æ”¯æŒ

| é¡¹ç›®å        | ç¬”è®°                                                                                                                                    |
| :------------ | :-------------------------------------------------------------------------------------------------------------------------------------- |
| ESBuild       | é€šè¿‡[`@yarnpkg/esbuild-plugin-pnp`](https://github.com/yarnpkg/berry/tree/master/packages/esbuild-plugin-pnp#yarnpkgesbuild-plugin-pnp) |
| VSCode-ESLint | å…³æ³¨[ç¼–è¾‘å™¨ SDK](https://yarnpkg.com/getting-started/editor-sdks)                                                                       |
| VSCode        | å…³æ³¨[ç¼–è¾‘å™¨ SDK](https://yarnpkg.com/getting-started/editor-sdks)                                                                       |
| Webpack 4.x   | Via [`pnp-webpack-plugin`](https://github.com/arcanis/pnp-webpack-plugin)ï¼ˆ5 å²ä»¥ä¸ŠåŸç”Ÿï¼‰                                               |

#### ä¸ç›¸å®¹

ä»¥ä¸‹å·¥å…·ä¸èƒ½ç”¨äºçº¯å³æ’å³ç”¨å®‰è£…ï¼ˆå³ä½¿åœ¨æ¾æ•£æ¨¡å¼ä¸‹ï¼‰ã€‚

**é‡è¦æç¤ºï¼š**å³ä½¿æŸä¸ªå·¥å…·ä¸ Plug'n'Play ä¸å…¼å®¹ï¼Œæ‚¨ä»ç„¶å¯ä»¥å¯ç”¨è¯¥[`node-modules`æ’ä»¶](https://github.com/yarnpkg/berry/tree/master/packages/plugin-nm)ã€‚åªéœ€æŒ‰ç…§[è¯´æ˜æ“ä½œ](https://yarnpkg.com/getting-started/migration#if-required-enable-the-node-modules-plugin)ï¼Œæ‚¨å°±å¯ä»¥åœ¨ä¸€åˆ†é’Ÿå†…å‡†å¤‡å¥½ ğŸ™‚

| é¡¹ç›®å                   | ç¬”è®°                                                                                                                                                                                                                                             |
| :----------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| æµåŠ¨                     | å…³æ³¨[yarnpkg/berry#634](https://github.com/yarnpkg/berry/issues/634)                                                                                                                                                                             |
| ååº”åŸç”Ÿ                 | å…³æ³¨[react-native-community/cli#27](https://github.com/react-native-community/cli/issues/27)                                                                                                                                                     |
| æ™®é²ç±³                   | å…³æ³¨[pulumi/pulumi#3586](https://github.com/pulumi/pulumi/issues/3586)                                                                                                                                                                           |
| VSCode æ‰©å±•ç®¡ç†å™¨ (vsce) | ä½¿ç”¨å¯ç”¨æ’ä»¶çš„[vsce-yarn-patch](https://www.npmjs.com/package/vsce-yarn-patch)åˆ†æ”¯`node-modules`ã€‚[åœ¨åˆå¹¶ microsoft/vscode-vsce#493](https://github.com/microsoft/vscode-vsce/pull/493)ä¹‹å‰éœ€è¦ fork ï¼Œå› ä¸º`vsce`å½“å‰ä½¿ç”¨å·²åˆ é™¤çš„`yarn list`å‘½ä»¤ |
| é›¨æœ                     | é›¨æœç®¡é“æœŸå¾…ä¸€ä¸ª`node-modules`ç›®å½•ã€‚å¯ç”¨`node-modules`æ’ä»¶                                                                                                                                                                                       |
| è¯ä¹¦                     | æŒ‰ç…§[rescript-lang/rescript-compiler#3276](https://github.com/rescript-lang/rescript-compiler/issues/3276)                                                                                                                                       |

æ­¤åˆ—è¡¨æ ¹æ®æˆ‘ä»¬ä» v2 å¼€å§‹å‘å¸ƒçš„æœ€æ–°ç‰ˆæœ¬ä¿æŒæ›´æ–°ã€‚å¦‚æœæ‚¨å‘ç°è‡ªå·±çš„é¡¹ç›®ä¸­æœ‰é—®é¢˜ï¼Œè¯·å…ˆå°è¯•å‡çº§ Yarn å’Œæœ‰é—®é¢˜çš„åŒ…ï¼Œç„¶åéšæ—¶æå‡ºé—®é¢˜ã€‚ä¹Ÿè®¸æ˜¯å…¬å…³ï¼ŸğŸ˜Š

## ç»å¸¸é—®çš„é—®é¢˜

### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¯¼å…¥åœ°å›¾ï¼Ÿ

Yarn Plug'n'Play æä¾›è¯­ä¹‰é”™è¯¯ï¼ˆè§£é‡Šä¸ºä»€ä¹ˆä¸€ä¸ªåŒ…ä¸èƒ½ä»å¦ä¸€ä¸ªåŒ…è®¿é—®çš„ç¡®åˆ‡åŸå› ï¼‰å’Œä¸€ä¸ª[åˆç†çš„ JS API](https://yarnpkg.com/advanced/pnpapi)æ¥è§£å†³`require.resolve`. è¿™äº›æ˜¯å¯¼å…¥åœ°å›¾æ— æ³•è‡ªè¡Œè§£å†³çš„åŠŸèƒ½ã€‚[è¿™åœ¨è¿™ä¸ªçº¿ç¨‹](https://github.com/nodejs/modules/issues/477#issuecomment-578091424)ä¸­æœ‰æ›´è¯¦ç»†çš„å›ç­”ã€‚

æˆ‘ä»¬ä»Šå¤©é™·å…¥è¿™ç§æ··ä¹±çš„ä¸€ä¸ªä¸»è¦åŸå› æ˜¯ï¼Œæœ€åˆçš„`node_modules`è®¾è®¡è¯•å›¾å°†åŒ…æŠ½è±¡å‡ºæ¥ï¼Œä»¥ä¾¿æä¾›ä¸€ä¸ªå¯ä»¥åœ¨æ²¡æœ‰ä»»ä½•åŒ…æ¦‚å¿µçš„æƒ…å†µä¸‹å·¥ä½œçš„é€šç”¨ç³»ç»Ÿã€‚è¿™æˆä¸ºä¸€ä¸ªæŒ‘æˆ˜ï¼Œä¿ƒä½¿è®¸å¤šå®æ–½è€…æå‡ºè‡ªå·±çš„è§£é‡Šã€‚å¯¼å…¥åœ°å›¾ä¹Ÿå­˜åœ¨åŒæ ·çš„ç¼ºé™·ã€‚

### åŒ…å­˜å‚¨åœ¨ Zip æ¡£æ¡ˆä¸­ï¼šæˆ‘å¦‚ä½•è®¿é—®ä»–ä»¬çš„æ–‡ä»¶ï¼Ÿ

ä½¿ç”¨ PnP æ—¶ï¼ŒåŒ…è¢«ç›´æ¥å­˜å‚¨åœ¨ Zip å­˜æ¡£ä¸­å¹¶ä»ç¼“å­˜ä¸­è®¿é—®ã€‚PnP è¿è¡Œæ—¶ ( `.pnp.cjs`) ä¼šè‡ªåŠ¨ä¿®è¡¥ Node çš„`fs`æ¨¡å—ï¼Œä»¥æ·»åŠ å¯¹è®¿é—® Zip å­˜æ¡£ä¸­æ–‡ä»¶çš„æ”¯æŒã€‚è¿™æ ·ï¼Œæ‚¨ä¸å¿…åšä»»ä½•ç‰¹åˆ«çš„äº‹æƒ…ï¼š

```js
const { readFileSync } = require(`fs`)

// Looks similar to `/path/to/.yarn/cache/lodash-npm-4.17.11-1c592398b2-8b49646c65.zip/node_modules/lodash/ceil.js`
const lodashCeilPath = require.resolve(`lodash/ceil`)

console.log(readFileSync(lodashCeilPath))
```

### åå¤‡æ¨¡å¼

å›åˆ° PnP ç¬¬ä¸€æ¬¡å®ç°çš„æ—¶å€™ï¼Œå…¼å®¹æ€§è¿˜æ²¡æœ‰ç°åœ¨é‚£ä¹ˆå¥½ã€‚ä¸ºäº†å¸®åŠ©è¿‡æ¸¡ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ç§å›é€€æœºåˆ¶ï¼šå¦‚æœä¸€ä¸ªåŒ…è¯•å›¾è®¿é—®ä¸€ä¸ªæœªåˆ—å‡ºçš„ä¾èµ–é¡¹ï¼Œ_å¦‚æœé¡¶çº§åŒ…å°†å…¶åˆ—ä¸ºä¸€ä¸ªä¾èµ–é¡¹_ï¼Œå®ƒä»ç„¶å¯ä»¥è§£å†³å®ƒã€‚æˆ‘ä»¬å…è®¸è¿™æ ·åšæ˜¯å› ä¸ºæ²¡æœ‰åˆ†è¾¨ç‡æ­§ä¹‰ï¼Œå› ä¸ºä»»ä½•é¡¹ç›®ä¸­éƒ½æœ‰ä¸€ä¸ªé¡¶çº§åŒ…ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä»¤äººå›°æƒ‘çš„è¡Œä¸ºï¼Œå…·ä½“å–å†³äºæ‚¨çš„é¡¹ç›®è®¾ç½®æ–¹å¼ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œå³æ’å³ç”¨æ€»æ˜¯æ­£ç¡®çš„ï¼Œå®ƒåœ¨ä¸åœ¨å·¥ä½œåŒºæ—¶å·¥ä½œçš„å”¯ä¸€åŸå› æ˜¯ç”±äºä¸€äº›é¢å¤–çš„æ¾æ‡ˆã€‚

æ­¤è¡Œä¸ºåªæ˜¯ä¸€ä¸ªè¡¥ä¸ï¼Œæœ€ç»ˆå°†è¢«åˆ é™¤ä»¥æ¶ˆé™¤ä»»ä½•æ··ä¹±ã€‚[`pnpFallbackMode`](https://yarnpkg.com/configuration/yarnrc#pnpFallbackMode)æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡è®¾ç½®æ¥ä¸ºæ­¤åšå‡†å¤‡`none`ï¼Œè¿™å°†å®Œå…¨ç¦ç”¨å›é€€æœºåˆ¶ã€‚install

## å‰è¨€

ä» npm åˆ° yarnï¼Œå†åˆ°ä¹‹åçš„ pnpmï¼Œ ni ç­‰å®‰è£…å·¥å…·

ä¸æ–­è¿›æ­¥ï¼Œ ä¸æ–­å‡çº§ï¼Œ å‡çº§äº†å“ªäº›ï¼Œåˆå­˜åœ¨å“ªäº›é—®é¢˜

### é—®é¢˜

- åµŒå¥—å®‰è£…

  - è·¯å¾„è¿‡é•¿
  - åŒä¸€ä¾èµ–ï¼Œ å¤šæ¬¡å®‰è£…

- æ‰å¹³å®‰è£…

  - ä»…ä¸€ä¸ªç‰ˆæœ¬æ ¹æ®åŒ…çš„å®‰è£…é¡ºåºè¢«æå‡ï¼Œä¸”å‡çº§ç‰ˆæœ¬åï¼Œä¼šå­˜åœ¨æ–°çš„é—®é¢˜ï¼ˆä¾èµ–æå‡çš„ä¸ç¡®å®šæ€§ï¼‰

- npm åˆ†èº«

  - hoist æœºåˆ¶

- å¹½çµä¾èµ–

  - é¡¹ç›®æœªå®‰è£…æŸä¸ªä¾èµ–ï¼Œä½†å› ä¸ºå®‰è£…çš„æŸä¸ªä¾èµ–ä¸­ä½¿ç”¨äº†è¯¥ä¾èµ–ï¼Œ å¯¼è‡´å¯ä»¥é¡¹ç›®ä¸­ä½¿ç”¨æœªå®‰è£…çš„ä¾èµ–ï¼Œ ä½†åœ¨é¡¹ç›®å‡çº§åï¼Œ è‹¥å»æ‰è¯¥ä¾èµ–ï¼Œ å°±ä¼šæŠ¥é”™

  ## ç»“æ„

```
node_modules
â””â”€ foo
   â”œâ”€ index.js
   â”œâ”€ package.json
   â””â”€ node_modules
      â””â”€ bar
         â”œâ”€ index.js
         â””â”€ package.json

```

## npm

```sh
npm i
```

## yarn

```sh
yarn
```

## pnpm

```sh
pnpm i
```

## ni

```sh
ni
```

![Graph of the alotta-files results](https://github.com/pnpm/benchmarks-of-javascript-package-managers/raw/main/results/imgs/alotta-files.svg)

![img](https://camo.githubusercontent.com/83b108abddef5c40f6afc985fa8214edc92b6f2226a83d577074a720907463c8/68747470733a2f2f706e706d2e696f2f696d672f62656e63686d61726b732f616c6f7474612d66696c65732e737667)
